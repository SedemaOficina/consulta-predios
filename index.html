<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- LIBRER√çAS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
    </header>

    <div class="main-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta de Predios</h3>
                <p>Verifica la zonificaci√≥n antes de comprar.</p>
            </div>

            <div class="sidebar-body">
                <!-- GPS -->
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">üìç USAR MI UBICACI√ìN</button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O</span></div>

                <!-- BUSCADOR -->
                <div class="control-group">
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle... o Coordenadas (Maps)">
                        <button id="btn-buscar">üîé</button>
                    </div>
                </div>

                <!-- RESULTADOS (Resumido) -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <h4 id="res-titulo">RESULTADO</h4>
                    
                    <!-- Aqu√≠ va el nombre claro de la zona -->
                    <p id="res-zona" class="zona-nombre"></p>
                    
                    <!-- Bot√≥n para ver la tabla completa -->
                    <button id="btn-ver-tabla" class="btn-tabla">üìã VER TABLA DE DERECHOS Y PROHIBICIONES</button>
                    
                    <p class="nota-pie">Haz clic en el bot√≥n para ver el listado completo de actividades permitidas.</p>
                </div>

                <div class="leyenda-box">
                    <h4>Simbolog√≠a</h4>
                    <div class="item"><span class="dot rojo"></span> Suelo de Conservaci√≥n (Restringido)</div>
                    <div class="item"><span class="dot azul"></span> Zonificaci√≥n PGOEDF</div>
                    <div class="item"><span class="dot verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <!-- MODAL (TABLA COMPLETA) -->
    <div id="modal-detalle" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-titulo">Detalle de Zonificaci√≥n</h3>
                <button onclick="cerrarModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="info-clave">
                    <strong>Zonificaci√≥n Oficial:</strong> <span id="modal-clave"></span>
                </div>
                
                <div class="columnas-info">
                    <div class="col-prohibido">
                        <h4>üö´ PROHIBIDO (Delito Ambiental)</h4>
                        <ul id="lista-prohibido-full"></ul>
                    </div>
                    <div class="col-permitido">
                        <h4>‚úÖ PERMITIDO (Con autorizaci√≥n)</h4>
                        <ul id="lista-permitido-full"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                Fuente: Programa General de Ordenamiento Ecol√≥gico del D.F.
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // 1. CARGAR CSV
        let tablaUsos = [];
        Papa.parse("usos_suelo.csv", {
            download: true, header: true, encoding: "UTF-8", // Importante para acentos
            complete: function(results) { tablaUsos = results.data; }
        });

        // CAT√ÅLOGOS (Nombres amigables)
        const catalogoZonas = {
            "FC": "Forestal de Conservaci√≥n",
            "FCE": "Forestal de Conservaci√≥n Especial",
            "FP": "Forestal de Protecci√≥n",
            "FPE": "Forestal de Protecci√≥n Especial",
            "AF": "Agroforestal",
            "AFE": "Agroforestal Especial",
            "AE": "Agroecol√≥gica",
            "AEE": "Agroecol√≥gica Especial",
            "ANP": "√Årea Natural Protegida",
            "PDU": "Poblado Rural (Zona de Asentamiento)"
        };

        const mapeoSHP = {
            "FORESTAL DE CONSERVACION": "FC", "FORESTAL DE CONSERVACI√ìN": "FC",
            "FORESTAL DE CONSERVACION ESPECIAL": "FCE", "FORESTAL DE CONSERVACI√ìN ESPECIAL": "FCE",
            "FORESTAL DE PROTECCION": "FP", "FORESTAL DE PROTECCI√ìN": "FP",
            "FORESTAL DE PROTECCION ESPECIAL": "FPE", "FORESTAL DE PROTECCI√ìN ESPECIAL": "FPE",
            "AGROFORESTAL": "AF", "AGROFORESTAL ESPECIAL": "AFE",
            "AGROECOLOGICO": "AE", "AGROECOL√ìGICO": "AE",
            "AGROECOLOGICO ESPECIAL": "AEE", "AGROECOL√ìGICO ESPECIAL": "AEE"
        };

        function obtenerListasCSV(codigoZona) {
            let permitidos = [];
            let prohibidos = [];
            tablaUsos.forEach(fila => {
                if (fila[codigoZona]) {
                    // Formato: "Forestal: Reforestaci√≥n"
                    let texto = `<strong>${fila.SECTOR}:</strong> ${fila.ACTIVIDAD_ESPECIFICA || fila.ACTIVIDAD}`;
                    let estado = fila[codigoZona].trim().toUpperCase();
                    if (estado === 'A') permitidos.push(texto);
                    else if (estado === 'P') prohibidos.push(texto);
                }
            });
            return { perm: permitidos, proh: prohibidos };
        }

        // 2. MAPA
        var map = L.map('map', { zoomControl: false }).setView([19.28, -99.13], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 }).addTo(map);
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.8, attribution: 'CARTO', maxZoom: 19 }).addTo(map);
        
        var layerControl = L.control.layers({ "Sat√©lite": satelite, "Calles": calles }, {}, { position: 'topright' }).addTo(map);

        // Capas
        var geojsonSuelo, geojsonZoni;

        // Cargar Datos
        fetch('suelo-de-conservacion-2020.geojson').then(r => r.json()).then(data => {
            geojsonSuelo = L.geoJSON(data, {
                style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.2, weight: 0 },
                interactive: false
            }).addTo(map);
            layerControl.addOverlay(geojsonSuelo, "üî¥ Suelo de Conservaci√≥n");
        });

        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r => r.json()).then(data => {
            geojsonZoni = L.geoJSON(data, {
                style: { color: '#3498db', weight: 1, fillOpacity: 0.05 },
                onEachFeature: function(feature, layer) {
                    layer.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        analizarPunto(e.latlng);
                    });
                }
            }).addTo(map);
            layerControl.addOverlay(geojsonZoni, "üîµ Zonificaci√≥n PGOEDF");
        });

        fetch('anp.geojson').then(r => r.json()).then(d => {
            var l = L.geoJSON(d, {style:{color:'#27ae60', fillOpacity:0.3, weight:1}}).addTo(map);
            layerControl.addOverlay(l, "üü¢ ANP");
        }).catch(e=>{});

        // 3. AN√ÅLISIS (SIN POPUP EN MAPA)
        var pinActual;
        var datosActuales = {}; // Para guardar la info y mostrarla en el modal

        function analizarPunto(latlng) {
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map); // Solo pone el pin

            if (!geojsonSuelo || !geojsonZoni) { alert("Cargando datos..."); return; }

            var hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);
            var panel = document.getElementById('panel-resultados');
            var titulo = document.getElementById('res-titulo');
            var zona = document.getElementById('res-zona');
            var btnTabla = document.getElementById('btn-ver-tabla');

            panel.style.display = "block";

            if (hitsSuelo.length > 0) {
                // --- ZONA RESTRINGIDA ---
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var nombreZona = "Suelo de Conservaci√≥n";
                var codigoZona = "SC";
                
                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    var nombreRaw = (p.PGOEDF || p.DESCRIPCIO || p.ZONA || "").toUpperCase().trim();
                    var claveRaw = (p.CLAVE || "").toUpperCase().trim();

                    if (mapeoSHP[nombreRaw]) codigoZona = mapeoSHP[nombreRaw];
                    else if (catalogoZonas[claveRaw]) codigoZona = claveRaw;
                    else if (nombreRaw.includes("PROGRAMA") || nombreRaw.includes("POBLADO")) codigoZona = "PDU";

                    nombreZona = catalogoZonas[codigoZona] || nombreRaw;
                }

                // Guardar datos para el modal
                var listas = obtenerListasCSV(codigoZona);
                datosActuales = {
                    titulo: nombreZona,
                    clave: codigoZona,
                    perm: listas.perm,
                    proh: listas.proh
                };

                // Mostrar en Panel Lateral (Resumido)
                if (codigoZona === "PDU") {
                    panel.className = "result-container alerta-amarilla";
                    titulo.innerText = "‚ö†Ô∏è POBLADO RURAL";
                } else {
                    panel.className = "result-container alerta-roja";
                    titulo.innerText = "üö´ ZONA RESTRINGIDA";
                }
                zona.innerText = nombreZona;
                btnTabla.style.display = "block"; // Mostrar bot√≥n de tabla

            } else {
                // --- SUELO URBANO ---
                panel.className = "result-container alerta-verde";
                titulo.innerText = "‚úÖ SUELO URBANO";
                zona.innerText = "Fuera de Zonificaci√≥n de Conservaci√≥n";
                btnTabla.style.display = "none"; // No hay tabla de PGOEDF para suelo urbano
                datosActuales = {};
            }
        }

        map.on('click', e => analizarPunto(e.latlng));

        // 4. MODAL (TABLA COMPLETA)
        document.getElementById('btn-ver-tabla').addEventListener('click', function() {
            if(!datosActuales.titulo) return;
            
            document.getElementById('modal-titulo').innerText = datosActuales.titulo;
            document.getElementById('modal-clave').innerText = datosActuales.clave;
            
            var ulProh = document.getElementById('lista-prohibido-full');
            var ulPerm = document.getElementById('lista-permitido-full');
            
            // Llenar listas completas sin cortar
            ulProh.innerHTML = datosActuales.proh.length ? datosActuales.proh.map(i => `<li>${i}</li>`).join("") : "<li>Sin datos espec√≠ficos.</li>";
            ulPerm.innerHTML = datosActuales.perm.length ? datosActuales.perm.map(i => `<li>${i}</li>`).join("") : "<li>Sin datos espec√≠ficos.</li>";
            
            document.getElementById('modal-detalle').style.display = 'flex';
        });

        function cerrarModal() {
            document.getElementById('modal-detalle').style.display = 'none';
        }

        // 5. BOTONES
        function buscar() {
            var input = document.getElementById('input-busqueda').value.trim();
            if(!input) return;
            var coordRegex = /^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/;
            var match = input.match(coordRegex);
            if (match) {
                analizarPunto([parseFloat(match[1]), parseFloat(match[3])]);
            } else {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}+CDMX&limit=1`)
                .then(r=>r.json()).then(d=>{
                    if(d.length > 0) analizarPunto([d[0].lat, d[0].lon]);
                    else alert("No encontrado");
                });
            }
        }
        document.getElementById('btn-buscar').addEventListener('click', buscar);
        document.getElementById('input-busqueda').addEventListener('keypress', e => { if(e.key==='Enter') buscar() });
        document.getElementById('btn-gps').addEventListener('click', function() {
            document.getElementById('status-gps').innerText = "Buscando...";
            map.locate({setView: true, maxZoom: 17});
        });
        map.on('locationfound', e => {
            document.getElementById('status-gps').innerText = "";
            analizarPunto(e.latlng);
        });

    </script>
</body>
</html>
