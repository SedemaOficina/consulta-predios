<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Librer√≠a PIP (Punto en Pol√≠gono) -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    
    <!-- CSS EXTERNO -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
    </header>

    <div class="main-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta de Uso de Suelo</h3>
                <p>Verifica la zonificaci√≥n (PGOEDF).</p>
            </div>

            <div class="sidebar-body">
                <!-- GPS -->
                <div class="control-group">
                    <label>Opci√≥n A: Estoy en el sitio</label>
                    <button id="btn-gps" class="btn-full btn-guinda">
                        üìç USAR MI UBICACI√ìN
                    </button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O</span></div>

                <!-- BUSCADOR -->
                <div class="control-group">
                    <label>Opci√≥n B: Direcci√≥n o Coordenada</label>
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Ej: 19.25, -99.10 o Calle...">
                        <button id="btn-buscar">üîé</button>
                    </div>
                    <small style="color:#666; font-size:10px;">Tip: Pega coordenadas de Google Maps.</small>
                </div>

                <!-- RESULTADOS -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <h4 id="res-titulo">RESULTADO</h4>
                    <p id="res-zona" style="font-weight:bold; margin-bottom:5px;"></p>
                    <div id="res-reglas"></div>
                </div>

                <!-- LEYENDA -->
                <div class="leyenda-box">
                    <h4>Simbolog√≠a</h4>
                    <div class="item"><span class="dot rojo"></span> Suelo de Conservaci√≥n (Restringido)</div>
                    <div class="item"><span class="dot azul"></span> Zonificaci√≥n PGOEDF</div>
                    <div class="item"><span class="dot verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <script>
        // ==========================================
        // 1. BASE DE DATOS REGLAS
        // ==========================================
        const reglas = {
            "FC": { nombre: "Forestal de Conservaci√≥n", proh: ["VIVIENDA", "Agricultura", "Ganader√≠a"], perm: ["Reforestaci√≥n", "Vigilancia", "Ecoturismo"] },
            "FCE": { nombre: "Forestal de Conservaci√≥n Especial", proh: ["ASENTAMIENTOS", "Industria", "Miner√≠a"], perm: ["Turismo sustentable", "Viveros", "Apicultura"] },
            "FP": { nombre: "Forestal de Protecci√≥n", proh: ["Urbanizaci√≥n", "Tiraderos", "Pastoreo"], perm: ["Obras conservaci√≥n", "Reforestaci√≥n"] },
            "FPE": { nombre: "Forestal de Protecci√≥n Especial", proh: ["Crecimiento urbano", "Quemas"], perm: ["Agroforester√≠a", "Pastoreo controlado"] },
            "AF": { nombre: "Agroforestal", proh: ["Fraccionamientos", "Industria", "Tala"], perm: ["Cultivos", "Frutales", "Le√±a dom√©stica"] },
            "AFE": { nombre: "Agroforestal Especial", proh: ["Nuevas construcciones", "Miner√≠a"], perm: ["Cultivos anuales", "Invernaderos"] },
            "AE": { nombre: "Agroecol√≥gica", proh: ["Uso Habitacional", "Centros comerciales"], perm: ["Agricultura", "Venta productos"] },
            "AEE": { nombre: "Agroecol√≥gica Especial", proh: ["Relleno canales", "Construcci√≥n"], perm: ["Chinampas", "Turismo canales"] },
            "ANP": { nombre: "√Årea Natural Protegida", proh: ["Todo uso no autorizado por Plan de Manejo"], perm: ["Conservaci√≥n"] },
            "PDU": { nombre: "Poblado Rural (PDU)", proh: ["Crecimiento fuera del pol√≠gono"], perm: ["Vivienda (Solo regularizada)"] }
        };

        function interpretarDatos(props) {
            var clave = (props.CLAVE || "").trim().toUpperCase();
            var nombreLargo = (props.PGOEDF || props.DESCRIPCIO || "").toUpperCase();
            
            if (reglas[clave]) return reglas[clave];
            
            if (nombreLargo.includes("FORESTAL DE CONSERVACION")) return reglas["FC"];
            if (nombreLargo.includes("AGROECOLOGICO")) return reglas["AE"];
            if (nombreLargo.includes("PROTECCION")) return reglas["FP"];
            
            return { nombre: nombreLargo || "Zona Regulada", proh: ["Urbanizaci√≥n no autorizada"], perm: ["Consulta a SEDEMA"] };
        }

        // ==========================================
        // 2. MAPA
        // ==========================================
        var map = L.map('map', { zoomControl: false }).setView([19.28, -99.13], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.8, attribution: 'CARTO', maxZoom: 19 });
        
        map.addLayer(satelite); // Capa base default

        // Control de Capas Base
        var baseMaps = { "Sat√©lite": satelite, "Calles": calles };
        var overlayMaps = {}; // Se llenar√° din√°micamente
        var layerControl = L.control.layers(baseMaps, overlayMaps, { position: 'topright' }).addTo(map);

        // ==========================================
        // 3. CARGA DE DATOS (Correcci√≥n Cr√≠tica)
        // ==========================================
        
        // Variables GLOBALES para que leaflet-pip las encuentre
        var geojsonSuelo; // La capa roja
        var geojsonZoni;  // La capa azul (reglas)

        // A) SUELO DE CONSERVACI√ìN (Capa Roja)
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                // Creamos la capa GeoJSON directa (NO LayerGroup)
                geojsonSuelo = L.geoJSON(data, {
                    style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.25, weight: 0 },
                    interactive: false // Esta es solo visual y para el PIP
                }).addTo(map);
                
                layerControl.addOverlay(geojsonSuelo, "üî¥ Suelo de Conservaci√≥n");
            });

        // B) ZONIFICACI√ìN (Capa Azul y Reglas)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => r.json())
            .then(data => {
                geojsonZoni = L.geoJSON(data, {
                    style: { color: '#3498db', weight: 1, fillOpacity: 0.05 },
                    onEachFeature: function(feature, layer) {
                        layer.on('click', function(e) {
                            L.DomEvent.stopPropagation(e);
                            analizarPunto(e.latlng); // Disparar an√°lisis
                        });
                    }
                }).addTo(map);

                layerControl.addOverlay(geojsonZoni, "üîµ Zonificaci√≥n PGOEDF");
            })
            .catch(e => console.error("Error cargando zonificaci√≥n:", e));

        // C) ANP (Opcional)
        fetch('anp.geojson').then(r => r.json()).then(d => {
            var layerANP = L.geoJSON(d, { style: { color: '#27ae60', fillOpacity: 0.3, weight: 1 } }).addTo(map);
            layerControl.addOverlay(layerANP, "üü¢ √Åreas Naturales Protegidas");
        }).catch(e=>{});

        // ==========================================
        // 4. L√ìGICA DE AN√ÅLISIS (EL FIX)
        // ==========================================
        var pinActual;

        function analizarPunto(latlng) {
            // Mover mapa
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);

            // VALIDACI√ìN 1: ¬øExisten las capas?
            if (!geojsonSuelo || !geojsonZoni) {
                alert("Los mapas siguen cargando, intenta en unos segundos...");
                return;
            }

            // VALIDACI√ìN 2: LEAFLET PIP
            // Buscamos primero en la capa roja (Suelo Conservaci√≥n)
            var hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);
            
            // Elementos visuales
            var panel = document.getElementById('panel-resultados');
            var titulo = document.getElementById('res-titulo');
            var zona = document.getElementById('res-zona');
            var divReglas = document.getElementById('res-reglas');
            var htmlPopup = "";
            panel.style.display = "block";

            // SI CAE DENTRO DEL ROJO -> ES RESTRINGIDO
            if (hitsSuelo.length > 0) {
                
                // Ahora buscamos qu√© regla espec√≠fica aplica (Capa Azul)
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var nombreZona = "Suelo de Conservaci√≥n";
                var reglasZona = { perm: ["Consultar SEDEMA"], proh: ["Urbanizaci√≥n"] };
                var uga = "S/D";

                // Si encontramos el pol√≠gono de zonificaci√≥n exacto
                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    var info = interpretarDatos(p);
                    nombreZona = info.nombre;
                    reglasZona = info;
                    uga = p.UGA || p.CLAVE || "";
                }

                // Generamos listas HTML
                var liNo = reglasZona.proh.map(x=>`<li>${x}</li>`).join("");
                var liSi = reglasZona.perm.map(x=>`<li>${x}</li>`).join("");

                // PINTAMOS ROJO (PELIGRO)
                panel.className = "result-container alerta-roja";
                titulo.innerText = "üö´ PROHIBIDO (SUELO DE CONSERVACI√ìN)";
                zona.innerHTML = `${nombreZona}<br><small>UGA: ${uga}</small>`;
                divReglas.innerHTML = `
                    <div class="box prohibido"><strong>RESTRICCIONES:</strong><ul>${liNo}</ul></div>
                    <div class="box permitido"><strong>PERMITIDO:</strong><ul>${liSi}</ul></div>
                `;

                htmlPopup = `
                    <div style="font-family:Montserrat; text-align:center;">
                        <h4 style="color:#C0392B; margin:0;">‚ö†Ô∏è ZONA RESTRINGIDA</h4>
                        <p style="font-size:11px; margin:5px 0;"><strong>${nombreZona}</strong></p>
                        <div style="background:#ffebee; border:1px solid #C0392B; padding:5px; text-align:left;">
                            <strong style="color:#C0392B; font-size:10px;">PROHIBIDO:</strong>
                            <ul style="font-size:10px; margin:0; padding-left:15px;">${liNo}</ul>
                        </div>
                    </div>
                `;

            } else {
                // SI NO CAE EN EL ROJO -> ES SUELO URBANO
                panel.className = "result-container alerta-verde";
                titulo.innerText = "‚úÖ SUELO URBANO";
                zona.innerText = "Fuera del l√≠mite de conservaci√≥n.";
                divReglas.innerHTML = `
                    <p style="font-size:12px;">Esta ubicaci√≥n no intersecta con la capa de Suelo de Conservaci√≥n.</p>
                    <div class="box permitido">
                        <strong>ACCI√ìN SUGERIDA:</strong>
                        <ul>
                            <li>Verificar uso habitacional en SEDUVI.</li>
                            <li>Consultar escrituras en Registro P√∫blico.</li>
                        </ul>
                    </div>
                `;

                htmlPopup = `
                    <div style="text-align:center; font-family:Montserrat;">
                        <h4 style="color:#27ae60; margin:0;">‚úÖ SUELO URBANO</h4>
                        <p style="font-size:11px;">Zona sin restricci√≥n ambiental aparente.</p>
                    </div>
                `;
            }

            pinActual.bindPopup(htmlPopup, {minWidth:240}).openPopup();
        }

        // Clic en mapa (general)
        map.on('click', function(e) { analizarPunto(e.latlng); });

        // ==========================================
        // 5. FUNCIONALIDAD UI
        // ==========================================
        
        // GPS
        document.getElementById('btn-gps').addEventListener('click', function() {
            var status = document.getElementById('status-gps');
            status.innerText = "üõ∞Ô∏è Buscando se√±al...";
            map.locate({setView: true, maxZoom: 17, enableHighAccuracy: true});
        });

        map.on('locationfound', function(e) {
            document.getElementById('status-gps').innerText = "";
            analizarPunto(e.latlng);
        });

        map.on('locationerror', function() {
            alert("Enciende tu GPS o permite el acceso a ubicaci√≥n.");
            document.getElementById('status-gps').innerText = "";
        });

        // BUSCADOR
        function ejecutarBusqueda() {
            var input = document.getElementById('input-busqueda').value.trim();
            if(!input) return;

            // Regex Coordenadas (Acepta: "19.5, -99.1" / "19.5 -99.1")
            var match = input.match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);

            if (match) {
                var lat = parseFloat(match[1]);
                var lng = parseFloat(match[3]);
                // Filtro b√°sico CDMX (aprox) para evitar irse a China por error
                if (lat > 18 && lat < 20 && lng > -100 && lng < -98) {
                    analizarPunto([lat, lng]);
                } else {
                    alert("Coordenadas fuera del rango de la Ciudad de M√©xico.");
                }
            } else {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}+CDMX&limit=1`)
                .then(r=>r.json())
                .then(d=>{
                    if(d.length > 0) analizarPunto([d[0].lat, d[0].lon]);
                    else alert("Direcci√≥n no encontrada.");
                })
                .catch(()=> alert("Error de conexi√≥n."));
            }
        }

        document.getElementById('btn-buscar').addEventListener('click', ejecutarBusqueda);
        document.getElementById('input-busqueda').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') ejecutarBusqueda();
        });

    </script>
</body>
</html>
