<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validador de Predios | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- ESTILOS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- HEADER INSTITUCIONAL -->
    <header class="gob-header">
        <div class="header-inner">
            <img src="logo-sedema.png" alt="Logo SEDEMA" class="logo-cdmx">
            <div class="vertical-line"></div>
            <div class="dependency-name">
                <h1>SECRETAR√çA DEL<br>MEDIO AMBIENTE</h1>
            </div>
        </div>
        <div class="header-right">
            <span class="emergency-text">Denuncia irregularidades al 911 o PAOT</span>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main class="layout-container">
        
        <!-- EL MAPA -->
        <div id="map"></div>

        <!-- INTERFAZ DE USUARIO (TARJETA FLOTANTE) -->
        <div class="info-card">
            <div class="card-header">
                <h2>Protege tu Patrimonio</h2>
                <p>Consulta el estatus del suelo antes de comprar.</p>
            </div>
            
            <div class="card-body">
                
                <!-- BOT√ìN DE GPS -->
                <div class="action-section">
                    <label>Opci√≥n A: Estoy en el terreno</label>
                    <button id="btn-gps-large" class="btn-block btn-guinda">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
                        UBICARME AHORA (GPS)
                    </button>
                    <p id="gps-status" class="status-text"></p>
                </div>

                <div class="divider-text">O BUSCA UNA DIRECCI√ìN</div>

                <!-- BUSCADOR MANUAL -->
                <div class="action-section">
                    <label>Opci√≥n B: Buscar desde casa</label>
                    <div class="search-wrapper">
                        <input type="text" id="manual-search-input" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-manual-search" class="btn-search">üîç</button>
                    </div>
                    <p class="hint-text">Ejemplo coordenadas: 19.2831, -99.1354</p>
                </div>

                <!-- LEYENDA / SIMBOLOG√çA -->
                <div class="results-area">
                    <h3>Simbolog√≠a Oficial</h3>
                    
                    <div class="legend-item alert-item">
                        <span class="color-box guinda-fill"></span>
                        <div>
                            <strong>SUELO DE CONSERVACI√ìN</strong>
                            <span>Zona Restringida. Venta y construcci√≥n prohibida.</span>
                        </div>
                    </div>

                    <div class="legend-item">
                        <span class="color-box verde-fill"></span>
                        <div>
                            <strong>√ÅREA NATURAL PROTEGIDA</strong>
                            <span>Bosques y Barrancas (ANP). Propiedad Federal/Local.</span>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Bot√≥n para cerrar en celular -->
            <div class="mobile-toggle" id="mobile-toggle">Ver Mapa Completo ‚¨á</div>
        </div>
    </main>

    <!-- LIBRER√çAS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Librer√≠a AJAX para cargar GeoJSON f√°cilmente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
        // 1. INICIALIZAR MAPA (Centrado en CDMX Sur)
        var map = L.map('map', { zoomControl: false }).setView([19.25, -99.15], 11);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // 2. CAPAS BASE (Sat√©lite por defecto para ver si hay √°rboles/casas)
        var mapaGris = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CARTO' });
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
        var mapaCalles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });

        map.addLayer(mapaSatelite); // Inicia con Sat√©lite

        var baseMaps = { "Sat√©lite (Bosque)": mapaSatelite, "Mapa Claro": mapaGris, "Callejero": mapaCalles };
        L.control.layers(baseMaps, null, { position: 'topright', collapsed: false }).addTo(map);

        // ============================================================
        // 3. CARGAR TUS CAPAS REALES
        // ============================================================

        // ESTILO ROJO/GUINDA (Suelo de Conservaci√≥n)
        var styleSueloConservacion = {
            color: '#9d2148',       // Borde Guinda
            fillColor: '#9d2148',   // Relleno Guinda
            weight: 1,
            opacity: 1,
            fillOpacity: 0.5
        };

        // ESTILO VERDE (ANP / Bosques)
        var styleANP = {
            color: '#027a35',
            fillColor: '#027a35',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.5
        };

        // FUNCI√ìN POPUP (Qu√© sale al dar clic)
        function popupStyle(feature, layer, titulo) {
            // Intenta buscar el nombre en varias columnas comunes
            var props = feature.properties;
            var nombre = props.NOMBRE || props.Nombre || props.ZONA || props.COLONIA || "Zona Regulada";
            
            var html = `
                <div style="text-align:center; min-width:200px;">
                    <h3 style="color:${titulo === 'ANP' ? '#027a35' : '#9d2148'}; margin-top:0;">‚ö†Ô∏è ATENCI√ìN</h3>
                    <strong>${nombre}</strong><br>
                    <p style="font-size:12px; margin:5px 0;">Este predio se encuentra clasificado como:</p>
                    <div style="background:${titulo === 'ANP' ? '#027a35' : '#9d2148'}; color:white; padding:5px; border-radius:4px; font-weight:bold; font-size:11px;">
                        ${titulo === 'ANP' ? '√ÅREA NATURAL PROTEGIDA' : 'SUELO DE CONSERVACI√ìN'}
                    </div>
                    <p style="font-size:11px; margin-top:5px;">Verifica con SEDEMA antes de cualquier transacci√≥n.</p>
                </div>
            `;
            layer.bindPopup(html);
        }

        // --- CARGA DEL ARCHIVO PRINCIPAL ---
        fetch('suelo-de-conservacion-2020.geojson')
            .then(response => {
                if(!response.ok) throw new Error("No se encontr√≥ el archivo");
                return response.json();
            })
            .then(data => {
                L.geoJSON(data, {
                    style: styleSueloConservacion,
                    onEachFeature: function(feature, layer) {
                        popupStyle(feature, layer, 'SUELO DE CONSERVACI√ìN');
                    }
                }).addTo(map);
                console.log("Capa Suelo Conservaci√≥n cargada con √©xito.");
            })
            .catch(err => {
                console.error("Error cargando capa:", err);
                // Si falla, no hace nada visual, solo lo marca en consola (F12)
            });

        // --- CARGA DEL ARCHIVO SECUNDARIO (Bosques/ANP) ---
        // Nota: Si a√∫n no tienes este archivo unido, no pasar√° nada, solo no cargar√°.
        // N√≥mbralo 'anp.geojson' en tu GitHub para que funcione.
        fetch('anp.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: styleANP,
                    onEachFeature: function(feature, layer) {
                        popupStyle(feature, layer, 'ANP');
                    }
                }).addTo(map);
            }).catch(e => console.log("Sin capa ANP adicional"));


        // ============================================================
        // 4. FUNCIONALIDAD DE UX (GPS y B√öSQUEDA)
        // ============================================================

        // A. GPS
        const btnGps = document.getElementById('btn-gps-large');
        const statusText = document.getElementById('gps-status');
        var userMarker, userCircle;

        btnGps.addEventListener('click', function() {
            statusText.innerHTML = "üì° Buscando sat√©lites...";
            statusText.style.color = "#b28e5c";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });

        map.on('locationfound', function(e) {
            statusText.innerHTML = "‚úÖ Ubicaci√≥n encontrada";
            statusText.style.color = "green";
            
            if(userMarker) map.removeLayer(userMarker);
            if(userCircle) map.removeLayer(userCircle);

            userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#007bff", color: "#fff", fillOpacity: 1 }).addTo(map).bindPopup("T√∫ est√°s aqu√≠").openPopup();
            userCircle = L.circle(e.latlng, e.accuracy).addTo(map);
            
            colapsarMovil();
        });

        map.on('locationerror', function(e) {
            statusText.innerHTML = "‚ùå Error: Activa tu ubicaci√≥n/GPS.";
            statusText.style.color = "red";
        });

        // B. B√öSQUEDA
        const inputSearch = document.getElementById('manual-search-input');
        const btnSearch = document.getElementById('btn-manual-search');

        function realizarBusqueda() {
            var query = inputSearch.value;
            if (!query) return;

            // Detectar coordenadas
            if (query.includes(',') && query.match(/[0-9]/)) {
                var coords = query.split(',');
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.setView([lat, lng], 17);
                    L.marker([lat, lng]).addTo(map).bindPopup("Coordenada ingresada").openPopup();
                    colapsarMovil();
                    return;
                }
            }

            // Buscar texto (Nominatim)
            statusText.innerHTML = "üîç Buscando direcci√≥n...";
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}+CDMX+Mexico&addressdetails=1&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) {
                        var lat = data[0].lat;
                        var lon = data[0].lon;
                        map.setView([lat, lon], 17);
                        L.marker([lat, lon]).addTo(map).bindPopup(data[0].display_name).openPopup();
                        statusText.innerHTML = "";
                        colapsarMovil();
                    } else {
                        alert("Direcci√≥n no encontrada. Intenta ser m√°s espec√≠fico (Colonia, Alcald√≠a).");
                        statusText.innerHTML = "";
                    }
                });
        }

        btnSearch.addEventListener('click', realizarBusqueda);
        inputSearch.addEventListener('keypress', function (e) { if (e.key === 'Enter') realizarBusqueda(); });

        // C. UX M√ìVIL
        function colapsarMovil() {
            if(window.innerWidth < 600) {
                document.querySelector('.info-card').classList.add('collapsed');
                document.getElementById('mobile-toggle').innerHTML = "Abrir Men√∫ ‚¨Ü";
            }
        }

        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.info-card').classList.toggle('collapsed');
            var isCollapsed = document.querySelector('.info-card').classList.contains('collapsed');
            this.innerHTML = isCollapsed ? "Abrir Men√∫ ‚¨Ü" : "Ver Mapa Completo ‚¨á";
        });

    </script>
</body>
</html>
