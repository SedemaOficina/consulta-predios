<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validador de Predios | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- Librer√≠a para detectar si un punto est√° dentro del pol√≠gono (Point in Polygon) -->
<script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <!-- ESTILOS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- HEADER INSTITUCIONAL -->
    <header class="gob-header">
        <div class="header-inner">
            <img src="logo-sedema.png" alt="Logo SEDEMA" class="logo-cdmx">
            <div class="vertical-line"></div>
            <div class="dependency-name">
                <h1>SECRETAR√çA DEL<br>MEDIO AMBIENTE</h1>
            </div>
        </div>
        <div class="header-right">
            <span class="emergency-text">Denuncia irregularidades al 911 o PAOT</span>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <main class="layout-container">
        
        <!-- EL MAPA -->
        <div id="map"></div>

        <!-- INTERFAZ DE USUARIO (TARJETA FLOTANTE) -->
        <div class="info-card">
            <div class="card-header">
                <h2>Protege tu Patrimonio</h2>
                <p>Consulta el estatus del suelo antes de comprar.</p>
            </div>
            
            <div class="card-body">
                
                <!-- BOT√ìN DE GPS -->
                <div class="action-section">
                    <label>Opci√≥n A: Estoy en el terreno</label>
                    <button id="btn-gps-large" class="btn-block btn-guinda">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
                        UBICARME AHORA (GPS)
                    </button>
                    <p id="gps-status" class="status-text"></p>
                </div>

                <div class="divider-text">O BUSCA UNA DIRECCI√ìN</div>

                <!-- BUSCADOR MANUAL -->
                <div class="action-section">
                    <label>Opci√≥n B: Buscar desde casa</label>
                    <div class="search-wrapper">
                        <input type="text" id="manual-search-input" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-manual-search" class="btn-search">üîç</button>
                    </div>
                    <p class="hint-text">Ejemplo coordenadas: 19.2831, -99.1354</p>
                </div>

                <!-- LEYENDA / SIMBOLOG√çA -->
                <div class="results-area">
                    <h3>Simbolog√≠a Oficial</h3>
                    
                    <div class="legend-item alert-item">
                        <span class="color-box guinda-fill"></span>
                        <div>
                            <strong>SUELO DE CONSERVACI√ìN</strong>
                            <span>Zona Restringida. Venta y construcci√≥n prohibida.</span>
                        </div>
                    </div>

                    <div class="legend-item">
                        <span class="color-box verde-fill"></span>
                        <div>
                            <strong>√ÅREA NATURAL PROTEGIDA</strong>
                            <span>Bosques y Barrancas (ANP). Propiedad Federal/Local.</span>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Bot√≥n para cerrar en celular -->
            <div class="mobile-toggle" id="mobile-toggle">Ver Mapa Completo ‚¨á</div>
        </div>
    </main>

    <!-- LIBRER√çAS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Librer√≠a AJAX para cargar GeoJSON f√°cilmente -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
        // --- 1. CONFIGURACI√ìN DEL MAPA ---
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.15], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Mapas Base
        var mapaBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' }).addTo(map);
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        
        L.control.layers({ "Mapa Claro": mapaBase, "Sat√©lite": mapaSatelite }).addTo(map);

        // Variables para guardar las capas y poder consultarlas despu√©s
        var capaSueloConservacion;
        var capaZonificacion;

        // --- 2. CAPAS DE INFORMACI√ìN ---

        // ESTILOS
        var estiloSC = { color: '#9d2148', fillColor: '#9d2148', weight: 1, fillOpacity: 0.3 };
        var estiloZonif = { color: '#2980b9', weight: 1, fillOpacity: 0 }; // Invisible por defecto, solo para consulta

        // CARGAR SUELO DE CONSERVACI√ìN (ROJO)
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                capaSueloConservacion = L.geoJSON(data, {
                    style: estiloSC,
                    onEachFeature: function(feature, layer) {
                        // Si le dan clic directo al pol√≠gono rojo
                        layer.on('click', function(e) {
                            L.DomEvent.stopPropagation(e); // Evita que el clic pase al mapa de fondo
                            mostrarAlertaRoja(e.latlng, feature.properties);
                        });
                    }
                }).addTo(map);
            });

        // CARGAR ZONIFICACI√ìN POE (TU ARCHIVO RENOMBRADO A zonificacion.geojson)
        fetch('zonificacion.geojson')
            .then(r => r.json())
            .then(data => {
                capaZonificacion = L.geoJSON(data, {
                    style: estiloZonif,
                    onEachFeature: function(feature, layer) {
                        // Tambi√©n detectamos clic aqu√≠ para dar detalles espec√≠ficos
                        layer.on('click', function(e) {
                            // No detenemos propagaci√≥n aqu√≠ para que se combine con la alerta roja si coinciden
                        });
                    }
                }).addTo(map);
            })
            .catch(err => console.log("A√∫n no subes zonificacion.geojson o tiene error de nombre"));


        // --- 3. SISTEMA DE ALERTAS INTELIGENTE ---

        // FUNCI√ìN: Muestra Popup ROJO (Peligro)
        function mostrarAlertaRoja(latlng, props) {
            var nombre = props.NOMBRE || props.ZONA || "Zona Restringida";
            
            var html = `
                <div style="text-align:center; min-width:200px; font-family:'Roboto'">
                    <div style="background:#9d2148; color:white; padding:10px; border-radius:5px 5px 0 0;">
                        <h3 style="margin:0; font-size:16px;">üö´ ZONA PROHIBIDA</h3>
                    </div>
                    <div style="padding:10px; border:1px solid #9d2148; border-top:none;">
                        <strong>${nombre}</strong>
                        <p style="font-size:13px; margin:8px 0;">Est√°s dentro del Suelo de Conservaci√≥n.</p>
                        <button style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:3px; font-weight:bold;">VENTA ILEGAL</button>
                    </div>
                </div>
            `;
            L.popup().setLatLng(latlng).setContent(html).openOn(map);
        }

        // FUNCI√ìN: Muestra Popup VERDE (Suelo Urbano / Permitido)
        function mostrarAlertaVerde(latlng) {
            var html = `
                <div style="text-align:center; min-width:200px; font-family:'Roboto'">
                    <div style="background:#27ae60; color:white; padding:10px; border-radius:5px 5px 0 0;">
                        <h3 style="margin:0; font-size:16px;">‚úÖ SUELO URBANO</h3>
                    </div>
                    <div style="padding:10px; border:1px solid #27ae60; border-top:none;">
                        <p style="font-size:13px; margin:5px 0;">Esta zona <strong>NO</strong> est√° catalogada como Conservaci√≥n Ambiental en nuestros registros.</p>
                        <small style="color:#777;">(Verifica el uso de suelo habitacional en SEDUVI)</small>
                    </div>
                </div>
            `;
            L.popup().setLatLng(latlng).setContent(html).openOn(map);
        }

        // --- 4. DETECTOR DE CLICS EN EL MAPA (LA MAGIA) ---
        
        map.on('click', function(e) {
            // Este evento se dispara cuando das clic en el MAPA BASE (lo gris)
            // Verificamos si por error no carg√≥ la capa a√∫n
            if (!capaSueloConservacion) return;

            // Usamos leaflet-pip para ver si el clic cay√≥ dentro de alg√∫n pol√≠gono rojo
            // aunque el usuario haya dado clic "cerca" o en un hueco.
            var resultados = leafletPip.pointInLayer(e.latlng, capaSueloConservacion);

            if (resultados.length > 0) {
                // Cay√≥ dentro (por si fall√≥ el evento del layer)
                mostrarAlertaRoja(e.latlng, resultados[0].feature.properties);
            } else {
                // Cay√≥ FUERA -> Es Suelo Urbano
                mostrarAlertaVerde(e.latlng);
            }
        });


        // --- 5. BUSCADOR Y GPS (Integrado con validaci√≥n) ---

        function validarUbicacion(lat, lng, direccion) {
            map.setView([lat, lng], 16); // Zoom autom√°tico cercano
            
            // Creamos un punto temporal para validar
            var latlng = L.latLng(lat, lng);
            
            // Verificamos matem√°ticamente
            if (capaSueloConservacion) {
                var resultados = leafletPip.pointInLayer(latlng, capaSueloConservacion);
                
                if (resultados.length > 0) {
                    mostrarAlertaRoja(latlng, resultados[0].feature.properties);
                } else {
                    mostrarAlertaVerde(latlng);
                }
            } else {
                // Si no ha cargado la capa, ponemos marcador normal
                L.marker([lat, lng]).addTo(map).bindPopup(direccion).openPopup();
            }
            
            // Colapsar men√∫ m√≥vil si aplica
            if(window.innerWidth < 600) {
                document.querySelector('.info-card').classList.add('collapsed');
            }
        }

        // GPS
        const btnGps = document.getElementById('btn-gps-large');
        const statusText = document.getElementById('gps-status');

        btnGps.addEventListener('click', function() {
            statusText.innerText = "üì° Localizando...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });

        map.on('locationfound', e => {
            statusText.innerText = "Ubicaci√≥n encontrada";
            // Validamos la ubicaci√≥n del usuario
            validarUbicacion(e.latlng.lat, e.latlng.lng, "Tu ubicaci√≥n");
        });

        // BUSCADOR MANUAL
        const inputSearch = document.getElementById('manual-search-input');
        const btnSearch = document.getElementById('btn-manual-search');

        function realizarBusqueda() {
            var query = inputSearch.value;
            if (!query) return;

            // Coordenadas
            if (query.includes(',') && query.match(/[0-9]/)) {
                var coords = query.split(',');
                validarUbicacion(parseFloat(coords[0]), parseFloat(coords[1]), "Coordenada");
                return;
            }

            // Texto
            statusText.innerText = "Buscando...";
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}+CDMX&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) {
                        statusText.innerText = "";
                        validarUbicacion(data[0].lat, data[0].lon, data[0].display_name);
                    } else {
                        alert("No encontramos esa direcci√≥n. Intenta con Colonia y Alcald√≠a.");
                        statusText.innerText = "";
                    }
                });
        }

        btnSearch.addEventListener('click', realizarBusqueda);
        inputSearch.addEventListener('keypress', function (e) { if (e.key === 'Enter') realizarBusqueda(); });

        // Toggle M√≥vil
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.info-card').classList.toggle('collapsed');
        });

    </script>
</body>
</html>
