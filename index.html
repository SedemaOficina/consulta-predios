<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Consulta de Predios | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET Y HERRAMIENTAS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Librer√≠a vital para detectar si un punto cae dentro de un pol√≠gono -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <!-- AJAX para carga de archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- 1. ENCABEZADO INSTITUCIONAL (LIMPIO) -->
    <header class="gob-header">
        <div class="logo-container">
            <!-- Solo tu logo aqu√≠ -->
            <img src="logo-sedema.png" alt="Gobierno CDMX - SEDEMA" class="logo-img">
            <div class="pleca-vertical"></div>
            <div class="titulos-header">
                <h1>SECRETAR√çA DEL MEDIO AMBIENTE</h1>
                <h2>Sistema de Ordenamiento Ecol√≥gico y Vigilancia</h2>
            </div>
        </div>
    </header>

    <!-- 2. CONTENEDOR PRINCIPAL (Flexbox: Panel Izquierda + Mapa Derecha) -->
    <div class="main-container">
        
        <!-- PANEL LATERAL DE CONTROL (SIEMPRE VISIBLE EN PC) -->
        <aside class="sidebar">
            
            <div class="sidebar-content">
                <!-- T√≠tulo del Panel -->
                <div class="panel-section">
                    <h3 class="panel-title">üõ°Ô∏è Validaci√≥n de Predios</h3>
                    <p class="panel-text">Herramienta oficial para prevenir fraudes en la compra-venta de terrenos en Suelo de Conservaci√≥n.</p>
                </div>

                <!-- PASO 1: BUSCADOR -->
                <div class="panel-section highlight-section">
                    <label class="step-label">1. ¬øD√ìNDE EST√Å EL TERRENO?</label>
                    
                    <button id="btn-gps" class="btn-gps-full">
                        <span style="font-size:18px; margin-right:5px;">üìç</span> Usar mi ubicaci√≥n actual
                    </button>
                    
                    <div style="text-align:center; margin: 10px 0; font-size:12px; color:#666;">‚Äî O ESCRIBE LA DIRECCI√ìN ‚Äî</div>

                    <div class="search-box">
                        <input type="text" id="input-busqueda" placeholder="Ej: Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">BUSCAR</button>
                    </div>
                </div>

                <!-- PASO 2: SIMBOLOG√çA Y ESTADO -->
                <div class="panel-section">
                    <label class="step-label">2. INTERPRETA EL MAPA</label>
                    <p class="panel-text small">Haz clic en cualquier zona coloreada para ver las reglas.</p>
                    
                    <div class="legend-row">
                        <span class="dot guinda"></span>
                        <div>
                            <strong>ZONA ROJA (Restringida)</strong>
                            <span class="legend-desc">Suelo de Conservaci√≥n. Prohibida la urbanizaci√≥n.</span>
                        </div>
                    </div>
                    <div class="legend-row">
                        <span class="dot azul"></span>
                        <div>
                            <strong>ZONA AZUL (Zonificaci√≥n)</strong>
                            <span class="legend-desc">Reglas espec√≠ficas del PGOEDF (Uso de suelo).</span>
                        </div>
                    </div>
                    <div class="legend-row">
                        <span class="dot verde"></span>
                        <div>
                            <strong>ZONA VERDE (ANP)</strong>
                            <span class="legend-desc">√Årea Natural Protegida Federal o Local.</span>
                        </div>
                    </div>
                </div>

                <!-- INFO DE RESULTADO (AQU√ç APARECER√Å EL DIAGN√ìSTICO) -->
                <div id="resultado-panel" class="panel-section result-box" style="display:none;">
                    <h4 id="res-titulo">RESULTADO DE CONSULTA</h4>
                    <p id="res-desc">Seleccione un punto en el mapa...</p>
                    <div id="res-acciones"></div>
                </div>

                <!-- BOT√ìN IMPRIMIR -->
                <div class="panel-footer">
                    <button onclick="window.print()" class="btn-print">üñ®Ô∏è Imprimir Reporte</button>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
        
    </div>

    <script>
        // =====================================================
        // BASE DE DATOS DE REGLAS (PGOEDF)
        // =====================================================
        const reglasPGOEDF = {
            "Forestal de Conservaci√≥n": {
                codigo: "FC",
                permitido: ["Reforestaci√≥n", "Vigilancia", "Ecoturismo"],
                prohibido: ["VIVIENDA", "Agricultura", "Ganader√≠a", "Apertura de calles"]
            },
            "Forestal de Conservaci√≥n Especial": {
                codigo: "FCE",
                permitido: ["Turismo sustentable", "Viveros", "Apicultura"],
                prohibido: ["NUEVOS ASENTAMIENTOS", "Industria", "Miner√≠a"]
            },
            "Forestal de Protecci√≥n": {
                codigo: "FP",
                permitido: ["Obras conservaci√≥n", "Reforestaci√≥n"],
                prohibido: ["Urbanizaci√≥n", "Tiraderos", "Pastoreo"]
            },
            "Agroforestal": {
                codigo: "AF",
                permitido: ["Cultivos", "Frutales", "Le√±a dom√©stica"],
                prohibido: ["Fraccionamientos", "Industria", "Tala rasa"]
            },
            "Agroecol√≥gica": {
                codigo: "AE",
                permitido: ["Agricultura", "Venta productos"],
                prohibido: ["Uso Habitacional", "Centros comerciales"]
            },
            "Agroecol√≥gica Especial": {
                codigo: "AEE",
                permitido: ["Chinampas", "Turismo canales"],
                prohibido: ["Relleno canales", "Construcci√≥n casas"]
            }
        };

        function getReglas(nombre) {
            if(!nombre) return null;
            for(let key in reglasPGOEDF) {
                if(nombre.toUpperCase().includes(key.toUpperCase())) return reglasPGOEDF[key];
            }
            return { codigo: "SC", permitido: ["Consulta a SEDEMA"], prohibido: ["Uso Urbano no autorizado"] };
        }

        // =====================================================
        // INICIALIZACI√ìN DEL MAPA
        // =====================================================
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.15], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Capas Base
        var mapaBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' });
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        map.addLayer(mapaSatelite); // Sat√©lite por defecto

        var baseMaps = { "Sat√©lite (Recomendado)": mapaSatelite, "Mapa Callejero": mapaBase };
        
        // Grupos de Capas (Layers)
        var layerSuelo = L.featureGroup().addTo(map); // Grupo Rojo
        var layerZoni = L.featureGroup().addTo(map);  // Grupo Azul
        var layerANP = L.featureGroup().addTo(map);   // Grupo Verde

        L.control.layers(baseMaps, {
            "üî¥ Suelo de Conservaci√≥n": layerSuelo,
            "üîµ Zonificaci√≥n (Reglas)": layerZoni,
            "üü¢ √Åreas Protegidas": layerANP
        }, { position: 'topright', collapsed: false }).addTo(map);


        // =====================================================
        // CARGA DE DATOS (GEOJSON)
        // =====================================================

        // 1. SUELO DE CONSERVACI√ìN (ROJO)
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.2, weight: 2 },
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup(crearPopup("PELIGRO", "SUELO DE CONSERVACI√ìN", "Zona restringida. No compres sin validar.", "rojo"));
                    }
                }).addTo(layerSuelo);
            });

        // 2. ZONIFICACI√ìN (AZUL - Reglas)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#2980b9', weight: 1, fillOpacity: 0.05 }, // Casi transparente
                    onEachFeature: function(feature, layer) {
                        var p = feature.properties;
                        var nombre = p.DESCRIPCIO || p.ZONA || "Zona Regulada";
                        var reglas = getReglas(nombre);
                        
                        var html = `
                            <div style="font-family:Roboto;">
                                <h4 style="color:#2980b9; margin:0;">ZONIFICACI√ìN: ${reglas.codigo}</h4>
                                <p><strong>${nombre}</strong></p>
                                <div style="background:#ffebee; padding:5px; margin:5px 0; border-left:3px solid red;">
                                    <small style="color:red">üö´ PROHIBIDO: ${reglas.prohibido.join(", ")}</small>
                                </div>
                                <div style="background:#e8f5e9; padding:5px; border-left:3px solid green;">
                                    <small style="color:green">‚úÖ PERMITIDO: ${reglas.permitido.join(", ")}</small>
                                </div>
                            </div>
                        `;
                        layer.bindPopup(html, {maxWidth: 300});
                    }
                }).addTo(layerZoni);
            })
            .catch(e => console.log("Falta archivo zonificaci√≥n"));

        // 3. ANP (VERDE)
        fetch('anp.geojson').then(r => r.json()).then(data => {
            L.geoJSON(data, {
                style: { color: '#27ae60', fillColor: '#27ae60', fillOpacity: 0.3, weight: 1 },
                onEachFeature: (f, l) => l.bindPopup(crearPopup("√ÅREA PROTEGIDA", "ANP FEDERAL/LOCAL", "Propiedad de la Naci√≥n. Delito invadir.", "verde"))
            }).addTo(layerANP);
        }).catch(e => console.log("Falta archivo ANP"));


        // =====================================================
        // L√ìGICA DE INTERACCI√ìN (EL CEREBRO)
        // =====================================================

        // Generador de HTML para Popups simples
        function crearPopup(titulo, subtitulo, texto, tipo) {
            let color = tipo === "rojo" ? "#C0392B" : (tipo === "verde" ? "#27ae60" : "#2980b9");
            return `
                <div style="text-align:center; font-family:Roboto;">
                    <div style="background:${color}; color:white; padding:5px;"><b>${titulo}</b></div>
                    <div style="padding:10px;">
                        <strong>${subtitulo}</strong><br>
                        <small>${texto}</small>
                    </div>
                </div>
            `;
        }

        // DETECTAR CLIC EN CUALQUIER PARTE DEL MAPA
        map.on('click', function(e) {
            // 1. Revisar si cay√≥ en Suelo de Conservaci√≥n (Usando leaflet-pip para precisi√≥n)
            var latlng = e.latlng;
            var enSueloConservacion = false;
            
            // Buscamos en las capas cargadas
            layerSuelo.eachLayer(function(layer) {
                // Leaflet-pip necesita el geojson interno
                if (layer.feature && leafletPip.pointInLayer(latlng, layer).length > 0) {
                    enSueloConservacion = true;
                } else if (layer.getLayers) { // Si es un grupo
                     layer.getLayers().forEach(l => {
                         if(leafletPip.pointInLayer(latlng, l).length > 0) enSueloConservacion = true;
                     });
                }
            });

            if (!enSueloConservacion) {
                // SI NO CAE EN EL ROJO -> ES SUELO URBANO (GRIS)
                L.popup()
                    .setLatLng(latlng)
                    .setContent(crearPopup("SUELO URBANO", "Zona Habitacional / Mixta", "Esta zona NO est√° clasificada como Conservaci√≥n en nuestros registros. Consulta SEDUVI.", "azul"))
                    .openOn(map);
                
                actualizarPanelLateral("SUELO URBANO", "Fuera de la zona de restricci√≥n ambiental.", "azul");
            } else {
                actualizarPanelLateral("‚ö†Ô∏è SUELO DE CONSERVACI√ìN", "Atenci√≥n: Zona sujeta a restricciones ambientales estrictas.", "rojo");
            }
        });

        // ACTUALIZAR EL PANEL LATERAL (FEEDBACK VISUAL)
        function actualizarPanelLateral(titulo, desc, color) {
            var panel = document.getElementById('resultado-panel');
            var txtTitulo = document.getElementById('res-titulo');
            var txtDesc = document.getElementById('res-desc');
            
            panel.style.display = 'block';
            txtTitulo.innerText = titulo;
            txtDesc.innerText = desc;
            
            panel.className = 'panel-section result-box'; // Reset
            if(color === 'rojo') panel.classList.add('alert-roja');
            if(color === 'verde') panel.classList.add('alert-verde');
            if(color === 'azul') panel.classList.add('alert-azul');
        }

        // FUNCIONALIDAD DE BOTONES
        document.getElementById('btn-buscar').addEventListener('click', function() {
            var query = document.getElementById('input-busqueda').value;
            if(!query) return;
            
            // Geocoding simple
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}+CDMX&limit=1`)
                .then(r => r.json())
                .then(d => {
                    if(d.length > 0) {
                        var lat = d[0].lat;
                        var lon = d[0].lon;
                        map.setView([lat, lon], 16);
                        L.marker([lat, lon]).addTo(map).bindPopup("Ubicaci√≥n Buscada").openPopup();
                        // Simular clic para validar
                        map.fireEvent('click', {latlng: L.latLng(lat, lon)});
                    } else {
                        alert("No se encontr√≥ la direcci√≥n. Intenta ser m√°s espec√≠fico.");
                    }
                });
        });

        document.getElementById('btn-gps').addEventListener('click', function() {
            map.locate({setView: true, maxZoom: 16});
        });

        map.on('locationfound', function(e) {
            L.circleMarker(e.latlng).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
            map.fireEvent('click', {latlng: e.latlng});
        });

    </script>
</body>
</html>
