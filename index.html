<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta de Predios | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET Y HERRAMIENTAS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- LIBRER√çAS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- Librer√≠a para detectar si el punto cae en el pol√≠gono (Vital) -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <!-- Librer√≠a para carga f√°cil de archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- 1. ENCABEZADO (SOLO LOGO) -->
    <header class="gob-header">
        <div class="logo-container">
            <img src="logo-sedema.png" alt="SEDEMA CDMX" class="logo-img">
        </div>
    </header>

    <!-- 2. MAPA (Ocupa toda la pantalla debajo del header) -->
    <div id="map"></div>

    <!-- 3. CONTROLES FLOTANTES -->
    
    <!-- Bot√≥n GPS -->
    <button id="btn-gps" class="btn-floating btn-gps" title="Ubicarme">
        üìç
    </button>

    <!-- Panel de Leyenda (Abajo) -->
    <div class="legend-panel">
        <div class="legend-item">
            <span class="color-box box-sc"></span> Suelo de Conservaci√≥n (Restringido)
        </div>
        <div class="legend-item">
            <span class="color-box box-zo"></span> Zonificaci√≥n (L√≠mites PGOEDF)
        </div>
    </div>

    <!-- SCRIPT DE L√ìGICA -->
    <script>
        // =====================================================
        // 1. BASE DE DATOS: TABLA DE USOS (PGOEDF)
        // =====================================================
        const reglasPGOEDF = {
            "Forestal de Conservaci√≥n": {
                codigo: "FC",
                desc: "Zona boscosa de alto valor. Prioridad: Recarga de acu√≠feros.",
                permitido: ["Reforestaci√≥n", "Vigilancia Ambiental", "Ecoturismo (Senderos)", "Investigaci√≥n"],
                prohibido: ["VIVIENDA", "Agricultura", "Ganader√≠a", "Apertura de caminos", "Tala"]
            },
            "Forestal de Conservaci√≥n Especial": {
                codigo: "FCE",
                desc: "Bosque con manejo sustentable.",
                permitido: ["Turismo sustentable", "Viveros", "Apicultura", "Cultivo de hongos"],
                prohibido: ["NUEVOS ASENTAMIENTOS", "Industria", "Miner√≠a", "Cambio de uso a urbano"]
            },
            "Forestal de Protecci√≥n": {
                codigo: "FP",
                desc: "Zona de transici√≥n que requiere restauraci√≥n.",
                permitido: ["Obras conservaci√≥n suelo", "Reforestaci√≥n"],
                prohibido: ["Urbanizaci√≥n", "Tiraderos de basura", "Pastoreo extensivo"]
            },
            "Forestal de Protecci√≥n Especial": {
                codigo: "FPE",
                desc: "√Åreas naturales que requieren frenar deterioro.",
                permitido: ["Agroforester√≠a", "Pastoreo controlado", "Manejo vida silvestre"],
                prohibido: ["Crecimiento urbano", "Quemas agr√≠colas", "Agroqu√≠micos"]
            },
            "Agroforestal": {
                codigo: "AF",
                desc: "Zona mixta bosque-cultivo.",
                permitido: ["Cultivos tradicionales", "Frutales", "Le√±a dom√©stica", "Turismo rural"],
                prohibido: ["Fraccionamientos", "Industria", "Tala rasa"]
            },
            "Agroforestal Especial": {
                codigo: "AFE",
                desc: "Zona agr√≠cola con manchones de bosque.",
                permitido: ["Cultivos anuales", "Hortalizas", "Invernaderos"],
                prohibido: ["Nuevas construcciones urbanas", "Miner√≠a"]
            },
            "Agroecol√≥gica": {
                codigo: "AE",
                desc: "Zona agr√≠cola productiva (Nopal, Hortalizas).",
                permitido: ["Agricultura intensiva", "Venta productos agr√≠colas"],
                prohibido: ["Cambio a uso habitacional", "Centros comerciales", "Industria"]
            },
            "Agroecol√≥gica Especial": {
                codigo: "AEE",
                desc: "Zona de Humedales y Chinampas.",
                permitido: ["Agricultura chinampera", "Turismo en canales", "Pesca"],
                prohibido: ["Relleno de canales", "Construcci√≥n de casas", "Drenaje"]
            }
        };

        // Funci√≥n para buscar reglas aunque el nombre en el SHP var√≠e un poco
        function obtenerReglas(nombre) {
            if (!nombre) return null;
            for (let key in reglasPGOEDF) {
                if (nombre.toUpperCase().includes(key.toUpperCase())) return reglasPGOEDF[key];
            }
            // Default si no encuentra match exacto pero est√° en la capa
            return {
                codigo: "SC",
                desc: "Suelo de Conservaci√≥n Regulado.",
                permitido: ["Consulta a la autoridad"],
                prohibido: ["Urbanizaci√≥n no autorizada"]
            };
        }

        // =====================================================
        // 2. CONFIGURACI√ìN DEL MAPA
        // =====================================================
        // Centrado en CDMX Sur
        var map = L.map('map', { zoomControl: false }).setView([19.25, -99.10], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Mapa Base Satelital (Mejor para ver predios reales)
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri'
        }).addTo(map);
        // Mapa de calles superpuesto (transparente) para ver nombres
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
            opacity: 0.8,
            attribution: '¬© CARTO'
        }).addTo(map);

        // Capa para b√∫squeda de direcciones
        L.Control.geocoder({
            defaultMarkGeocode: false,
            placeholder: "Buscar direcci√≥n...",
            position: 'topleft'
        }).on('markgeocode', function(e) {
            var latlng = e.geocode.center;
            map.setView(latlng, 16);
            mostrarDiagnostico(latlng, "Ubicaci√≥n Buscada");
        }).addTo(map);


        // =====================================================
        // 3. CARGA DE TUS CAPAS (GEOJSON)
        // =====================================================
        
        // Variables globales para las capas
        var layerSuelo, layerZoni;

        // A) SUELO DE CONSERVACI√ìN (Fondo Rojo - Alerta)
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                layerSuelo = L.geoJSON(data, {
                    style: {
                        color: '#C0392B',       // Rojo Institucional
                        weight: 0,              // Sin borde (el borde lo da la zonificaci√≥n)
                        fillColor: '#C0392B',
                        fillOpacity: 0.2        // Suave para ver el sat√©lite
                    },
                    interactive: false // No clicable, solo visual de fondo
                }).addTo(map);
            });

        // B) ZONIFICACI√ìN (L√≠neas y Reglas) - ESTA ES LA QUE MANDA EL CLIC
        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => r.json())
            .then(data => {
                layerZoni = L.geoJSON(data, {
                    style: {
                        color: '#ffffff',       // Borde blanco fino para separar zonas
                        weight: 1,
                        fillColor: '#0984e3',   // Un azul que se mezcla con el rojo de fondo
                        fillOpacity: 0.1        // Muy transparente
                    },
                    onEachFeature: function(feature, layer) {
                        // Al dar clic en un pol√≠gono espec√≠fico
                        layer.on('click', function(e) {
                            L.DomEvent.stopPropagation(e); // Que no dispare el clic del mapa
                            mostrarDiagnostico(e.latlng, feature.properties);
                        });
                    }
                }).addTo(map);
            })
            .catch(err => console.error("Error cargando zonificaci√≥n:", err));


        // =====================================================
        // 4. L√ìGICA DE DIAGN√ìSTICO (POPUPS)
        // =====================================================

        function mostrarDiagnostico(latlng, data) {
            var html = "";
            var esSueloConservacion = false;

            // 1. Si data viene del clic en la capa Zonificaci√≥n
            if (data && (data.ZONA || data.DESCRIPCIO || data.TIPO)) {
                esSueloConservacion = true;
                // Buscar el nombre de la zona en tus atributos
                var nombreZona = data.ZONA || data.DESCRIPCIO || data.TIPO || "Zona Regulada";
                var uga = data.UGA || data.CLAVE || "S/D";
                var reglas = obtenerReglas(nombreZona);

                // Armar HTML del Popup
                var listaProhibido = reglas.prohibido.map(i => `<li>${i}</li>`).join("");
                var listaPermitido = reglas.permitido.map(i => `<li>${i}</li>`).join("");

                html = `
                    <div class="popup-container">
                        <div class="popup-header warning">
                            üö´ SUELO DE CONSERVACI√ìN
                        </div>
                        <div class="popup-body">
                            <h4 class="zone-title">${nombreZona}</h4>
                            <span class="badge">UGA: ${uga}</span>
                            <p class="zone-desc">${reglas.desc}</p>
                            
                            <div class="rules-box no">
                                <strong>PROHIBIDO (Delito):</strong>
                                <ul>${listaProhibido}</ul>
                            </div>
                            <div class="rules-box yes">
                                <strong>PERMITIDO:</strong>
                                <ul>${listaPermitido}</ul>
                            </div>
                            <div class="legal-note">Fuente: PGOEDF 2000</div>
                        </div>
                    </div>
                `;
            } 
            // 2. Si es un punto gen√©rico (ej. GPS o B√∫squeda), verificamos con PIP
            else {
                // Verificar geom√©tricamente si cae en la capa Zonificaci√≥n
                var found = false;
                if (layerZoni) {
                    var results = leafletPip.pointInLayer(latlng, layerZoni);
                    if (results.length > 0) {
                        // ¬°Encontramos el pol√≠gono! Re-ejecutamos con los datos correctos
                        mostrarDiagnostico(latlng, results[0].feature.properties);
                        return;
                    }
                }

                // Si no cae en ninguna capa -> Es Suelo Urbano
                html = `
                    <div class="popup-container">
                        <div class="popup-header safe">
                            ‚úÖ SUELO URBANO
                        </div>
                        <div class="popup-body">
                            <p>Esta ubicaci√≥n se encuentra fuera de la zonificaci√≥n de conservaci√≥n ecol√≥gica registrada.</p>
                            <small>Verifica el uso habitacional en SEDUVI.</small>
                        </div>
                    </div>
                `;
            }

            // Mostrar el Popup
            L.popup({maxWidth: 320})
                .setLatLng(latlng)
                .setContent(html)
                .openOn(map);
        }

        // Clic en el mapa (para zonas donde no hay pol√≠gonos)
        map.on('click', function(e) {
            mostrarDiagnostico(e.latlng, null);
        });

        // =====================================================
        // 5. GPS
        // =====================================================
        document.getElementById('btn-gps').addEventListener('click', function() {
            var btn = this;
            btn.innerHTML = "‚åõ";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });

        map.on('locationfound', function(e) {
            document.getElementById('btn-gps').innerHTML = "üìç";
            // Marcador de usuario
            L.circleMarker(e.latlng, {
                radius: 8, fillColor: "#2980b9", color: "white", weight: 2, fillOpacity: 1
            }).addTo(map);
            // Lanzar diagn√≥stico
            mostrarDiagnostico(e.latlng, null);
        });

        map.on('locationerror', function() {
            alert("No pudimos acceder a tu ubicaci√≥n. Revisa los permisos.");
            document.getElementById('btn-gps').innerHTML = "üìç";
        });

    </script>
</body>
</html>
