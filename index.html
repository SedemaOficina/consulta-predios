<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor de Consulta Ciudadana | SEDEMA</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="styles.css">

    <!-- JS Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Iconos Lucide -->
    <script src="https://unpkg.com/lucide@latest"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- SIDEBAR: Controles y Resultados -->
    <div id="sidebar" class="w-full md:w-[450px] bg-white shadow-xl z-20 flex flex-col h-[50vh] md:h-full overflow-hidden border-r border-gray-200 print:w-full print:h-auto print:shadow-none print:border-none">
        
        <!-- Header -->
        <header class="p-6 bg-[#9d2449] text-white shrink-0 shadow-md z-10 relative overflow-hidden print:bg-white print:text-black print:p-0 print:border-b-2 print:border-[#9d2449] print:mb-2">
            <div class="flex items-center gap-4 mb-2 relative z-10">
                <div class="w-14 h-14 bg-white rounded-lg flex items-center justify-center p-1 shadow-sm shrink-0 print:hidden">
                     <img src="logo-sedema.png" alt="CDMX" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-[#9d2449] font-bold text-xl\'>CDMX</span>'">
                </div>
                <!-- Logo para Impresión -->
                <img src="logo-sedema.png" alt="CDMX" class="hidden print:block w-16 h-16 object-contain mr-4">
                
                <div>
                    <h1 class="text-xl font-bold leading-tight font-serif tracking-tight text-white print:text-black print:text-lg">VISOR DE CONSULTA CIUDADANA</h1>
                    <p class="text-[10px] text-[#e0e0e0] uppercase tracking-wider font-medium mt-1 print:text-gray-600">Secretaría del Medio Ambiente CDMX</p>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar print:overflow-visible print:p-0">
            
            <!-- Loading State -->
            <div id="loading-screen" class="flex flex-col items-center justify-center h-40">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-[#9d2449]"></div>
                <p class="text-sm text-gray-500 mt-3 font-medium">Cargando datos geográficos...</p>
            </div>

            <!-- Search Controls (Hidden on Print) -->
            <div id="search-controls" class="space-y-4 no-print hidden border-b border-gray-100 pb-6">
                
                <!-- Coordinates -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Coordenadas</label>
                    <div class="relative">
                        <input type="text" id="coord-input" placeholder="Ej. 19.4326, -99.1332" class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#9d2449] focus:border-transparent text-sm">
                        <div class="absolute left-3 top-2.5 text-gray-400 font-mono text-xs font-bold">XY</div>
                    </div>
                </div>

                <!-- Address -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Dirección</label>
                    <div class="relative flex gap-2">
                        <div class="relative flex-1">
                            <input type="text" id="addr-input" placeholder="Calle, Colonia, Alcaldía..." class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#9d2449] focus:border-transparent text-sm">
                            <i data-lucide="map-pin" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i>
                        </div>
                        <button onclick="searchAddress()" class="px-3 bg-gray-100 hover:bg-gray-200 rounded-lg border border-gray-300 text-gray-600 transition-colors">
                            <i data-lucide="search" class="h-4 w-4"></i>
                        </button>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="flex gap-2 pt-1">
                    <button onclick="detectLocation()" class="flex-1 py-2 px-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2 text-sm shadow-sm">
                        <i data-lucide="navigation" class="h-4 w-4"></i>
                        Detectar mi ubicación
                    </button>
                    <button onclick="resetApp()" title="Reiniciar" class="px-3 bg-gray-100 text-gray-600 border border-gray-300 rounded-lg hover:bg-white hover:text-[#9d2449] hover:border-[#9d2449] transition-all">
                        <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                    </button>
                </div>
                
                <p class="text-[10px] text-gray-400 flex gap-1 items-start mt-2">
                    <i data-lucide="info" class="h-3 w-3 mt-0.5 shrink-0"></i>
                    <span>Puede hacer clic sobre el mapa para consultar un predio.</span>
                </p>
            </div>

            <!-- Empty State -->
            <div id="empty-state" class="hidden flex-col items-center justify-center h-48 text-center text-gray-400 no-print">
                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="map" class="h-8 w-8 text-gray-300"></i>
                </div>
                <p class="text-sm font-medium text-gray-500">Sin ubicación seleccionada</p>
                <p class="text-xs mt-1 max-w-[200px]">Seleccione un punto, busque una coordenada o dirección para iniciar.</p>
            </div>

            <!-- Results Container -->
            <div id="results-container" class="hidden space-y-6 animate-fade-in pb-10 print:pb-0 print:space-y-4">
                <!-- Content injected via JS -->
            </div>

        </div>

        <!-- Footer Actions (Hidden on Print) -->
        <div id="footer-actions" class="p-4 border-t border-gray-200 bg-gray-50 no-print hidden">
            <div class="flex gap-3 mb-4">
                <button onclick="window.print()" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-[#9d2449] hover:border-[#9d2449] font-medium text-sm transition-all shadow-sm">
                    <i data-lucide="printer" class="h-4 w-4"></i> Imprimir
                </button>
                <button onclick="shareResult()" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-[#25D366] text-white rounded-lg hover:bg-[#20bd5a] font-medium text-sm transition-all shadow-sm">
                    <i data-lucide="share-2" class="h-4 w-4"></i> WhatsApp
                </button>
            </div>
            <p class="text-[9px] text-gray-400 text-justify leading-tight disclaimer-text"></p>
        </div>

        <!-- Print Footer -->
        <div class="print-only hidden p-4 border-t border-gray-300 mt-auto">
            <p class="text-[10px] text-gray-500 text-justify font-serif disclaimer-text leading-tight"></p>
            <div class="flex justify-between items-end mt-2">
               <p class="text-[9px] text-gray-400">Generado por Visor de Consulta Ciudadana SEDEMA.</p>
               <div class="w-16 h-8 border border-gray-300"></div> 
            </div>
         </div>
    </div>

    <!-- MAP CONTAINER -->
    <div class="flex-1 relative bg-gray-200 h-[50vh] md:h-full print:h-[300px] print:w-full print:border print:border-gray-300 print:mb-4">
        <div id="map" class="h-full w-full z-10"></div>
        
        <!-- Legend Overlay (No Print) -->
        <div class="absolute bottom-6 left-6 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-200 z-[400] text-xs space-y-2 pointer-events-none select-none no-print">
            <h4 class="font-bold text-[#9d2449] mb-1 font-serif border-b border-gray-100 pb-1">Simbología</h4>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-[#16a34a] border border-white shadow-sm"></span>
                <span>Suelo Urbano (Permitido)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-[#dc2626] border border-white shadow-sm"></span>
                <span>Suelo de Conservación (Restringido)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-4 h-0 border-t-2 border-dashed border-[#3b82f6]"></span>
                <span>Zonificación (Clic para detalle)</span>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-100 text-[10px] text-gray-500 italic">
                * Capas activas. Clic en polígono para más datos.
            </div>
        </div>
    </div>

    <!-- LOGIC -->
    <script>
        // --- CONSTANTS ---
        const DATA_FILES = {
            LIMITES_CDMX: 'limites_cdmx.geojson',
            LIMITES_ALCALDIAS: 'limites_alcaldias.geojson',
            LIMITES_EDOMEX: 'limites_edomex.geojson',
            LIMITES_MORELOS: 'limites_morelos.geojson',
            SUELO_CONSERVACION: 'suelo-de-conservacion-2020.geojson',
            ZONIFICACION: 'zoonificación_pgoedf_2000.geojson',
            USOS_SUELO_CSV: 'usos_suelo.csv'
        };
        const DISCLAIMER = "Esta plataforma es una versión de divulgación e información. Los resultados emitidos no producen efectos jurídicos vinculantes. Para trámites oficiales, consulte a la autoridad competente.";
        const NOTES = [
            "Adicionalmente a lo dispuesto en la tabla de usos del suelo, para cualquier obra o actividad que se pretenda desarrollar se deberán contemplar los criterios y lineamientos señalados en el programa de Ordenamiento Ecológico.",
            "Los usos del suelo no identificados en esta tabla deberán cumplir con los permisos y autorizaciones en materia urbana y ambiental aplicables en Suelo de Conservación.",
            "En las Areas Naturales Protegidas ANP regirá la zonificación especificada en su respectivo Programa de Manejo.",
            "El Suelo de Conservación definido por las barrancas estará regulado por la zonificación Forestal de Conservación FC.",
            "Las disposiciones de la presente regulación no prejuzgan sobre la propiedad de la tierra."
        ];
        
        // Colors for Zoning Categories
        const ZONE_COLORS = {
            'AE': '#84cc16',   // Agroecológico (Lime)
            'AEE': '#65a30d',  // Agroecológico Especial
            'AF': '#10b981',   // Agroforestal (Emerald)
            'AFE': '#059669',  // Agroforestal Especial
            'FC': '#15803d',   // Forestal Conservación (Green)
            'FCE': '#166534',  // Forestal Cons. Esp
            'FP': '#14532d',   // Forestal Protección (Dark Green)
            'FPE': '#064e3b',  // Forestal Prot. Esp
            'ANP': '#0e7490',  // ANP (Cyan)
            'PDU': '#6b7280',  // PDU (Gray)
            'DEFAULT': '#3b82f6' // Blue default
        };

        // --- STATE ---
        let map, marker, layers = {};
        let loadedData = {};
        let currentAnalysis = null;
        let baseLayers = {};

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.disclaimer-text').forEach(el => el.textContent = DISCLAIMER);
            
            // Setup Inputs
            document.getElementById('coord-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') parseAndSearchCoords(e.target.value);
            });
            document.getElementById('addr-input').addEventListener('keypress', (e) => {
                if(e.key === 'Enter') searchAddress();
            });

            // Icons
            lucide.createIcons();
            
            // Print Events to toggle Satellite
            window.addEventListener('beforeprint', () => {
                if(baseLayers.satellite) baseLayers.satellite.addTo(map);
                map.invalidateSize();
            });
            window.addEventListener('afterprint', () => {
                if(baseLayers.light) baseLayers.light.addTo(map);
                map.invalidateSize();
            });
            
            // Load Data
            loadAllData();
        });

        // --- DATA LOADING ---
        async function loadAllData() {
            try {
                const fetchJson = async (url) => {
                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error();
                        return await res.json();
                    } catch { return { type: "FeatureCollection", features: [] }; }
                };

                const fetchCsv = (url) => new Promise((resolve) => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: () => resolve([])
                    });
                });

                const [cdmx, alcaldias, edomex, morelos, sc, zoning, rules] = await Promise.all([
                    fetchJson(DATA_FILES.LIMITES_CDMX),
                    fetchJson(DATA_FILES.LIMITES_ALCALDIAS),
                    fetchJson(DATA_FILES.LIMITES_EDOMEX),
                    fetchJson(DATA_FILES.LIMITES_MORELOS),
                    fetchJson(DATA_FILES.SUELO_CONSERVACION),
                    fetchJson(DATA_FILES.ZONIFICACION),
                    fetchCsv(DATA_FILES.USOS_SUELO_CSV)
                ]);

                loadedData = { cdmx, alcaldias, edomex, morelos, sc, zoning, rules };
                
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('search-controls').classList.remove('hidden');
                document.getElementById('empty-state').classList.remove('hidden'); // Show empty state initially
                document.getElementById('footer-actions').classList.remove('hidden');

                initMap();

            } catch (error) {
                alert("Error cargando datos: " + error.message);
            }
        }

        // --- MAP LOGIC ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 11);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // Base Layers
            baseLayers.light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: 'OpenStreetMap, CARTO',
                maxZoom: 20
            }).addTo(map);
            
            baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri, Maxar, Earthstar Geographics',
                maxZoom: 19
            });

            const overlayMaps = {};

            // 1. Context Layers
            if (loadedData.edomex.features.length) {
                const edomex = L.geoJSON(loadedData.edomex, { style: { color: '#9ca3af', dashArray: '4,4', fill: false }, interactive: false }).addTo(map);
                overlayMaps["Edo. Mex"] = edomex;
            }
            if (loadedData.morelos.features.length) {
                const morelos = L.geoJSON(loadedData.morelos, { style: { color: '#9ca3af', dashArray: '4,4', fill: false }, interactive: false }).addTo(map);
                overlayMaps["Morelos"] = morelos;
            }

            // 2. CDMX
            if (loadedData.cdmx.features.length) {
                overlayMaps["Límite CDMX"] = L.geoJSON(loadedData.cdmx, { style: { color: '#54565a', weight: 2, fill: false }, interactive: false }).addTo(map);
            }

            // 3. Suelo de Conservación
            if (loadedData.sc.features.length) {
                overlayMaps["Suelo Conservación"] = L.geoJSON(loadedData.sc, {
                    style: { color: '#9d2449', weight: 1, fillColor: '#9d2449', fillOpacity: 0.1 },
                    interactive: false
                }).addTo(map);
            }

            // 4. Zonificación (INTERACTIVA & COLOREADA)
            if (loadedData.zoning.features.length) {
                const zLayer = L.geoJSON(loadedData.zoning, {
                    style: (feature) => {
                        const key = feature.properties.CLAVE || 'DEFAULT';
                        const color = ZONE_COLORS[key] || ZONE_COLORS.DEFAULT;
                        return { 
                            color: color, 
                            weight: 1, 
                            dashArray: '2,2', 
                            fillColor: color,
                            fillOpacity: 0.15 // Slight fill for aesthetics
                        };
                    },
                    interactive: true,
                    onEachFeature: (feature, layer) => {
                        const name = feature.properties.PGOEDF || feature.properties.UGA || feature.properties.CLAVE;
                        if (name) layer.bindTooltip(name, { sticky: true, className: 'bg-white px-1 border border-gray-200 text-[10px]' });
                        
                        layer.on('click', (e) => {
                            L.DomEvent.stop(e); 
                            analyzeLocation(e.latlng.lat, e.latlng.lng);
                        });
                    }
                }).addTo(map); // Active by default
                overlayMaps["Zonificación"] = zLayer;
            }

            // 5. Alcaldías
            if (loadedData.alcaldias.features.length) {
                overlayMaps["Alcaldías"] = L.geoJSON(loadedData.alcaldias, {
                    style: { color: '#6b7280', weight: 1, dashArray: '5,5', fill: false },
                    interactive: false,
                    onEachFeature: (f, l) => {
                        if (f.properties.NOMBRE) l.bindTooltip(f.properties.NOMBRE, { direction: 'center', permanent: false, className: 'bg-white/80 px-1 rounded border border-gray-200 text-xs text-gray-500' });
                    }
                }).addTo(map);
            }

            L.control.layers(
                { "Mapa Base": baseLayers.light, "Satélite": baseLayers.satellite }, 
                overlayMaps, 
                { collapsed: true }
            ).addTo(map);

            // Controls
            addResetControl();

            // Map Click
            map.on('click', (e) => {
                analyzeLocation(e.latlng.lat, e.latlng.lng);
            });
        }

        function addResetControl() {
            const btn = L.control({ position: 'topleft' });
            btn.onAdd = () => {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = `<button onclick="resetApp()" style="background:white; width:30px; height:30px; display:flex; align-items:center; justify-content:center; cursor:pointer;" title="Reiniciar">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9d2449" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>`;
                return div;
            };
            btn.addTo(map);
        }

        // --- ANALYSIS LOGIC ---
        function analyzeLocation(lat, lng) {
            const point = { lat, lng };
            const result = {
                status: 'LOADING',
                isRestricted: false,
                coordinate: point,
                allowedActivities: [],
                conditionedActivities: [],
                prohibitedActivities: [],
                hasHumanSettlementAlert: false, // Flag for highlighting
                timestamp: new Date().toLocaleString()
            };

            // 1. Jurisdiction
            const inCDMX = findFeature(point, loadedData.cdmx);
            if (!inCDMX) {
                result.status = 'OUTSIDE_CDMX';
                const inEdo = findFeature(point, loadedData.edomex);
                const inMor = findFeature(point, loadedData.morelos);
                result.outsideContext = inEdo ? "Estado de México" : (inMor ? "Morelos" : "");
                updateUI(result);
                return;
            }

            // 2. Alcaldía
            const alc = findFeature(point, loadedData.alcaldias);
            result.alcaldia = alc ? (alc.properties.NOMBRE || alc.properties.NOMGEO) : "No identificada";

            // 3. Suelo de Conservación
            const inSC = findFeature(point, loadedData.sc);
            if (!inSC) {
                result.status = 'URBAN_SOIL';
                updateUI(result);
                return;
            }

            // 4. Restricted
            result.status = 'CONSERVATION_SOIL';
            result.isRestricted = true;

            // 5. Zoning & Rules
            const zoning = findFeature(point, loadedData.zoning);
            if (zoning) {
                result.zoningKey = zoning.properties.CLAVE;
                result.zoningName = zoning.properties.PGOEDF || zoning.properties.UGA;

                if (result.zoningKey && loadedData.rules) {
                    loadedData.rules.forEach(row => {
                        const val = (row[result.zoningKey] || '').trim().toUpperCase();
                        const act = `${row.SECTOR} - ${row.ACTIVIDAD_GENERAL}: ${row.ACTIVIDAD_ESPECIFICA}`;
                        
                        // Check specifically for Human Settlements to highlight
                        if (row.ACTIVIDAD_ESPECIFICA && row.ACTIVIDAD_ESPECIFICA.includes("Nuevos Asentamientos Humanos")) {
                            if (val === 'A' || val === 'C' || val === 'P') {
                                result.hasHumanSettlementAlert = true; // Use this to trigger specific UI logic
                            }
                        }

                        if (val === 'A') result.allowedActivities.push(act);
                        else if (val === 'C') result.conditionedActivities.push(act);
                        else if (val === 'P') result.prohibitedActivities.push(act);
                    });
                }
            } else {
                result.zoningName = "Sin zonificación específica";
                result.zoningKey = inSC.properties.CLAVE;
            }

            updateUI(result);
        }

        function updateUI(result) {
            currentAnalysis = result;
            
            // Map Marker
            if (marker) map.removeLayer(marker);
            let color = '#3b82f6';
            if (result.status === 'CONSERVATION_SOIL') color = '#dc2626';
            if (result.status === 'URBAN_SOIL') color = '#16a34a';
            if (result.status === 'OUTSIDE_CDMX') color = '#6b7280';

            marker = L.circleMarker([result.coordinate.lat, result.coordinate.lng], {
                radius: 12, fillColor: color, color: '#fff', weight: 3, fillOpacity: 0.9
            }).addTo(map);

            map.setView([result.coordinate.lat, result.coordinate.lng], 16);

            // Sidebar
            const container = document.getElementById('results-container');
            document.getElementById('empty-state').classList.add('hidden');
            container.classList.remove('hidden');

            // Construct HTML
            let statusHtml = '';
            if (result.status === 'CONSERVATION_SOIL') {
                statusHtml = `
                <div class="bg-red-50 border-l-8 border-red-700 p-4 rounded-lg shadow-sm print:border-l-4 print:p-2">
                    <div class="flex gap-3">
                        <i data-lucide="alert-triangle" class="text-red-700 h-6 w-6 mt-1 shrink-0 print:h-4 print:w-4"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase text-red-800 print:text-sm">Zona Restringida</h2>
                            <p class="text-sm mt-1 text-gray-800 print:text-xs">Predio en Suelo de Conservación. Aplican restricciones ambientales.</p>
                        </div>
                    </div>
                </div>`;
            } else if (result.status === 'URBAN_SOIL') {
                statusHtml = `
                <div class="bg-green-50 border-l-8 border-green-600 p-4 rounded-lg shadow-sm print:border-l-4 print:p-2">
                    <div class="flex gap-3">
                        <i data-lucide="check-circle" class="text-green-700 h-6 w-6 mt-1 shrink-0 print:h-4 print:w-4"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase text-green-800 print:text-sm">Suelo Urbano</h2>
                            <p class="text-sm mt-1 text-gray-800 print:text-xs">Fuera de la capa de conservación. Consulte SEDUVI.</p>
                        </div>
                    </div>
                </div>`;
            } else {
                statusHtml = `
                <div class="bg-gray-100 border-l-8 border-gray-400 p-4 rounded-lg shadow-sm print:border-l-4 print:p-2">
                    <div class="flex gap-3">
                        <i data-lucide="x-circle" class="text-gray-600 h-6 w-6 mt-1 shrink-0 print:h-4 print:w-4"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase text-gray-800 print:text-sm">Fuera de Jurisdicción</h2>
                            <p class="text-sm mt-1 text-gray-800 print:text-xs">Punto fuera de CDMX. ${result.outsideContext || ''}</p>
                        </div>
                    </div>
                </div>`;
            }

            let detailsHtml = `
                <div class="grid grid-cols-2 gap-4 text-sm print:gap-2 print:text-xs print:my-2">
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 print:p-1">
                        <span class="block text-[10px] uppercase font-bold text-gray-500">Alcaldía</span>
                        <span class="font-semibold">${result.alcaldia || '-'}</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200 print:p-1">
                         <span class="block text-[10px] uppercase font-bold text-gray-500">Coordenadas</span>
                         <span class="font-mono text-xs">${result.coordinate.lat.toFixed(5)}, ${result.coordinate.lng.toFixed(5)}</span>
                    </div>
                    ${result.zoningKey ? `
                    <div class="col-span-2 bg-gray-50 p-3 rounded border border-gray-200 print:p-1">
                        <span class="block text-[10px] uppercase font-bold text-gray-500">Zonificación</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="bg-[${ZONE_COLORS[result.zoningKey] || ZONE_COLORS.DEFAULT}] text-white px-2 py-0.5 rounded text-xs font-bold print:border print:border-black print:text-black print:bg-white">${result.zoningKey}</span>
                            <span class="font-semibold">${result.zoningName}</span>
                        </div>
                    </div>` : ''}
                </div>`;

            let accordionHtml = '';
            if (result.status === 'CONSERVATION_SOIL') {
                const createSection = (title, list, color, icon, open=false) => {
                    if (!list.length) return '';
                    
                    // Logic to extract and highlight "Nuevos Asentamientos Humanos"
                    let highlightedItem = null;
                    const filteredList = list.filter(item => {
                        if (item.includes("Nuevos Asentamientos Humanos")) {
                            highlightedItem = item;
                            return false;
                        }
                        return true;
                    });
                    
                    // Re-insert at the top with special styling if found
                    const displayList = highlightedItem ? [highlightedItem, ...filteredList] : filteredList;

                    let bgH = color === 'green' ? 'bg-green-200/60 text-green-900' : (color === 'amber' ? 'bg-amber-200/60 text-amber-900' : 'bg-red-200/60 text-red-900');
                    let bgB = color === 'green' ? 'bg-green-50/50' : (color === 'amber' ? 'bg-amber-50/50' : 'bg-red-50/50');
                    
                    return `
                    <details class="group rounded-lg border border-gray-200 overflow-hidden mb-3 shadow-sm ${bgB} print:border-black print:mb-2" ${open ? 'open' : ''}>
                        <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none ${bgH} hover:opacity-90 print:p-1 print:bg-gray-200 print:text-black">
                            <div class="flex items-center gap-2 font-bold text-sm">
                                <i data-lucide="${icon}" class="h-4 w-4 print:hidden"></i>
                                <span>${title} <span class="text-xs font-normal opacity-90">(${list.length})</span></span>
                            </div>
                            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform group-open:rotate-180 print:hidden"></i>
                        </summary>
                        <div class="px-4 py-3 bg-white border-t border-gray-100 print:p-1">
                            <ul class="list-disc pl-5 text-xs text-gray-600 space-y-2 max-h-60 overflow-y-auto custom-scrollbar print:max-h-none print:overflow-visible print:space-y-1">
                                ${displayList.map(item => {
                                    // Special styling for the settlement activity
                                    if(item.includes("Nuevos Asentamientos Humanos")) {
                                        return `<li class="font-bold text-red-700 bg-red-50 p-1 rounded border border-red-200 print:border-black print:text-black print:font-bold">${item.toUpperCase()} (REVISE NORMATIVIDAD)</li>`;
                                    }
                                    return `<li>${item}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                    </details>`;
                };

                accordionHtml = `
                    <div class="pt-2">
                        <h3 class="text-sm font-bold text-gray-800 mb-3 border-b pb-1 print:mb-1 print:text-xs">Regulación de Uso de Suelo</h3>
                        ${createSection('PERMITIDAS', result.allowedActivities, 'green', 'check-circle', true)}
                        ${createSection('CONDICIONADAS', result.conditionedActivities, 'amber', 'alert-circle', true)} 
                        ${createSection('PROHIBIDAS', result.prohibitedActivities, 'red', 'x-circle', false)}
                    </div>
                `;
            }

            let notesHtml = `
                <div class="mt-6 border-t border-gray-200 pt-4 print:mt-2 print:pt-2">
                    <h4 class="text-xs font-bold text-[#9d2449] uppercase mb-2 print:text-[10px]">Notas Importantes</h4>
                    <ul class="list-disc pl-4 space-y-2 print:space-y-1">
                        ${NOTES.map(n => `<li class="text-[10px] text-gray-600 text-justify print:text-[8px]">${n}</li>`).join('')}
                    </ul>
                </div>
                <div class="text-right text-[10px] text-gray-400 border-t border-gray-100 pt-3 mt-4 print:text-[8px] print:mt-2 print:pt-1">
                    Folio: ${Date.now().toString().slice(-6)} <br> Fecha: ${result.timestamp}
                </div>
            `;

            container.innerHTML = statusHtml + detailsHtml + accordionHtml + notesHtml;
            lucide.createIcons();

            // Mobile Scroll
            if (window.innerWidth < 768) {
                document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // --- UTILS ---
        function resetApp() {
            currentAnalysis = null;
            if (marker) map.removeLayer(marker);
            map.setView([19.4326, -99.1332], 11);
            document.getElementById('coord-input').value = '';
            document.getElementById('addr-input').value = '';
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
        }

        function parseAndSearchCoords(input) {
            const text = input.trim();
            // Regex logic similar to previous steps
            const decimalMatch = text.match(/([-+]?\d{1,3}\.\d+)[,;\s]+([-+]?\d{1,3}\.\d+)/);
            if (decimalMatch) {
                let v1 = parseFloat(decimalMatch[1]), v2 = parseFloat(decimalMatch[2]);
                if (v1 < -80 && v2 > 14) { analyzeLocation(v2, v1); return; } // Lng, Lat
                analyzeLocation(v1, v2);
                return;
            }
            alert("Formato no reconocido. Use Decimales (19.43, -99.13)");
        }

        async function searchAddress() {
            const q = document.getElementById('addr-input').value;
            if(!q) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q + ', Ciudad de México')}&limit=1`);
                const data = await res.json();
                if(data.length) analyzeLocation(parseFloat(data[0].lat), parseFloat(data[0].lon));
                else alert("Dirección no encontrada");
            } catch { alert("Error buscando dirección"); }
        }

        function detectLocation() {
            if(!navigator.geolocation) return alert("Geolocalización no soportada");
            navigator.geolocation.getCurrentPosition(
                pos => analyzeLocation(pos.coords.latitude, pos.coords.longitude),
                err => alert("Error obteniendo ubicación: " + err.message)
            );
        }

        function shareResult() {
            if(!currentAnalysis) return;
            const text = `Consulta SEDEMA: ${currentAnalysis.isRestricted ? 'ZONA RESTRINGIDA' : 'SUELO URBANO'}. Coords: ${currentAnalysis.coordinate.lat.toFixed(5)}, ${currentAnalysis.coordinate.lng.toFixed(5)}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- GIS UTILS (Point in Polygon) ---
        function findFeature(point, collection) {
            if (!collection || !collection.features) return null;
            return collection.features.find(f => isPointInFeature(point, f));
        }

        function isPointInFeature(point, feature) {
            const { lat, lng } = point;
            const geom = feature.geometry;
            const checkPoly = (ring) => {
                let inside = false;
                for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                    const xi = ring[i][0], yi = ring[i][1];
                    const xj = ring[j][0], yj = ring[j][1];
                    const intersect = ((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            };
            if (geom.type === 'Polygon') return checkPoly(geom.coordinates[0]);
            if (geom.type === 'MultiPolygon') return geom.coordinates.some(poly => checkPoly(poly[0]));
            return false;
        }

    </script>
</body>
</html>
