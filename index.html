<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css">
    
    <!-- LIBRER√çAS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
</head>
<body>

    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
        <div class="header-text">
            <h1>SISTEMA DE INFORMACI√ìN GEOGR√ÅFICA</h1>
            <h2>Vigilancia y Ordenamiento Ecol√≥gico</h2>
        </div>
    </header>

    <div class="main-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta Ciudadana</h3>
                <p>Valida la situaci√≥n legal y ambiental del predio.</p>
            </div>

            <div class="sidebar-body">
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">üìç UBICARME EN EL SITIO</button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O B√öSQUEDA MANUAL</span></div>

                <div class="control-group">
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">BUSCAR</button>
                    </div>
                </div>

                <!-- RESULTADOS -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <div class="res-status-bar" id="res-status-bar">...</div>
                    
                    <div class="res-content">
                        <div id="bloque-ubicacion">
                            <label>Ubicaci√≥n Administrativa:</label>
                            <p id="res-alcaldia" class="res-value">CDMX</p>
                        </div>

                        <label>Diagn√≥stico Ambiental:</label>
                        <p id="res-zona" class="res-value highlight">...</p>
                        
                        <div id="res-acciones-container" style="display:none;">
                            <button onclick="generarReporte()" class="btn-full btn-print">üìÑ GENERAR REPORTE PDF</button>
                            <button onclick="compartirWhatsapp()" class="btn-full btn-whats">üì± COMPARTIR</button>
                        </div>
                    </div>
                </div>

                <div class="leyenda-box">
                    <h4>Capas del Mapa</h4>
                    <div class="item"><span class="linea-negra"></span> L√≠mite CDMX</div>
                    <div class="item"><span class="rect rojo"></span> Suelo de Conservaci√≥n</div>
                    <div class="item"><span class="rect azul"></span> Zonificaci√≥n Normativa</div>
                    <div class="item"><span class="rect verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <!-- REPORTE -->
    <div id="reporte-impresion" class="print-only">
        <div class="report-header">
            <img src="logo-sedema.png" alt="Logo">
            <div><h2>FICHA T√âCNICA INFORMATIVA</h2><p>Ordenamiento Ecol√≥gico del D.F.</p></div>
        </div>
        <div class="report-meta">
            <p><strong>Fecha:</strong> <span id="print-fecha"></span></p>
            <p><strong>Ubicaci√≥n:</strong> <span id="print-alcaldia"></span></p>
            <p><strong>Coordenadas:</strong> <span id="print-coords"></span></p>
        </div>
        <div class="report-map-container" id="mapa-impresion-placeholder"></div>
        <div class="report-diagnosis">
            <h3 id="print-titulo-zona"></h3>
            <p id="print-desc-zona"></p>
            <div class="tables-container">
                <div class="tbl-box prohibido"><h4>üö´ PROHIBIDO</h4><ul id="print-lista-proh"></ul></div>
                <div class="tbl-box permitido"><h4>‚úÖ PERMITIDO</h4><ul id="print-lista-perm"></ul></div>
            </div>
        </div>
        <div class="report-footer">
            <p>Documento informativo sin validez jur√≠dica oficial. Fuente: PGOEDF.</p>
        </div>
    </div>

    <script>
        // 1. CARGA CSV
        let tablaUsos = [];
        let infoActual = null;
        let coordsActuales = null;

        Papa.parse("usos_suelo.csv", {
            download: true, header: true, encoding: "UTF-8", skipEmptyLines: true,
            complete: function(results) { tablaUsos = results.data; }
        });

        const catalogoZonas = { "FC": "Forestal de Conservaci√≥n", "FCE": "Forestal de Conservaci√≥n Especial", "FP": "Forestal de Protecci√≥n", "FPE": "Forestal de Protecci√≥n Especial", "AF": "Agroforestal", "AFE": "Agroforestal Especial", "AE": "Agroecol√≥gica", "AEE": "Agroecol√≥gica Especial", "ANP": "√Årea Natural Protegida", "PDU": "Poblado Rural" };
        const mapeoSHP = { "FORESTAL DE CONSERVACION": "FC", "AGROECOLOGICO": "AE", "PROTECCION": "FP", "PROGRAMAS": "PDU" };

        function obtenerReglasCSV(codigoZona) {
            let perm = [], proh = [];
            tablaUsos.forEach(fila => {
                if (fila[codigoZona]) {
                    let txt = `<strong>${fila.SECTOR}:</strong> ${fila.ACTIVIDAD_ESPECIFICA || fila.ACTIVIDAD_GENERAL}`;
                    if (fila[codigoZona].trim().toUpperCase() === 'A') perm.push(txt);
                    else if (fila[codigoZona].trim().toUpperCase() === 'P') proh.push(txt);
                }
            });
            return { perm, proh };
        }

        // 2. MAPA
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.13], 10);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var esriStreets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        map.addLayer(esriStreets);

        var layerControl = L.control.layers({ "Callejero": esriStreets, "Sat√©lite": satelite }, {}, { position: 'topright' }).addTo(map);

        // CAPAS GLOBALES
        var geojsonCDMX, geojsonAlcaldias, geojsonEdoMex, geojsonMorelos, geojsonSuelo, geojsonZoni;

        // 3. CARGA DE ARCHIVOS

        // A) L√çMITE CDMX (Negro Grueso - Atributo NOMGEO)
        fetch('limites_cdmx.geojson').then(r=>r.json()).then(data => {
            geojsonCDMX = L.geoJSON(data, {
                style: { color: '#000000', weight: 4, fill: false, opacity: 1 } 
            }).addTo(map);
            map.fitBounds(geojsonCDMX.getBounds());
            layerControl.addOverlay(geojsonCDMX, "L√≠mite CDMX");
        });

        // B) ALCALD√çAS (Punteado - Atributo NOMBRE)
        fetch('limites_alcaldias.geojson').then(r=>r.json()).then(data => {
            geojsonAlcaldias = L.geoJSON(data, {
                style: { color: '#444', weight: 1, fillOpacity: 0, dashArray: '4, 4' }
            }).addTo(map);
        });

        // C) VECINOS (EdoMex y Morelos - Fondo Gris - Sin Control)
        var estiloVecinos = { color: '#999', weight: 1, fillColor: '#ccc', fillOpacity: 0.3 };
        
        fetch('limites_edomex.geojson').then(r=>r.json()).then(data => {
            geojsonEdoMex = L.geoJSON(data, { style: estiloVecinos, interactive: false }).addTo(map);
        }).catch(()=>{}); // Si falla no pasa nada, es decorativo
        
        fetch('limites_morelos.geojson').then(r=>r.json()).then(data => {
            geojsonMorelos = L.geoJSON(data, { style: estiloVecinos, interactive: false }).addTo(map);
        }).catch(()=>{});

        // D) SUELO DE CONSERVACI√ìN
        fetch('suelo-de-conservacion-2020.geojson').then(r=>r.json()).then(data => {
            geojsonSuelo = L.geoJSON(data, {
                style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.15, weight: 0 },
                interactive: false
            }).addTo(map);
            layerControl.addOverlay(geojsonSuelo, "Suelo de Conservaci√≥n");
        });

        // E) ZONIFICACI√ìN
        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r=>r.json()).then(data => {
            geojsonZoni = L.geoJSON(data, {
                style: { color: '#2980b9', weight: 1, fillOpacity: 0.05 },
                onEachFeature: function(f, l) { l.on('click', e => { L.DomEvent.stopPropagation(e); analizarPunto(e.latlng); }); }
            }).addTo(map);
            layerControl.addOverlay(geojsonZoni, "Zonificaci√≥n PGOEDF");
        });

        fetch('anp.geojson').then(r=>r.json()).then(data => {
            var l = L.geoJSON(data, { style: { color: '#27ae60', fillOpacity: 0.3, weight: 1 } }).addTo(map);
            layerControl.addOverlay(l, "√Åreas Naturales Protegidas");
        }).catch(()=>{});

        // 4. L√ìGICA DE AN√ÅLISIS
        var pinActual;

        function analizarPunto(latlng) {
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);
            coordsActuales = latlng;

            if (!geojsonCDMX || !geojsonAlcaldias) { return; } // Esperar carga

            // UI Elements
            var panel = document.getElementById('panel-resultados');
            var statusBar = document.getElementById('res-status-bar');
            var txtAlcaldia = document.getElementById('res-alcaldia');
            var txtZona = document.getElementById('res-zona');
            var btnContainer = document.getElementById('res-acciones-container');
            panel.style.display = "block";

            // --- PASO 1: ¬øDENTRO DE CDMX? ---
            var hitsCDMX = leafletPip.pointInLayer(latlng, geojsonCDMX);
            
            if (hitsCDMX.length === 0) {
                // FUERA DE CDMX: Checamos vecinos
                var estado = "Fuera de Jurisdicci√≥n CDMX";
                if(geojsonEdoMex && leafletPip.pointInLayer(latlng, geojsonEdoMex).length > 0) estado = "Estado de M√©xico";
                if(geojsonMorelos && leafletPip.pointInLayer(latlng, geojsonMorelos).length > 0) estado = "Estado de Morelos";

                statusBar.innerText = "FUERA DE CDMX";
                statusBar.className = "res-status-bar neutral";
                txtAlcaldia.innerText = estado;
                txtZona.innerText = "La normativa de la SEDEMA no aplica en este territorio.";
                btnContainer.style.display = "none";
                
                pinActual.bindPopup(`<b>${estado}</b><br>Fuera de la Ciudad de M√©xico`).openPopup();
                infoActual = null;
                return;
            }

            // --- PASO 2: ¬øQU√â ALCALD√çA? ---
            var nombreAlcaldia = "CDMX";
            var hitsAlc = leafletPip.pointInLayer(latlng, geojsonAlcaldias);
            if (hitsAlc.length > 0) {
                // Leemos el atributo NOMBRE (seg√∫n tu tabla)
                nombreAlcaldia = hitsAlc[0].feature.properties.NOMBRE || "Alcald√≠a Desconocida";
            }
            txtAlcaldia.innerText = nombreAlcaldia;

            // --- PASO 3: SUELO DE CONSERVACI√ìN ---
            var hitsSuelo = [];
            if(geojsonSuelo) hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);

            if (hitsSuelo.length > 0) {
                // ZONA RESTRINGIDA
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var nombreZona = "Suelo de Conservaci√≥n";
                var codigo = "SC";
                var uga = "S/D";

                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    var raw = (p.PGOEDF || p.DESCRIPCIO || p.ZONA || "").toUpperCase().trim();
                    var c = (p.CLAVE || "").toUpperCase().trim();
                    uga = p.UGA || p.CLAVE || "S/D";

                    if (mapeoSHP[raw]) codigo = mapeoSHP[raw];
                    else if (catalogoZonas[c]) codigo = c;
                    else codigo = "PDU";

                    nombreZona = catalogoZonas[codigo] || raw;
                }

                var reglas = obtenerReglasCSV(codigo);
                infoActual = { nombre: nombreZona, alcaldia: nombreAlcaldia, codigo: codigo, uga: uga, reglas: reglas, tipo: "SC" };

                if (codigo === "PDU") {
                    statusBar.innerText = "‚ö†Ô∏è POBLADO RURAL";
                    statusBar.className = "res-status-bar warning";
                    txtZona.innerHTML = `${nombreZona}<br><small>Zona de Asentamiento Humano</small>`;
                } else {
                    statusBar.innerText = "üö´ ZONA RESTRINGIDA";
                    statusBar.className = "res-status-bar danger";
                    txtZona.innerHTML = `${nombreZona}<br><small>UGA: ${uga} | Clave: ${codigo}</small>`;
                }
                
                btnContainer.style.display = "block";
                pinActual.bindPopup(`<div style='text-align:center; color:#C0392B'><b>${statusBar.innerText}</b><br>${nombreZona}</div>`).openPopup();

            } else {
                // SUELO URBANO
                infoActual = { nombre: "Suelo Urbano", alcaldia: nombreAlcaldia, codigo: "URB", reglas: {perm:[], proh:[]}, tipo: "URB" };
                
                statusBar.innerText = "‚úÖ SUELO URBANO";
                statusBar.className = "res-status-bar success";
                txtZona.innerText = "Ubicaci√≥n fuera del Suelo de Conservaci√≥n.";
                btnContainer.style.display = "block";
                
                pinActual.bindPopup(`<div style='text-align:center; color:#27ae60'><b>‚úÖ SUELO URBANO</b><br>Regulado por SEDUVI</div>`).openPopup();
            }
        }

        // FUNCIONES EXTRAS
        function generarReporte() {
            if (!infoActual) return;
            document.getElementById('print-fecha').innerText = new Date().toLocaleString();
            document.getElementById('print-coords').innerText = `${coordsActuales.lat.toFixed(5)}, ${coordsActuales.lng.toFixed(5)}`;
            document.getElementById('print-alcaldia').innerText = infoActual.alcaldia;
            document.getElementById('print-titulo-zona').innerText = infoActual.nombre;
            document.getElementById('print-dir').innerText = document.getElementById('input-busqueda').value || "Ubicaci√≥n en mapa";

            document.getElementById('print-desc-zona').innerText = infoActual.tipo === "URB" 
                ? "Esta ubicaci√≥n se encuentra en Suelo Urbano. No aplica la normatividad del PGOEDF."
                : `Ubicaci√≥n dentro del Suelo de Conservaci√≥n. Regulaci√≥n: ${infoActual.codigo} (UGA ${infoActual.uga}).`;

            var ulProh = document.getElementById('print-lista-proh');
            var ulPerm = document.getElementById('print-lista-perm');
            ulProh.innerHTML = ""; ulPerm.innerHTML = "";

            if (infoActual.tipo === "URB") {
                ulPerm.innerHTML = "<li>Uso habitacional (Sujeto a Zonificaci√≥n SEDUVI)</li>";
                ulProh.innerHTML = "<li>N/A (Verificar restricciones urbanas)</li>";
            } else {
                if(infoActual.reglas.proh.length > 0) infoActual.reglas.proh.forEach(x => { var li=document.createElement('li'); li.innerHTML=x; ulProh.appendChild(li); });
                else ulProh.innerHTML = "<li>Verificar Tabla General PGOEDF</li>";

                if(infoActual.reglas.perm.length > 0) infoActual.reglas.perm.forEach(x => { var li=document.createElement('li'); li.innerHTML=x; ulPerm.appendChild(li); });
                else ulPerm.innerHTML = "<li>Verificar Tabla General PGOEDF</li>";
            }
            window.print();
        }

        function compartirWhatsapp() {
            if(!infoActual) return;
            let msg = `Consulta SEDEMA:\nUbicaci√≥n: ${infoActual.alcaldia}\nEstatus: ${infoActual.nombre}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        document.getElementById('btn-gps').addEventListener('click', () => { map.locate({setView:true, maxZoom:18}); });
        map.on('locationfound', e => analizarPunto(e.latlng));
        document.getElementById('btn-buscar').addEventListener('click', () => {
            let val = document.getElementById('input-busqueda').value;
            let match = val.match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);
            if(match) analizarPunto([parseFloat(match[1]), parseFloat(match[3])]);
            else fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}+CDMX&limit=1`).then(r=>r.json()).then(d=>{ if(d.length) analizarPunto([d[0].lat, d[0].lon]); });
        });
        
        map.on('click', e => analizarPunto(e.latlng));
    </script>
</body>
</html>
