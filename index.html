<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor de Consulta Ciudadana | SEDEMA</title>
    
    <!-- Tailwind CSS (CDN para estilos rápidos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Roboto (Identidad Institucional) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;0,500;0,700;0,900;1,400&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- Estilos Propios -->
    <link rel="stylesheet" href="styles.css">

    <!-- Librerías JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body>

    <!-- Header Institucional -->
    <header>
        <div class="flex items-center gap-4 max-w-7xl mx-auto">
            <div class="w-12 h-12 bg-white rounded p-1 shadow-sm shrink-0 flex items-center justify-center overflow-hidden">
                <img src="./logo-sedema.png" alt="CDMX" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-xs font-bold text-gray-800\'>CDMX</span>'">
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-bold leading-tight tracking-tight">VISOR DE CONSULTA CIUDADANA</h1>
                <p class="text-[10px] md:text-xs text-white/80 uppercase tracking-wider font-medium">Secretaría del Medio Ambiente CDMX</p>
            </div>
        </div>
    </header>

    <!-- Contenedor Principal -->
    <div id="main-container">
        
        <!-- Mapa (Ordenado visualmente según CSS: Móvil=Arriba, Escritorio=Derecha) -->
        <!-- NOTA: En HTML el orden importa para el tabulador, pero en flex column mobile el mapa se fuerza arriba visualmente o se deja natural -->
        <div id="map"></div>

        <!-- Sidebar (Panel de Control y Resultados) -->
        <div id="sidebar">
            <div class="p-6 space-y-6">
                
                <!-- Sección de Búsqueda -->
                <div id="search-section" class="space-y-4 border-b border-gray-200 pb-6 no-print">
                    
                    <!-- Coordenadas -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Coordenadas</label>
                        <form id="coord-form" class="flex relative">
                            <input type="text" id="coord-input" placeholder="Ej. 19.4326, -99.1332" class="w-full pl-2 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#9d2148] outline-none">
                            <button type="submit" class="absolute right-2 top-1.5 p-1 text-gray-400 hover:text-[#9d2148]">
                                <i data-lucide="arrow-right" class="w-4 h-4"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Dirección -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Dirección</label>
                        <div class="flex relative">
                            <input type="text" id="address-input" placeholder="Calle, Colonia, Alcaldía..." class="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[#9d2148] outline-none">
                            <i data-lucide="map-pin" class="absolute left-2.5 top-2.5 w-4 h-4 text-gray-400"></i>
                            <button onclick="handleAddressSearch()" class="absolute right-2 top-1.5 p-1 text-gray-400 hover:text-[#9d2148]">
                                <i data-lucide="search" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Botones Acción -->
                    <div class="flex gap-2 pt-1">
                        <button onclick="detectLocation()" class="btn-primary flex-1 btn-icon">
                            <i data-lucide="navigation" class="w-4 h-4"></i> Ubícame
                        </button>
                        <button onclick="resetMap()" class="btn-secondary px-3 btn-icon" title="Limpiar mapa">
                            <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <!-- Estado Inicial -->
                <div id="empty-state" class="text-center py-10 text-gray-400">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="map" class="w-8 h-8 text-gray-300"></i>
                    </div>
                    <p class="text-sm font-medium">Seleccione un punto en el mapa</p>
                    <p class="text-xs mt-1">O utilice las herramientas de búsqueda.</p>
                </div>

                <!-- Cargando -->
                <div id="loading-state" class="hidden text-center py-10 text-[#9d2148]">
                    <i data-lucide="loader-2" class="w-8 h-8 animate-spin mx-auto mb-2"></i>
                    <p class="text-sm font-medium">Analizando ubicación...</p>
                </div>

                <!-- Resultados -->
                <div id="results-container" class="hidden space-y-6 animate-fade-in">
                    
                    <!-- Ficha de Estatus -->
                    <div id="status-card" class="p-5 rounded-lg border-l-8 shadow-sm bg-gray-50 border-gray-400">
                        <!-- Inyectado via JS -->
                    </div>

                    <!-- Detalles del Predio -->
                    <div class="grid grid-cols-1 gap-3 text-sm">
                         <div class="bg-gray-50 p-3 rounded border border-gray-200">
                            <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Ubicación de Referencia</span>
                            <span id="folio-text" class="font-mono font-bold text-gray-800 text-sm block truncate">Calculando...</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Alcaldía</span>
                                <span id="alcaldia-text" class="font-semibold text-gray-800">--</span>
                            </div>
                            <div class="bg-gray-50 p-3 rounded border border-gray-200">
                                <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Coordenadas</span>
                                <span id="coord-text" class="font-mono text-gray-800 text-xs">--</span>
                            </div>
                        </div>
                        <div id="zoning-info" class="hidden bg-gray-50 p-3 rounded border border-gray-200">
                             <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Zonificación (PGOEDF)</span>
                             <div class="flex items-center gap-2 mt-1">
                                 <span id="zoning-key" class="bg-[#b28e5d] text-white px-2 py-0.5 rounded text-xs font-bold shadow-sm">--</span>
                                 <span id="zoning-name" class="font-semibold text-gray-800 leading-tight">--</span>
                             </div>
                        </div>
                    </div>

                    <!-- Listas de Actividades (Acordeones) -->
                    <div id="rules-container" class="space-y-1 pt-2 hidden">
                        <h3 class="text-sm font-bold text-gray-800 mb-3 border-b pb-1 uppercase">Regulación de Uso de Suelo</h3>
                        <div id="activities-list"></div>
                    </div>

                    <!-- Notas Legales -->
                    <div class="mt-6 border-t border-gray-200 pt-4">
                        <h4 class="text-xs font-bold text-[#9d2148] uppercase mb-2">Notas Importantes</h4>
                        <ul class="list-disc pl-4 space-y-1 text-[10px] text-gray-600 text-justify leading-relaxed">
                            <li>La información mostrada es de carácter informativo y no produce efectos jurídicos.</li>
                            <li>Para trámites oficiales, consulte a la autoridad competente en la Ventanilla Única de SEDEMA.</li>
                            <li>Las disposiciones no prejuzgan sobre la propiedad de la tierra.</li>
                        </ul>
                    </div>

                    <!-- Botones Pie -->
                    <div class="flex gap-3 pt-4 no-print">
                        <button onclick="window.print()" class="btn-secondary flex-1 btn-icon">
                            <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                        </button>
                        <button onclick="shareResult()" class="btn-share flex-1 btn-icon">
                            <i data-lucide="share-2" class="w-4 h-4"></i> Compartir
                        </button>
                    </div>

                     <!-- Footer Impresión -->
                    <div id="legal-footer" class="hidden text-justify text-gray-500 font-serif">
                        <p>Documento generado por el Visor de Consulta Ciudadana de la Secretaría del Medio Ambiente de la Ciudad de México.</p>
                        <p>Fecha de consulta: <span id="print-date"></span></p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- CONSTANTES ---
        const DATA_FILES = {
            LIMITES_CDMX: './limites_cdmx.geojson',
            LIMITES_ALCALDIAS: './limites_alcaldias.geojson',
            LIMITES_EDOMEX: './limites_edomex.geojson',
            LIMITES_MORELOS: './limites_morelos.geojson',
            SUELO_CONSERVACION: './suelo-de-conservacion-2020.geojson',
            ZONIFICACION: './zoonificación_pgoedf_2000.geojson',
            USOS_SUELO_CSV: './usos_suelo.csv'
        };

        // --- ESTADO GLOBAL ---
        let map, marker, layerControl;
        let dataCache = {};
        let currentAnalysis = null;
        
        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initMap();
            loadData();
            
            // Event Listeners Formularios
            document.getElementById('coord-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('coord-input').value;
                const coords = parseCoordinates(input);
                if (coords) handleLocationSelect(coords, "Coordenada manual");
                else alert("Formato de coordenadas no válido.");
            });
        });

        // --- MAPA ---
        function initMap() {
            // 1. Centro CDMX y Zoom inicial que abarca toda la ciudad
            map = L.map('map', { zoomControl: false }).setView([19.32, -99.15], 10);
            
            // Control de Zoom (Arriba derecha en escritorio)
            L.control.zoom({ position: 'topright' }).addTo(map);

            // 2. Capa Satelital (ESRI World Imagery) - PREDETERMINADA
            const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri',
                maxZoom: 19
            }).addTo(map);

            const calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 20
            });

            // Capas Base
            const baseMaps = { "Satélite": satelite, "Mapa Callejero": calles };
            layerControl = L.control.layers(baseMaps, {}, { collapsed: true }).addTo(map);

            // Evento Click en Mapa
            map.on('click', (e) => {
                handleLocationSelect(e.latlng, null); // Null triggering reverse geocode
            });
        }

        // --- CARGA DE DATOS ---
        async function loadData() {
            try {
                const fetchJson = async (url) => (await fetch(url)).json().catch(() => ({ type: "FeatureCollection", features: [] }));
                
                const [cdmx, alcaldias, edomex, morelos, sc, zoning] = await Promise.all([
                    fetchJson(DATA_FILES.LIMITES_CDMX),
                    fetchJson(DATA_FILES.LIMITES_ALCALDIAS),
                    fetchJson(DATA_FILES.LIMITES_EDOMEX),
                    fetchJson(DATA_FILES.LIMITES_MORELOS),
                    fetchJson(DATA_FILES.SUELO_CONSERVACION),
                    fetchJson(DATA_FILES.ZONIFICACION)
                ]);

                // CSV Parsing
                let rules = [];
                Papa.parse(DATA_FILES.USOS_SUELO_CSV, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (res) => { dataCache.rules = res.data; },
                    error: () => { console.warn("Error cargando CSV"); }
                });

                dataCache = { cdmx, alcaldias, edomex, morelos, sc, zoning };

                // Renderizar Capas Contextuales en el Mapa
                if (cdmx.features.length) L.geoJSON(cdmx, { style: { color: '#55585a', weight: 3, fill: false }, interactive: false }).addTo(map);
                if (sc.features.length) {
                    const scLayer = L.geoJSON(sc, { style: { color: '#9d2148', weight: 1, fillColor: '#9d2148', fillOpacity: 0.1 } });
                    layerControl.addOverlay(scLayer, "Suelo de Conservación");
                    scLayer.addTo(map); // Activa por defecto
                }
                if (zoning.features.length) {
                     const zoningLayer = L.geoJSON(zoning, { 
                         style: { color: '#b28e5d', weight: 1, dashArray: '4,4', fillOpacity: 0 },
                         interactive: true, // Clickable para identificar zonas
                         onEachFeature: (feature, layer) => {
                             layer.on('click', (e) => {
                                 L.DomEvent.stopPropagation(e); // Evitar doble trigger
                                 handleLocationSelect(e.latlng, null);
                             });
                         }
                     });
                     layerControl.addOverlay(zoningLayer, "Zonificación");
                     zoningLayer.addTo(map); // Activa por defecto
                }
                
                // Capas externas (Contexto)
                if (edomex.features.length) L.geoJSON(edomex, { style: { color: '#9ca3af', dashArray: '2,4', fill: false }, interactive: false }).addTo(map);
                if (morelos.features.length) L.geoJSON(morelos, { style: { color: '#9ca3af', dashArray: '2,4', fill: false }, interactive: false }).addTo(map);

            } catch (e) {
                console.error("Error inicializando datos:", e);
                alert("Error al cargar capas geográficas. Verifique la conexión o los archivos.");
            }
        }

        // --- LÓGICA PRINCIPAL ---
        async function handleLocationSelect(latlng, addressLabel) {
            // 1. UI Feedback
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('loading-state').classList.remove('hidden');

            // 2. Marcador
            if (marker) map.removeLayer(marker);
            // Colores temporales, se actualizan tras análisis
            marker = L.circleMarker(latlng, { radius: 10, color: 'white', weight: 2, fillColor: '#b28e5d', fillOpacity: 1 }).addTo(map);
            map.setView(latlng, 16);

            // 3. Geocodificación Inversa (Obtener Dirección/Folio)
            let finalAddress = addressLabel;
            if (!finalAddress) {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`);
                    const data = await response.json();
                    // Limpiar dirección para que parezca folio
                    finalAddress = data.display_name ? data.display_name.split(',').slice(0, 3).join(',') : "Ubicación sin nombre";
                } catch {
                    finalAddress = "Referencia Geográfica";
                }
            }

            // 4. Análisis Espacial (Point in Polygon)
            const analysis = analyzePoint(latlng);
            currentAnalysis = { ...analysis, address: finalAddress, latlng };

            // 5. Renderizar
            renderResults(currentAnalysis);
            
            // 6. Scroll automático en móvil para ver resultados
            if (window.innerWidth < 768) {
                setTimeout(() => {
                    document.getElementById('sidebar').scrollIntoView({ behavior: 'smooth' });
                }, 300);
            }
        }

        function analyzePoint(latlng) {
            const pt = { lat: latlng.lat, lng: latlng.lng };
            let result = { status: 'UNKNOWN', alcaldia: null, zoning: null, rules: { A: [], C: [], P: [] }, context: '' };

            // A. Validar CDMX
            const inCDMX = isPointInPolygon(pt, dataCache.cdmx);
            if (!inCDMX) {
                result.status = 'OUTSIDE';
                if (isPointInPolygon(pt, dataCache.edomex)) result.context = "Estado de México";
                else if (isPointInPolygon(pt, dataCache.morelos)) result.context = "Estado de Morelos";
                return result;
            }

            // B. Alcaldía
            const alc = findFeature(pt, dataCache.alcaldias);
            if (alc) result.alcaldia = alc.properties.NOMBRE || alc.properties.NOMGEO;

            // C. Suelo Conservación
            const inSC = isPointInPolygon(pt, dataCache.sc);
            if (!inSC) {
                result.status = 'URBAN';
                return result;
            }

            // D. Zonificación
            result.status = 'RESTRICTED';
            const zone = findFeature(pt, dataCache.zoning);
            if (zone) {
                result.zoning = { key: zone.properties.CLAVE, name: zone.properties.PGOEDF || zone.properties.UGA };
                // E. Reglas CSV
                if (dataCache.rules) {
                    dataCache.rules.forEach(row => {
                        const val = (row[result.zoning.key] || '').toUpperCase().trim();
                        const desc = `${row.SECTOR} - ${row.ACTIVIDAD_GENERAL}: ${row.ACTIVIDAD_ESPECIFICA}`;
                        
                        // Lógica especial para destacar "Nuevos Asentamientos"
                        const isCritical = desc.includes("Nuevos Asentamientos Humanos");
                        const finalDesc = isCritical ? `⚠️ ${desc}` : desc;

                        if (val === 'A') {
                            if (isCritical) result.rules.A.unshift(finalDesc); else result.rules.A.push(finalDesc);
                        } else if (val === 'C') {
                            if (isCritical) result.rules.C.unshift(finalDesc); else result.rules.C.push(finalDesc);
                        } else if (val === 'P') {
                            if (isCritical) result.rules.P.unshift(finalDesc); else result.rules.P.push(finalDesc);
                        }
                    });
                }
            }
            return result;
        }

        function renderResults(data) {
            const container = document.getElementById('results-container');
            const loading = document.getElementById('loading-state');
            const statusCard = document.getElementById('status-card');
            
            loading.classList.add('hidden');
            container.classList.remove('hidden');

            // Actualizar Textos Básicos
            document.getElementById('folio-text').textContent = data.address || "Coordenada Manual";
            document.getElementById('alcaldia-text').textContent = data.alcaldia || "No identificada";
            document.getElementById('coord-text').textContent = `${data.latlng.lat.toFixed(5)}, ${data.latlng.lng.toFixed(5)}`;
            document.getElementById('print-date').textContent = new Date().toLocaleDateString();

            // Lógica Visual de Estatus
            let cardHTML = '';
            let markerColor = '#9d2148'; // Default Guinda

            if (data.status === 'OUTSIDE') {
                markerColor = '#6b7280'; // Gris
                cardHTML = `
                    <div class="flex items-start gap-3 text-gray-700">
                        <i data-lucide="x-circle" class="w-6 h-6 shrink-0 mt-1"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase">Fuera de Jurisdicción</h2>
                            <p class="text-sm mt-1">El punto no pertenece a la Ciudad de México. ${data.context ? 'Ubicación probable: ' + data.context : ''}</p>
                        </div>
                    </div>`;
                hideZoning();
            } else if (data.status === 'URBAN') {
                markerColor = '#16a34a'; // Verde
                cardHTML = `
                    <div class="flex items-start gap-3 text-green-800">
                        <i data-lucide="check-circle" class="w-6 h-6 shrink-0 mt-1"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase">Suelo Urbano</h2>
                            <p class="text-sm mt-1">Predio fuera de la capa de conservación ecológica. Consulte Zonificación Urbana en SEDUVI.</p>
                        </div>
                    </div>`;
                hideZoning();
            } else if (data.status === 'RESTRICTED') {
                markerColor = '#dc2626'; // Rojo
                cardHTML = `
                    <div class="flex items-start gap-3 text-red-800">
                        <i data-lucide="alert-triangle" class="w-6 h-6 shrink-0 mt-1"></i>
                        <div>
                            <h2 class="text-lg font-bold uppercase">Zona Restringida</h2>
                            <p class="text-sm mt-1">Suelo de Conservación. Aplican restricciones ambientales estrictas.</p>
                        </div>
                    </div>`;
                
                // Mostrar Zonificación y Reglas
                if (data.zoning) {
                    document.getElementById('zoning-info').classList.remove('hidden');
                    document.getElementById('zoning-key').textContent = data.zoning.key;
                    document.getElementById('zoning-name').textContent = data.zoning.name;
                    renderRules(data.rules);
                }
            }

            statusCard.innerHTML = cardHTML;
            statusCard.className = `p-5 rounded-lg border-l-8 shadow-sm ${
                data.status === 'RESTRICTED' ? 'bg-red-50 border-red-700' : 
                data.status === 'URBAN' ? 'bg-green-50 border-green-600' : 
                'bg-gray-100 border-gray-400'
            }`;

            // Actualizar color del marcador
            if (marker) marker.setStyle({ fillColor: markerColor, color: 'white' });

            lucide.createIcons();
        }

        function hideZoning() {
            document.getElementById('zoning-info').classList.add('hidden');
            document.getElementById('rules-container').classList.add('hidden');
        }

        function renderRules(rules) {
            const container = document.getElementById('rules-container');
            const list = document.getElementById('activities-list');
            container.classList.remove('hidden');
            list.innerHTML = '';

            const createAccordion = (title, items, colorClass, icon, open) => {
                if (!items.length) return '';
                return `
                <details ${open ? 'open' : ''}>
                    <summary class="${colorClass} hover:opacity-90">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${icon}" class="w-4 h-4"></i>
                            <span>${title} (${items.length})</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </summary>
                    <div class="content">
                        <ul class="list-disc pl-4 space-y-1 text-gray-600">
                            ${items.map(i => `<li class="${i.includes('⚠️') ? 'font-bold text-red-600' : ''}">${i}</li>`).join('')}
                        </ul>
                    </div>
                </details>`;
            };

            list.innerHTML += createAccordion('PERMITIDAS', rules.A, 'text-green-900 bg-green-100', 'check-circle', true);
            list.innerHTML += createAccordion('CONDICIONADAS', rules.C, 'text-amber-900 bg-amber-100', 'alert-circle', false);
            list.innerHTML += createAccordion('PROHIBIDAS', rules.P, 'text-red-900 bg-red-100', 'x-circle', false);
        }

        // --- UTILIDADES ---
        function parseCoordinates(input) {
            const parts = input.split(',').map(n => parseFloat(n.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) return { lat: parts[0], lng: parts[1] };
            return null;
        }

        function resetMap() {
            if (marker) map.removeLayer(marker);
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('coord-input').value = '';
            document.getElementById('address-input').value = '';
            map.setView([19.32, -99.15], 10);
        }

        async function handleAddressSearch() {
            const query = document.getElementById('address-input').value;
            if (!query) return;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ', CDMX')}&limit=1`);
                const data = await res.json();
                if (data.length) handleLocationSelect({ lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }, data[0].display_name);
                else alert("Dirección no encontrada.");
            } catch { alert("Error buscando dirección."); }
        }

        function detectLocation() {
            if (!navigator.geolocation) return alert("Geolocalización no soportada.");
            navigator.geolocation.getCurrentPosition(
                pos => handleLocationSelect({ lat: pos.coords.latitude, lng: pos.coords.longitude }, "Mi Ubicación"),
                () => alert("No se pudo obtener la ubicación.")
            );
        }

        function shareResult() {
            if (!currentAnalysis) return;
            const text = `Consulta SEDEMA: ${currentAnalysis.address}. Estatus: ${currentAnalysis.status === 'RESTRICTED' ? 'ZONA RESTRINGIDA' : 'SUELO URBANO'}.`;
            if (navigator.share) {
                navigator.share({ title: 'Consulta Ciudadana', text: text, url: window.location.href }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text);
                alert("Enlace copiado al portapapeles.");
            }
        }

        // --- ALGORITMOS GIS (Ray Casting) ---
        function isPointInPolygon(point, geojson) {
            if (!geojson || !geojson.features) return false;
            return geojson.features.some(f => pointInFeature(point, f));
        }

        function findFeature(point, geojson) {
            if (!geojson || !geojson.features) return null;
            return geojson.features.find(f => pointInFeature(point, f));
        }

        function pointInFeature(pt, feature) {
            const { type, coordinates } = feature.geometry;
            const checkPoly = (ring) => {
                let inside = false;
                for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                    const xi = ring[i][0], yi = ring[i][1];
                    const xj = ring[j][0], yj = ring[j][1];
                    const intersect = ((yi > pt.lat) !== (yj > pt.lat)) && (pt.lng < (xj - xi) * (pt.lat - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            };
            if (type === 'Polygon') return checkPoly(coordinates[0]);
            if (type === 'MultiPolygon') return coordinates.some(poly => checkPoly(poly[0]));
            return false;
        }

    </script>
</body>
</html>
