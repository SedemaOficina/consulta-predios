<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- LIBRER√çAS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
    </header>

    <div class="main-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta de Uso de Suelo</h3>
                <p>Verifica la zonificaci√≥n y reglas del PGOEDF.</p>
            </div>

            <div class="sidebar-body">
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">üìç USAR MI UBICACI√ìN</button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O</span></div>

                <div class="control-group">
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">üîé</button>
                    </div>
                </div>

                <div id="panel-resultados" class="result-container" style="display:none;">
                    <h4 id="res-titulo">RESULTADO</h4>
                    <p id="res-zona" style="font-weight:bold; margin-bottom:5px;"></p>
                    <div id="res-reglas"></div>
                </div>

                <div class="leyenda-box">
                    <h4>Simbolog√≠a</h4>
                    <div class="item"><span class="dot rojo"></span> Suelo de Conservaci√≥n (Restringido)</div>
                    <div class="item"><span class="dot azul"></span> Zonificaci√≥n PGOEDF</div>
                    <div class="item"><span class="dot verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <script>
        // ==========================================
        // 1. CARGAR CSV (BASE DE DATOS)
        // ==========================================
        let tablaUsos = []; 

        Papa.parse("usos_suelo.csv", {
            download: true,
            header: true,
            complete: function(results) {
                tablaUsos = results.data;
                console.log("Reglas cargadas:", tablaUsos.length);
            },
            error: function(err) {
                console.error("Error leyendo CSV:", err);
            }
        });

        // CAT√ÅLOGOS
        const catalogoZonas = {
            "FC": "Forestal de Conservaci√≥n",
            "FCE": "Forestal de Conservaci√≥n Especial",
            "FP": "Forestal de Protecci√≥n",
            "FPE": "Forestal de Protecci√≥n Especial",
            "AF": "Agroforestal",
            "AFE": "Agroforestal Especial",
            "AE": "Agroecol√≥gica",
            "AEE": "Agroecol√≥gica Especial",
            "ANP": "√Årea Natural Protegida",
            "PDU": "Poblado Rural (PDU)"
        };

        const mapeoSHP = {
            "FORESTAL DE CONSERVACION": "FC",
            "FORESTAL DE CONSERVACI√ìN": "FC",
            "FORESTAL DE CONSERVACION ESPECIAL": "FCE",
            "FORESTAL DE CONSERVACI√ìN ESPECIAL": "FCE",
            "FORESTAL DE PROTECCION": "FP",
            "FORESTAL DE PROTECCI√ìN": "FP",
            "FORESTAL DE PROTECCION ESPECIAL": "FPE",
            "FORESTAL DE PROTECCI√ìN ESPECIAL": "FPE",
            "AGROFORESTAL": "AF",
            "AGROFORESTAL ESPECIAL": "AFE",
            "AGROECOLOGICO": "AE",
            "AGROECOL√ìGICO": "AE",
            "AGROECOLOGICO ESPECIAL": "AEE",
            "AGROECOL√ìGICO ESPECIAL": "AEE"
        };

        function obtenerReglasCSV(codigoZona) {
            let permitidos = [];
            let prohibidos = [];

            tablaUsos.forEach(fila => {
                // Verificar si la columna de esa zona tiene A o P
                if (fila[codigoZona]) {
                    let texto = `<strong>${fila.SECTOR}:</strong> ${fila.ACTIVIDAD_ESPECIFICA || fila.ACTIVIDAD}`;
                    
                    if (fila[codigoZona].trim().toUpperCase() === 'A') {
                        permitidos.push(texto);
                    } else if (fila[codigoZona].trim().toUpperCase() === 'P') {
                        prohibidos.push(texto);
                    }
                }
            });
            return { perm: permitidos, proh: prohibidos };
        }

        // ==========================================
        // 2. MAPA
        // ==========================================
        var map = L.map('map', { zoomControl: false }).setView([19.28, -99.13], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 }).addTo(map);
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.8, attribution: 'CARTO', maxZoom: 19 }).addTo(map);
        
        var layerControl = L.control.layers({ "Sat√©lite": satelite, "Calles": calles }, {}, { position: 'topright' }).addTo(map);

        // Capas Globales
        var geojsonSuelo, geojsonZoni;

        // 3. CARGA DE ARCHIVOS GEOJSON
        
        fetch('suelo-de-conservacion-2020.geojson').then(r => r.json()).then(data => {
            geojsonSuelo = L.geoJSON(data, {
                style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.2, weight: 0 },
                interactive: false
            }).addTo(map);
            layerControl.addOverlay(geojsonSuelo, "üî¥ Suelo de Conservaci√≥n");
        });

        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r => r.json()).then(data => {
            geojsonZoni = L.geoJSON(data, {
                style: { color: '#3498db', weight: 1, fillOpacity: 0.05 },
                onEachFeature: function(feature, layer) {
                    layer.on('click', function(e) {
                        L.DomEvent.stopPropagation(e);
                        analizarPunto(e.latlng);
                    });
                }
            }).addTo(map);
            layerControl.addOverlay(geojsonZoni, "üîµ Zonificaci√≥n PGOEDF");
        });

        fetch('anp.geojson').then(r => r.json()).then(d => {
            var l = L.geoJSON(d, {style:{color:'#27ae60', fillOpacity:0.3, weight:1}}).addTo(map);
            layerControl.addOverlay(l, "üü¢ ANP");
        }).catch(e=>{});

        // ==========================================
        // 4. L√ìGICA DE AN√ÅLISIS
        // ==========================================
        var pinActual;

        function analizarPunto(latlng) {
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);

            if (!geojsonSuelo || !geojsonZoni) { alert("Cargando datos..."); return; }

            var hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);
            
            var panel = document.getElementById('panel-resultados');
            var titulo = document.getElementById('res-titulo');
            var zona = document.getElementById('res-zona');
            var divReglas = document.getElementById('res-reglas');
            panel.style.display = "block";
            var htmlPopup = "";

            if (hitsSuelo.length > 0) {
                // --- DENTRO DE SC ---
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var nombreZona = "Suelo de Conservaci√≥n (Sin dato)";
                var codigoZona = "SC";
                var uga = "";

                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    
                    // L√≥gica para encontrar el nombre correcto en tus atributos
                    var nombreRaw = (p.PGOEDF || p.DESCRIPCIO || p.ZONA || "").toUpperCase().trim();
                    var claveRaw = (p.CLAVE || "").toUpperCase().trim();
                    uga = p.UGA || p.CLAVE || "";

                    if (mapeoSHP[nombreRaw]) {
                        codigoZona = mapeoSHP[nombreRaw];
                        nombreZona = catalogoZonas[codigoZona];
                    } else if (catalogoZonas[claveRaw]) {
                        codigoZona = claveRaw;
                        nombreZona = catalogoZonas[codigoZona];
                    } else if (nombreRaw.includes("PROGRAMA") || nombreRaw.includes("POBLADO")) {
                        codigoZona = "PDU";
                        nombreZona = "Poblado Rural / PDU";
                    } else {
                        // Default si no encuentra match
                        codigoZona = "SC";
                        nombreZona = nombreRaw;
                    }
                }

                // Obtener reglas del CSV
                var reglas = obtenerReglasCSV(codigoZona);
                
                // Formatear listas (Mostrar solo los primeros 5 para no saturar)
                var printList = (lista) => {
                    if(!lista || lista.length===0) return "<li>Consultar PGOEDF</li>";
                    return lista.slice(0, 5).map(x=>`<li>${x}</li>`).join("") + (lista.length > 5 ? "<li>...y m√°s</li>" : "");
                };

                // PDU es especial (Amarillo)
                if (codigoZona === "PDU") {
                    panel.className = "result-container alerta-amarilla";
                    titulo.innerText = "‚ö†Ô∏è POBLADO RURAL (PDU)";
                    zona.innerHTML = `${nombreZona}<br><small>UGA: ${uga}</small>`;
                    divReglas.innerHTML = `<div class="box permitido"><strong>ESTATUS:</strong><br>Zona de asentamiento humano.<br>La vivienda se permite solo si est√° regularizada.</div>`;
                    
                    htmlPopup = `<div style="text-align:center; font-family:Montserrat;"><h4 style="color:#d35400;">‚ö†Ô∏è POBLADO RURAL</h4><p style="font-size:11px;">${nombreZona}</p></div>`;

                } else {
                    // Zona Restringida (Rojo)
                    panel.className = "result-container alerta-roja";
                    titulo.innerText = "üö´ PROHIBIDO (SUELO DE CONSERVACI√ìN)";
                    zona.innerHTML = `${nombreZona}<br><small>Clave: ${codigoZona} | UGA: ${uga}</small>`;
                    
                    divReglas.innerHTML = `
                        <div class="box prohibido"><strong>üö´ PROHIBIDO:</strong><ul>${printList(reglas.proh)}</ul></div>
                        <div class="box permitido"><strong>‚úÖ AUTORIZADO:</strong><ul>${printList(reglas.perm)}</ul></div>
                    `;
                    
                    htmlPopup = `
                        <div style="font-family:Montserrat; text-align:center;">
                            <h4 style="color:#C0392B; margin:0;">‚ö†Ô∏è ZONA RESTRINGIDA</h4>
                            <p style="font-size:11px; margin:5px 0;"><strong>${nombreZona}</strong></p>
                            <div style="background:#ffebee; padding:5px; text-align:left; border:1px solid #C0392B;">
                                <strong style="color:#C0392B; font-size:10px;">PROHIBIDO:</strong>
                                <ul style="font-size:10px; margin:0; padding-left:15px;">
                                    ${reglas.proh.slice(0,3).map(x=>`<li>${x}</li>`).join("")}
                                </ul>
                            </div>
                        </div>
                    `;
                }

            } else {
                // --- SUELO URBANO ---
                panel.className = "result-container alerta-verde";
                titulo.innerText = "‚úÖ SUELO URBANO";
                zona.innerText = "Fuera del l√≠mite de conservaci√≥n.";
                divReglas.innerHTML = `<small>Verificar uso habitacional en SEDUVI.</small>`;
                htmlPopup = `<div style="text-align:center; font-family:Montserrat;"><h4 style="color:#27ae60; margin:0;">‚úÖ SUELO URBANO</h4></div>`;
            }

            if(htmlPopup) pinActual.bindPopup(htmlPopup, {minWidth:250}).openPopup();
        }

        // ==========================================
        // 5. BOTONES
        // ==========================================
        function buscar() {
            var input = document.getElementById('input-busqueda').value.trim();
            if(!input) return;
            var coordRegex = /^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/;
            var match = input.match(coordRegex);

            if (match) {
                var lat = parseFloat(match[1]); var lng = parseFloat(match[3]);
                if (lat >= 18 && lat <= 20 && lng >= -100 && lng <= -98) analizarPunto([lat, lng]);
                else alert("Coordenadas fuera de CDMX.");
            } else {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}+CDMX&limit=1`)
                .then(r=>r.json()).then(d=>{
                    if(d.length > 0) analizarPunto([d[0].lat, d[0].lon]);
                    else alert("No encontrado.");
                });
            }
        }

        document.getElementById('btn-buscar').addEventListener('click', buscar);
        document.getElementById('input-busqueda').addEventListener('keypress', e => { if(e.key==='Enter') buscar() });

        document.getElementById('btn-gps').addEventListener('click', function() {
            document.getElementById('status-gps').innerText = "üõ∞Ô∏è Buscando...";
            map.locate({setView: true, maxZoom: 17, enableHighAccuracy: true});
        });
        map.on('locationfound', e => {
            document.getElementById('status-gps').innerText = "";
            analizarPunto(e.latlng);
        });

    </script>
</body>
</html>
