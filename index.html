<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES Y ESTILOS -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css">
    
    <!-- LIBRER√çAS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
</head>
<body>

    <!-- ENCABEZADO -->
    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
        <div class="header-text">
            <h1>SISTEMA DE INFORMACI√ìN GEOGR√ÅFICA</h1>
            <h2>Vigilancia y Ordenamiento Ecol√≥gico</h2>
        </div>
    </header>

    <div class="main-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta Ciudadana</h3>
                <p>Valida la situaci√≥n legal y ambiental del predio.</p>
            </div>

            <div class="sidebar-body">
                <!-- CONTROLES DE B√öSQUEDA -->
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">
                        üìç UBICARME EN EL SITIO
                    </button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O B√öSQUEDA MANUAL</span></div>

                <div class="control-group">
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">BUSCAR</button>
                    </div>
                </div>

                <!-- PANEL DE RESULTADOS (DIAGN√ìSTICO) -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <div class="res-status-bar" id="res-status-bar">...</div>
                    
                    <div class="res-content">
                        <!-- Nueva secci√≥n de Ubicaci√≥n Administrativa -->
                        <div id="bloque-ubicacion">
                            <label>Ubicaci√≥n Administrativa:</label>
                            <p id="res-alcaldia" class="res-value">CDMX</p>
                        </div>

                        <label>Diagn√≥stico Ambiental:</label>
                        <p id="res-zona" class="res-value highlight">...</p>
                        
                        <div id="res-acciones-container" style="display:none;">
                            <button onclick="generarReporte()" class="btn-full btn-print">
                                üìÑ GENERAR REPORTE PDF
                            </button>
                            <button onclick="compartirWhatsapp()" class="btn-full btn-whats">
                                üì± COMPARTIR RESULTADO
                            </button>
                        </div>
                    </div>
                </div>

                <!-- LEYENDA -->
                <div class="leyenda-box">
                    <h4>Capas del Mapa</h4>
                    <div class="item"><span class="linea-negra"></span> L√≠mite CDMX</div>
                    <div class="item"><span class="rect rojo"></span> Suelo de Conservaci√≥n</div>
                    <div class="item"><span class="rect azul"></span> Zonificaci√≥n Normativa</div>
                    <div class="item"><span class="rect verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <!-- SECCI√ìN DE REPORTE (SOLO VISIBLE AL IMPRIMIR) -->
    <div id="reporte-impresion" class="print-only">
        <div class="report-header">
            <img src="logo-sedema.png" alt="Logo">
            <div>
                <h2>FICHA T√âCNICA INFORMATIVA</h2>
                <p>Programa General de Ordenamiento Ecol√≥gico del D.F.</p>
            </div>
        </div>

        <div class="report-meta">
            <p><strong>Fecha de Consulta:</strong> <span id="print-fecha"></span></p>
            <p><strong>Ubicaci√≥n:</strong> <span id="print-alcaldia"></span></p>
            <p><strong>Coordenadas:</strong> <span id="print-coords"></span></p>
            <p><strong>Direcci√≥n Aprox:</strong> <span id="print-dir"></span></p>
        </div>

        <div class="report-map-container" id="mapa-impresion-placeholder">
            <!-- El mapa se clona aqu√≠ al imprimir -->
        </div>

        <div class="report-diagnosis">
            <h3 id="print-titulo-zona">DIAGN√ìSTICO: ...</h3>
            <p id="print-desc-zona">...</p>
            
            <div class="tables-container">
                <div class="tbl-box prohibido">
                    <h4>üö´ ACTIVIDADES PROHIBIDAS</h4>
                    <ul id="print-lista-proh"></ul>
                </div>
                <div class="tbl-box permitido">
                    <h4>‚úÖ ACTIVIDADES PERMITIDAS</h4>
                    <ul id="print-lista-perm"></ul>
                </div>
            </div>
        </div>

        <div class="report-footer">
            <p><strong>AVISO LEGAL:</strong> Este documento es de car√°cter informativo. La √∫nica validaci√≥n oficial para tr√°mites legales debe ser emitida por la autoridad competente mediante dictamen t√©cnico. La venta de terrenos en Suelo de Conservaci√≥n sin uso de suelo habitacional constituye un delito ambiental.</p>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CARGA DE BASE DE DATOS (CSV)
        // ==========================================
        let tablaUsos = [];
        let infoActual = null;
        let coordsActuales = null;
        let direccionActual = "";

        Papa.parse("usos_suelo.csv", {
            download: true, header: true, encoding: "UTF-8", skipEmptyLines: true,
            complete: function(results) { tablaUsos = results.data; }
        });

        const catalogoZonas = {
            "FC": "Forestal de Conservaci√≥n", "FCE": "Forestal de Conservaci√≥n Especial",
            "FP": "Forestal de Protecci√≥n", "FPE": "Forestal de Protecci√≥n Especial",
            "AF": "Agroforestal", "AFE": "Agroforestal Especial",
            "AE": "Agroecol√≥gica", "AEE": "Agroecol√≥gica Especial",
            "ANP": "√Årea Natural Protegida", "PDU": "Poblado Rural (PDU)"
        };

        const mapeoSHP = {
            "FORESTAL DE CONSERVACION": "FC", "FORESTAL DE CONSERVACI√ìN": "FC",
            "FORESTAL DE CONSERVACION ESPECIAL": "FCE", "FORESTAL DE CONSERVACI√ìN ESPECIAL": "FCE",
            "FORESTAL DE PROTECCION": "FP", "FORESTAL DE PROTECCI√ìN": "FP",
            "FORESTAL DE PROTECCION ESPECIAL": "FPE", "FORESTAL DE PROTECCI√ìN ESPECIAL": "FPE",
            "AGROFORESTAL": "AF", "AGROFORESTAL ESPECIAL": "AFE",
            "AGROECOLOGICO": "AE", "AGROECOL√ìGICO": "AE",
            "AGROECOLOGICO ESPECIAL": "AEE", "AGROECOL√ìGICO ESPECIAL": "AEE"
        };

        function obtenerReglasCSV(codigoZona) {
            let perm = [], proh = [];
            tablaUsos.forEach(fila => {
                if (fila[codigoZona]) {
                    // Texto limpio: "Sector - Actividad"
                    let txt = `<strong>${fila.SECTOR}:</strong> ${fila.ACTIVIDAD_ESPECIFICA || fila.ACTIVIDAD_GENERAL}`;
                    if (fila[codigoZona].trim().toUpperCase() === 'A') perm.push(txt);
                    else if (fila[codigoZona].trim().toUpperCase() === 'P') proh.push(txt);
                }
            });
            return { perm, proh };
        }

        // ==========================================
        // 2. CONFIGURACI√ìN DEL MAPA
        // ==========================================
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.13], 10);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Mapas Base
        var esriStreets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM', maxZoom: 19 });
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        
        map.addLayer(esriStreets); 

        var layerControl = L.control.layers(
            { "Mapa Urbano (Esri)": esriStreets, "Mapa Detallado (OSM)": osm, "Sat√©lite (Imagen)": satelite }, 
            {}, 
            { position: 'topright' }
        ).addTo(map);

        // Capas Globales
        var geojsonSuelo, geojsonZoni, geojsonANP, geojsonCDMX, geojsonAlcaldias;

        // --------------------------------------------------------
        // 3. CARGA DE ARCHIVOS (NOMBRES CORREGIDOS)
        // --------------------------------------------------------

        // A) L√çMITE CDMX (limites_cdmx.geojson) - Estilo: Negro Fuerte
        fetch('limites_cdmx.geojson').then(r => r.json()).then(data => {
            geojsonCDMX = L.geoJSON(data, {
                style: { color: '#000000', weight: 4, fill: false, opacity: 0.8 } 
            }).addTo(map);
            // Centrar mapa en la CDMX al inicio
            map.fitBounds(geojsonCDMX.getBounds());
        }).catch(err => console.error("Error cargando limites_cdmx.geojson", err));

        // B) ALCALD√çAS (limites_alcaldias.geojson) - Estilo: Gris Punteado
        fetch('limites_alcaldias.geojson').then(r => r.json()).then(data => {
            geojsonAlcaldias = L.geoJSON(data, {
                style: { color: '#555', weight: 1.5, fillOpacity: 0, dashArray: '5, 5' }
            }).addTo(map);
            layerControl.addOverlay(geojsonAlcaldias, "L√≠mites de Alcald√≠as");
        }).catch(err => console.error("Error cargando limites_alcaldias.geojson", err));

        // C) SUELO DE CONSERVACI√ìN (suelo-de-conservacion-2020.geojson)
        fetch('suelo-de-conservacion-2020.geojson').then(r => r.json()).then(data => {
            geojsonSuelo = L.geoJSON(data, {
                style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.15, weight: 0 },
                interactive: false
            }).addTo(map);
            layerControl.addOverlay(geojsonSuelo, "Suelo de Conservaci√≥n");
        });

        // D) ZONIFICACI√ìN (zoonificaci√≥n_pgoedf_2000.geojson)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r => r.json()).then(data => {
            geojsonZoni = L.geoJSON(data, {
                style: { color: '#2980b9', weight: 1, fillOpacity: 0.05 },
                onEachFeature: function(f, l) { l.on('click', e => { L.DomEvent.stopPropagation(e); analizarPunto(e.latlng); }); }
            }).addTo(map);
            layerControl.addOverlay(geojsonZoni, "Zonificaci√≥n PGOEDF");
        });

        // E) ANP (anp.geojson) - Opcional
        fetch('anp.geojson').then(r => r.json()).then(data => {
            geojsonANP = L.geoJSON(data, {
                style: { color: '#27ae60', fillOpacity: 0.3, weight: 1 }
            }).addTo(map);
            layerControl.addOverlay(geojsonANP, "√Åreas Naturales Protegidas");
        }).catch(()=>{});

        // ==========================================
        // 4. L√ìGICA DE AN√ÅLISIS
        // ==========================================
        var pinActual;

        function analizarPunto(latlng) {
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);
            coordsActuales = latlng;

            if (!geojsonSuelo || !geojsonZoni || !geojsonCDMX || !geojsonAlcaldias) { 
                // Esperar a que carguen, o alertar
                // No bloquear, intentar seguir si alguna capa existe
            }

            // Elementos UI
            var panel = document.getElementById('panel-resultados');
            var statusBar = document.getElementById('res-status-bar');
            var txtAlcaldia = document.getElementById('res-alcaldia');
            var txtZona = document.getElementById('res-zona');
            var btnContainer = document.getElementById('res-acciones-container');
            
            panel.style.display = "block";

            // ----------------------------------------------------
            // PASO 1: VERIFICAR L√çMITE CDMX
            // ----------------------------------------------------
            var enCDMX = true;
            if (geojsonCDMX) {
                var hitsCDMX = leafletPip.pointInLayer(latlng, geojsonCDMX);
                if (hitsCDMX.length === 0) enCDMX = false;
            }

            if (!enCDMX) {
                // FUERA DE JURISDICCI√ìN
                statusBar.innerText = "FUERA DE CDMX";
                statusBar.className = "res-status-bar neutral";
                txtAlcaldia.innerText = "Fuera de la Ciudad de M√©xico";
                txtZona.innerText = "La SEDEMA no tiene jurisdicci√≥n en esta zona (Estado de M√©xico / Morelos).";
                btnContainer.style.display = "none";
                
                pinActual.bindPopup(`
                    <div style="text-align:center; font-family:Montserrat;">
                        <b style="color:#7f8c8d">FUERA DE JURISDICCI√ìN</b><br>
                        Ubicaci√≥n fuera de la CDMX.
                    </div>
                `).openPopup();
                infoActual = null;
                return; // Detener an√°lisis
            }

            // ----------------------------------------------------
            // PASO 2: IDENTIFICAR ALCALD√çA
            // ----------------------------------------------------
            var nombreAlcaldia = "CDMX";
            if (geojsonAlcaldias) {
                var hitsAlc = leafletPip.pointInLayer(latlng, geojsonAlcaldias);
                if (hitsAlc.length > 0) {
                    var p = hitsAlc[0].feature.properties;
                    // Intenta buscar el nombre en atributos comunes
                    nombreAlcaldia = p.NOMGEO || p.NOMBRE || p.ALCALDIA || "Alcald√≠a Desconocida";
                }
            }
            txtAlcaldia.innerText = nombreAlcaldia;

            // ----------------------------------------------------
            // PASO 3: VERIFICAR SUELO DE CONSERVACI√ìN
            // ----------------------------------------------------
            var hitsSuelo = [];
            if(geojsonSuelo) hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);

            if (hitsSuelo.length > 0) {
                // --- ES ZONA RESTRINGIDA ---
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var nombreZona = "Suelo de Conservaci√≥n";
                var codigo = "SC";
                var uga = "S/D";

                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    var raw = (p.PGOEDF || p.DESCRIPCIO || p.ZONA || "").toUpperCase().trim();
                    var c = (p.CLAVE || "").toUpperCase().trim();
                    uga = p.UGA || p.CLAVE || "S/D";

                    if (mapeoSHP[raw]) codigo = mapeoSHP[raw];
                    else if (catalogoZonas[c]) codigo = c;
                    else codigo = "PDU";

                    nombreZona = catalogoZonas[codigo] || raw;
                }

                // Obtener reglas
                var reglas = obtenerReglasCSV(codigo);
                infoActual = { nombre: nombreZona, alcaldia: nombreAlcaldia, codigo: codigo, uga: uga, reglas: reglas, tipo: "SC" };

                // Renderizar Panel
                if (codigo === "PDU") {
                    statusBar.innerText = "‚ö†Ô∏è POBLADO RURAL";
                    statusBar.className = "res-status-bar warning";
                    txtZona.innerHTML = `${nombreZona}<br><small>Asentamiento Humano Irregular / PDU</small>`;
                } else {
                    statusBar.innerText = "üö´ ZONA RESTRINGIDA";
                    statusBar.className = "res-status-bar danger";
                    txtZona.innerHTML = `${nombreZona}<br><small>UGA: ${uga} | Clave: ${codigo}</small>`;
                }
                
                btnContainer.style.display = "block";

                // Popup Simple
                pinActual.bindPopup(`
                    <div style="text-align:center; font-family:Montserrat;">
                        <b style="color:#C0392B">${statusBar.innerText}</b><br>
                        <small>${nombreZona}</small><br>
                        <div style="font-size:10px; margin-top:5px; color:#555;">${nombreAlcaldia}</div>
                        <button onclick="generarReporte()" style="margin-top:5px; background:#2c3e50; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;">Ver Reporte Completo</button>
                    </div>
                `).openPopup();

            } else {
                // --- ES SUELO URBANO ---
                infoActual = { nombre: "Suelo Urbano", alcaldia: nombreAlcaldia, codigo: "URB", uga: "N/A", reglas: {perm:[], proh:[]}, tipo: "URB" };
                
                statusBar.innerText = "‚úÖ SUELO URBANO";
                statusBar.className = "res-status-bar success";
                txtZona.innerText = "Zona sin restricci√≥n ambiental PGOEDF.";
                btnContainer.style.display = "block";

                pinActual.bindPopup(`
                    <div style="text-align:center; font-family:Montserrat;">
                        <b style="color:#27ae60">‚úÖ SUELO URBANO</b><br>
                        <small>${nombreAlcaldia}</small><br>
                        <span style="font-size:10px;">Verificar uso en SEDUVI</span>
                    </div>
                `).openPopup();
            }
        }

        map.on('click', e => analizarPunto(e.latlng));

        // ==========================================
        // 5. FUNCIONES DE REPORTE Y UX
        // ==========================================

        function generarReporte() {
            if (!infoActual) return;
            
            document.getElementById('print-fecha').innerText = new Date().toLocaleString();
            document.getElementById('print-coords').innerText = `${coordsActuales.lat.toFixed(5)}, ${coordsActuales.lng.toFixed(5)}`;
            document.getElementById('print-alcaldia').innerText = infoActual.alcaldia;
            document.getElementById('print-titulo-zona').innerText = infoActual.nombre;
            
            // Si hay direcci√≥n detectada por el buscador o GPS, √∫sala, si no "Ubicaci√≥n en mapa"
            var dirFinal = document.getElementById('input-busqueda').value || "Ubicaci√≥n seleccionada en mapa";
            document.getElementById('print-dir').innerText = dirFinal;

            document.getElementById('print-desc-zona').innerText = infoActual.tipo === "URB" 
                ? "Esta ubicaci√≥n se encuentra en Suelo Urbano. No aplica la normatividad del PGOEDF (Suelo de Conservaci√≥n). La regulaci√≥n de uso de suelo compete a la SEDUVI."
                : `Ubicaci√≥n dentro del Suelo de Conservaci√≥n. Regulaci√≥n aplicable: ${infoActual.codigo} (UGA ${infoActual.uga}).`;

            var ulProh = document.getElementById('print-lista-proh');
            var ulPerm = document.getElementById('print-lista-perm');
            ulProh.innerHTML = ""; ulPerm.innerHTML = "";

            if (infoActual.tipo === "URB") {
                ulPerm.innerHTML = "<li>Uso habitacional y comercial (Sujeto a Zonificaci√≥n SEDUVI)</li>";
                ulProh.innerHTML = "<li>N/A (Verificar restricciones urbanas espec√≠ficas)</li>";
            } else {
                if(infoActual.reglas.proh.length > 0) infoActual.reglas.proh.forEach(x => { var li=document.createElement('li'); li.innerHTML=x; ulProh.appendChild(li); });
                else ulProh.innerHTML = "<li>Verificar Tabla General PGOEDF</li>";

                if(infoActual.reglas.perm.length > 0) infoActual.reglas.perm.forEach(x => { var li=document.createElement('li'); li.innerHTML=x; ulPerm.appendChild(li); });
                else ulPerm.innerHTML = "<li>Verificar Tabla General PGOEDF</li>";
            }

            window.print();
        }

        function compartirWhatsapp() {
            if (!infoActual) return;
            var texto = `Consulta SEDEMA CDMX:\nüìç Ubicaci√≥n: ${infoActual.alcaldia}\n`;
            if (infoActual.tipo === "URB") {
                texto += "‚úÖ Resultado: SUELO URBANO. Aparentemente regular.";
            } else {
                texto += `üö´ Resultado: ZONA RESTRINGIDA.\nZona: ${infoActual.nombre}.\n‚ö†Ô∏è Precauci√≥n: Verifica uso de suelo antes de comprar.`;
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
        }

        // B√∫squeda
        document.getElementById('btn-buscar').addEventListener('click', () => {
            var val = document.getElementById('input-busqueda').value.trim();
            if(!val) return;
            var match = val.match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);
            if(match) {
                var l = parseFloat(match[1]), g = parseFloat(match[3]);
                analizarPunto([l, g]);
            } else {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}+CDMX&limit=1`)
                .then(r=>r.json()).then(d=>{
                    if(d.length) analizarPunto([d[0].lat, d[0].lon]);
                    else alert("No encontrado");
                });
            }
        });

        document.getElementById('btn-gps').addEventListener('click', () => {
            document.getElementById('status-gps').innerText = "üõ∞Ô∏è Buscando...";
            map.locate({setView: true, maxZoom: 18, enableHighAccuracy: true});
        });
        map.on('locationfound', e => {
            document.getElementById('status-gps').innerText = "";
            analizarPunto(e.latlng);
        });

    </script>
</body>
</html>
