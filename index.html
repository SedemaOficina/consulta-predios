<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta de Predios | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET Y LIBRER√çAS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Librer√≠a PIP (Punto en Pol√≠gono) -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <!-- Librer√≠a AJAX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <!-- ESTILOS CSS INCORPORADOS (Para que no fallen) -->
    <style>
        /* RESET GENERAL (Para quitar bordes feos por defecto) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Montserrat', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; /* Evita doble barra de scroll */
        }

        /* --- 1. ENCABEZADO --- */
        .gob-header {
            height: 70px;
            background: white;
            border-bottom: 4px solid #9d2148; /* Guinda */
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 2000;
            flex-shrink: 0; /* Que no se aplaste */
        }

        .logo-box img { 
            height: 50px; 
            width: auto; 
            display: block;
        }

        /* --- 2. CONTENEDOR PRINCIPAL (LADO A LADO) --- */
        .main-wrapper {
            display: flex;
            flex: 1; /* Ocupa el resto de la altura */
            position: relative;
            height: calc(100vh - 70px); /* Altura total menos header */
        }

        /* --- 3. PANEL LATERAL (IZQUIERDA) --- */
        .sidebar {
            width: 350px;
            background: #f9f9f9;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            flex-shrink: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar-header {
            background: #9d2148;
            color: white;
            padding: 15px 20px;
        }
        .sidebar-header h3 { margin: 0; font-size: 16px; font-weight: 700; text-transform: uppercase; }
        .sidebar-header p { margin: 5px 0 0 0; font-size: 11px; opacity: 0.9; }

        .sidebar-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* CONTROLES */
        .control-group { margin-bottom: 25px; }
        .label-titulo { 
            display: block; 
            font-size: 12px; 
            font-weight: 700; 
            color: #9d2148; 
            margin-bottom: 8px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bot√≥n GPS */
        .btn-full {
            width: 100%;
            padding: 12px;
            background: #2c3e50; /* Gris oscuro elegante */
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: background 0.2s;
        }
        .btn-full:hover { background: #1a252f; }

        .divider { 
            text-align: center; margin: 15px 0; font-size: 11px; color: #999; font-weight: bold; position: relative; 
        }
        .divider::before { content: ""; position: absolute; top: 50%; left: 0; width: 45%; height: 1px; background: #ddd; }
        .divider::after { content: ""; position: absolute; top: 50%; right: 0; width: 45%; height: 1px; background: #ddd; }

        /* Buscador */
        .search-row { display: flex; gap: 5px; }
        .search-row input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Montserrat', sans-serif;
            font-size: 13px;
        }
        .search-row button {
            padding: 0 15px;
            background: #b28e5c; /* Dorado */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        /* RESULTADOS */
        .result-container {
            margin-top: 10px;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ccc;
            background: white;
            font-size: 13px;
        }
        /* Colores de alerta */
        .res-rojo { border-left: 5px solid #C0392B; background: #fff5f5; }
        .res-verde { border-left: 5px solid #27ae60; background: #f0fff4; }
        .res-azul { border-left: 5px solid #2980b9; background: #eef7fc; }

        .res-titulo { font-weight: 800; margin-bottom: 5px; display: block; font-size: 14px;}
        .res-rojo .res-titulo { color: #C0392B; }
        .res-verde .res-titulo { color: #27ae60; }
        .res-azul .res-titulo { color: #2980b9; }

        /* SIMBOLOG√çA */
        .leyenda-box {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        .leyenda-box h4 { margin: 0 0 10px 0; font-size: 12px; color: #666; }
        .item-leyenda { font-size: 11px; margin-bottom: 6px; display: flex; align-items: center; color: #444; }
        .dot { width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 2px; }
        
        .bg-rojo { background: rgba(192, 57, 43, 0.6); border: 1px solid #C0392B; }
        .bg-azul { border: 2px solid #3498db; }
        .bg-verde { background: rgba(39, 174, 96, 0.6); border: 1px solid #27ae60; }

        /* --- 4. MAPA --- */
        #map {
            flex: 1; /* Toma todo el espacio restante */
            height: 100%;
            z-index: 1;
        }

        /* --- POPUPS --- */
        .leaflet-popup-content-wrapper { border-radius: 0; padding: 0; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
        
        .popup-head { padding: 10px; color: white; font-weight: bold; text-align: center; font-size: 13px; }
        .popup-body { padding: 15px; font-size: 12px; line-height: 1.4; color: #333; }
        
        .list-check { list-style: none; padding: 0; margin: 5px 0; }
        .list-check li::before { content: "‚úÖ "; }
        .list-cross { list-style: none; padding: 0; margin: 5px 0; color: #C0392B; }
        .list-cross li::before { content: "üö´ "; }

        /* RESPONSIVO CELULAR */
        @media (max-width: 768px) {
            .main-wrapper { flex-direction: column-reverse; } /* Panel abajo en celular */
            .sidebar { width: 100%; height: 40%; }
            #map { height: 60%; }
            .gob-header { justify-content: center; } /* Logo centrado */
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-wrapper">
        
        <!-- PANEL IZQUIERDO -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta Ciudadana</h3>
                <p>Verifica el uso de suelo y evita fraudes.</p>
            </div>

            <div class="sidebar-body">
                <!-- GPS -->
                <div class="control-group">
                    <label class="label-titulo">1. Ubicaci√≥n Actual</label>
                    <button id="btn-gps" class="btn-full">
                        üìç USAR MI GPS
                    </button>
                    <div id="status-gps" style="font-size:11px; margin-top:5px; color:#666; text-align:center;"></div>
                </div>

                <div class="divider">O BUSCA UNA DIRECCI√ìN</div>

                <!-- BUSCADOR -->
                <div class="control-group">
                    <label class="label-titulo">2. Buscar Direcci√≥n</label>
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">üîé</button>
                    </div>
                </div>

                <!-- CAJA DE RESULTADOS (Se llena sola) -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <span id="res-titulo" class="res-titulo">RESULTADO</span>
                    <p id="res-texto" style="margin:5px 0;"></p>
                    <div id="res-detalles"></div>
                </div>

                <!-- LEYENDA -->
                <div class="leyenda-box">
                    <h4>Simbolog√≠a del Mapa</h4>
                    <div class="item-leyenda"><span class="dot bg-rojo"></span> Suelo de Conservaci√≥n (Restringido)</div>
                    <div class="item-leyenda"><span class="dot bg-azul"></span> Zonificaci√≥n (Reglas PGOEDF)</div>
                    <div class="item-leyenda"><span class="dot bg-verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <!-- L√ìGICA DEL SISTEMA -->
    <script>
        // --- 1. BASE DE DATOS PGOEDF (REGLAS) ---
        const reglas = {
            "Forestal de Conservaci√≥n": {
                perm: ["Reforestaci√≥n", "Vigilancia", "Ecoturismo"],
                proh: ["VIVIENDA", "Agricultura", "Ganader√≠a", "Calles"]
            },
            "Forestal de Conservaci√≥n Especial": {
                perm: ["Turismo sustentable", "Viveros", "Apicultura"],
                proh: ["ASENTAMIENTOS", "Industria", "Miner√≠a"]
            },
            "Forestal de Protecci√≥n": {
                perm: ["Obras conservaci√≥n", "Reforestaci√≥n"],
                proh: ["Urbanizaci√≥n", "Tiraderos", "Pastoreo"]
            },
            "Agroforestal": {
                perm: ["Cultivos", "Frutales", "Le√±a dom√©stica"],
                proh: ["Fraccionamientos", "Industria", "Tala"]
            },
            "Agroecol√≥gica": {
                perm: ["Agricultura intensiva", "Venta productos"],
                proh: ["Uso Habitacional", "Centros comerciales"]
            },
            "Agroecol√≥gica Especial": {
                perm: ["Chinampas", "Turismo canales"],
                proh: ["Relleno canales", "Construcci√≥n casas"]
            }
        };

        function getInfo(nombre) {
            if(!nombre) return null;
            for(let key in reglas) {
                if(nombre.toUpperCase().includes(key.toUpperCase())) return {nombre: key, ...reglas[key]};
            }
            return { nombre: "Zona Regulada", perm: ["Consulta SEDEMA"], proh: ["Actividades no autorizadas"] };
        }

        // --- 2. INICIALIZAR MAPA ---
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.15], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.7, attribution: 'CARTO' }).addTo(map);

        // Capas para guardar datos
        var layerSuelo = L.layerGroup().addTo(map);
        var layerZoni = L.geoJSON(null, {
            style: { color: '#3498db', weight: 2, fillOpacity: 0.05 },
            onEachFeature: function(feature, layer) {
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    analizar(e.latlng);
                });
            }
        }).addTo(map);

        // --- 3. CARGAR ARCHIVOS ---
        
        // Rojo (Suelo Conservaci√≥n)
        fetch('suelo-de-conservacion-2020.geojson').then(r=>r.json()).then(d=>{
            L.geoJSON(d, {
                style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.2, weight: 0 },
                interactive: false
            }).addTo(layerSuelo);
        });

        // Azul (Zonificaci√≥n - L√≥gica)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r=>r.json()).then(d=>{
            layerZoni.addData(d);
        }).catch(e => alert("Error: No se encuentra el archivo 'zoonificaci√≥n_pgoedf_2000.geojson'. Verifica el nombre en GitHub."));

        // Verde (ANP - Opcional)
        fetch('anp.geojson').then(r=>r.json()).then(d=>{
            L.geoJSON(d, {style:{color:'#27ae60', fillOpacity:0.3}}).addTo(map);
        });

        // --- 4. FUNCI√ìN MAESTRA: ANALIZAR PUNTO ---
        var pinActual;

        function analizar(latlng, origenTexto) {
            // Mover mapa
            map.setView(latlng, 16);
            if(pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);

            // Verificar PIP
            var results = leafletPip.pointInLayer(latlng, layerZoni);
            
            var html = "", clase = "", titulo = "", texto = "";

            if(results.length > 0) {
                // ZONA PROHIBIDA
                var p = results[0].feature.properties;
                var rawName = p.DESCRIPCIO || p.ZONA || p.TIPO || "Zona";
                var info = getInfo(rawName);
                var uga = p.UGA || p.CLAVE || "";

                titulo = "üö´ SUELO DE CONSERVACI√ìN";
                clase = "res-rojo";
                texto = `Est√°s en: <strong>${info.nombre}</strong> (UGA ${uga})`;
                
                var listaNo = info.proh.map(x=>`<li>${x}</li>`).join("");
                
                html = `
                    <div style="background:#C0392B; color:white; padding:10px; text-align:center; font-weight:bold;">${titulo}</div>
                    <div style="padding:10px; font-family:Montserrat;">
                        <p style="font-size:12px; margin-bottom:5px;">${texto}</p>
                        <div style="background:#ffebee; border:1px solid red; padding:5px;">
                            <strong style="color:red; font-size:11px;">PROHIBIDO:</strong>
                            <ul style="color:red; font-size:11px; padding-left:15px; margin:0;">${listaNo}</ul>
                        </div>
                    </div>
                `;
            } else {
                // SUELO URBANO
                titulo = "‚úÖ SUELO URBANO";
                clase = "res-verde";
                texto = "Ubicaci√≥n fuera de la zonificaci√≥n de conservaci√≥n.";
                html = `
                    <div style="background:#27ae60; color:white; padding:10px; text-align:center; font-weight:bold;">${titulo}</div>
                    <div style="padding:10px; font-family:Montserrat;">
                        <p style="font-size:12px;">${texto}</p>
                        <small>Consulta uso habitacional en SEDUVI.</small>
                    </div>
                `;
            }

            // Popup
            pinActual.bindPopup(html, {minWidth:250}).openPopup();

            // Panel Lateral
            var panel = document.getElementById('panel-resultados');
            panel.style.display = "block";
            panel.className = "result-container " + clase;
            document.getElementById('res-titulo').innerText = titulo;
            document.getElementById('res-texto').innerHTML = texto;
            document.getElementById('res-detalles').innerHTML = (results.length > 0) ? 
                `<small><strong>Regla PGOEDF:</strong> ${info.proh.join(", ")} prohibido.</small>` : "";
        }

        // Clic en mapa vac√≠o
        map.on('click', function(e) { analizar(e.latlng); });

        // --- 5. BOTONES ---
        
        // GPS
        document.getElementById('btn-gps').addEventListener('click', function() {
            document.getElementById('status-gps').innerText = "üõ∞Ô∏è Buscando se√±al...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });
        map.on('locationfound', e => {
            document.getElementById('status-gps').innerText = "";
            analizar(e.latlng);
        });
        map.on('locationerror', () => alert("Activa tu GPS."));

        // Buscador
        document.getElementById('btn-buscar').addEventListener('click', function() {
            var q = document.getElementById('input-busqueda').value;
            if(!q) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}+CDMX&limit=1`)
            .then(r=>r.json())
            .then(d=>{
                if(d.length) analizar([d[0].lat, d[0].lon]);
                else alert("No encontrado");
            });
        });

    </script>
</body>
</html>
