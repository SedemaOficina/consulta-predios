<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9d2148">
    <meta name="description" content="Consulta el uso de suelo en Suelo de Conservaci√≥n CDMX. Evita fraudes.">
    
    <title>Validador de Predios | SEDEMA</title>
    
    <!-- FUENTES Y LIBRERIAS -->
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css">
    
    <!-- Librer√≠a para detectar puntos dentro de pol√≠gonos (Vital para alertas autom√°ticas) -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
</head>
<body>

    <!-- ENCABEZADO DE IMPRESI√ìN (OCULTO EN PANTALLA) -->
    <div id="print-header">
        <div style="display:flex; align-items:center; justify-content:center; gap:20px; border-bottom:2px solid #9d2148; padding-bottom:10px; margin-bottom:20px;">
            <img src="logo-sedema.png" style="height: 60px;">
            <div>
                <h1 class="print-title">FICHA T√âCNICA INFORMATIVA</h1>
                <p class="print-date" id="fecha-impresion"></p>
            </div>
        </div>
        <div id="print-dynamic-content"></div>
    </div>

    <!-- HEADER WEB -->
    <header class="gob-header">
        <div class="header-inner">
            <img src="logo-sedema.png" alt="Logo SEDEMA" class="logo-cdmx">
            <div class="vertical-line"></div>
            <div class="dependency-name">
                <h1>SECRETAR√çA DEL<br>MEDIO AMBIENTE</h1>
            </div>
        </div>
        <div class="header-right">
            <a href="#educacion" class="btn-link">Ver Informaci√≥n Ambiental</a>
        </div>
    </header>

    <!-- SECCI√ìN MAPA -->
    <section class="map-section">
        <div id="map"></div>

        <!-- TARJETA FLOTANTE (PANEL DE CONTROL) -->
        <div class="info-card">
            <div class="card-header">
                <h2>Consulta de Predios</h2>
                <p>Verifica reglas y zonificaci√≥n antes de comprar.</p>
            </div>
            
            <div class="card-body">
                <!-- GPS -->
                <div class="action-section">
                    <button id="btn-gps" class="btn-block btn-guinda">
                        üìç UBICARME EN EL TERRENO (GPS)
                    </button>
                    <p id="gps-status" class="status-text"></p>
                </div>

                <!-- BUSCADOR -->
                <div class="search-wrapper">
                    <input type="text" id="search-input" placeholder="Calle, Colonia o Coordenadas...">
                    <button id="btn-search" class="btn-search">üîç</button>
                </div>

                <!-- LEYENDA DIN√ÅMICA -->
                <div class="results-area">
                    <h3>Capas Disponibles (Men√∫ Arriba Derecha)</h3>
                    <div class="legend-item"><span class="color-box guinda-fill"></span> Suelo Conservaci√≥n (Restringido)</div>
                    <div class="legend-item"><span class="color-box azul-fill"></span> Zonificaci√≥n (Reglas de Uso)</div>
                    <div class="legend-item"><span class="color-box verde-fill"></span> √Åreas Naturales Protegidas</div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

                <button onclick="imprimirFicha()" class="btn-block btn-print">üñ®Ô∏è DESCARGAR FICHA PDF</button>
            </div>
            <div class="mobile-toggle" id="mobile-toggle">Ver Mapa Completo ‚¨á</div>
        </div>
    </section>

    <!-- SECCI√ìN EDUCACI√ìN AMBIENTAL -->
    <section id="educacion" class="info-section">
        <div class="container">
            <h2 class="section-title">¬øPor qu√© cuidamos el Suelo de Conservaci√≥n?</h2>
            <div class="grid-cards">
                <div class="service-card">
                    <div class="icon">üíß</div>
                    <h3>Agua</h3>
                    <p>Aqu√≠ se recarga el 60% del agua que consume la CDMX.</p>
                </div>
                <div class="service-card">
                    <div class="icon">üå≥</div>
                    <h3>Aire Limpio</h3>
                    <p>Nuestros bosques capturan contaminantes y regulan la temperatura.</p>
                </div>
                <div class="service-card">
                    <div class="icon">‚öñÔ∏è</div>
                    <h3>Legalidad</h3>
                    <p>Comprar aqu√≠ es un delito. No tendr√°s escrituras ni servicios.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- ADVERTENCIA LEGAL AL IMPRIMIR -->
    <div class="print-warning" style="display:none;">
        <p><strong>AVISO LEGAL:</strong> Este documento es de car√°cter informativo basado en el PGOEDF. No constituye una autorizaci√≥n, licencia ni permiso de construcci√≥n. La venta de terrenos en Suelo de Conservaci√≥n sin autorizaci√≥n es un delito. Para tr√°mites oficiales acuda a la Ventanilla √önica de SEDEMA.</p>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
        // =====================================================
        // 1. BASE DE DATOS DE REGLAS (PGOEDF P√°g 116-117)
        // =====================================================
        const reglasPGOEDF = {
            "Forestal de Conservaci√≥n": {
                codigo: "FC",
                descripcion: "Zona de alto valor biol√≥gico. Prioridad: Recarga de acu√≠feros.",
                permitido: ["Reforestaci√≥n", "Investigaci√≥n", "Vigilancia Ambiental", "Ecoturismo (Senderos)"],
                prohibido: ["VIVIENDA (Casas)", "Agricultura", "Ganader√≠a", "Apertura de calles", "Tala"]
            },
            "Forestal de Conservaci√≥n Especial": {
                codigo: "FCE",
                descripcion: "Zonas boscosas con presi√≥n productiva. Manejo sustentable.",
                permitido: ["Turismo sustentable", "Viveros", "Apicultura", "Cultivo de hongos"],
                prohibido: ["NUEVOS ASENTAMIENTOS", "Industria", "Miner√≠a", "Cambio de uso a urbano"]
            },
            "Forestal de Protecci√≥n": {
                codigo: "FP",
                descripcion: "Zonas de transici√≥n. Requieren restauraci√≥n.",
                permitido: ["Obras conservaci√≥n suelo", "Reforestaci√≥n"],
                prohibido: ["Urbanizaci√≥n", "Tiraderos de basura", "Pastoreo extensivo"]
            },
            "Forestal de Protecci√≥n Especial": {
                codigo: "FPE",
                descripcion: "√Åreas con vegetaci√≥n natural que requieren frenar el deterioro.",
                permitido: ["Agroforester√≠a", "Pastoreo controlado", "Manejo vida silvestre"],
                prohibido: ["Crecimiento urbano", "Quemas agr√≠colas", "Agroqu√≠micos"]
            },
            "Agroforestal": {
                codigo: "AF",
                descripcion: "Zona de transici√≥n bosque-cultivo.",
                permitido: ["Cultivos tradicionales", "Frutales", "Le√±a (dom√©stico)"],
                prohibido: ["Fraccionamientos", "Industria contaminante", "Tala rasa"]
            },
            "Agroforestal Especial": {
                codigo: "AFE",
                descripcion: "Zona agr√≠cola con manchones de bosque.",
                permitido: ["Cultivos anuales", "Hortalizas", "Invernaderos"],
                prohibido: ["Nuevas construcciones", "Miner√≠a a cielo abierto"]
            },
            "Agroecol√≥gica": {
                codigo: "AE",
                descripcion: "Zona agr√≠cola de alta productividad.",
                permitido: ["Agricultura intensiva", "Venta productos agr√≠colas"],
                prohibido: ["Cambio a habitacional", "Centros comerciales", "Industria"]
            },
            "Agroecol√≥gica Especial": {
                codigo: "AEE",
                descripcion: "Zona de Humedales y Chinampas.",
                permitido: ["Agricultura chinampera", "Turismo canales", "Pesca tradicional"],
                prohibido: ["Relleno canales", "Construcci√≥n casas", "Drenaje en canales"]
            }
        };

        function obtenerReglas(texto) {
            if(!texto) return reglasPGOEDF["Forestal de Conservaci√≥n"]; // Default preventivo
            for (let key in reglasPGOEDF) {
                if (texto.toUpperCase().includes(key.toUpperCase())) return reglasPGOEDF[key];
            }
            return reglasPGOEDF["Forestal de Conservaci√≥n"];
        }

        // =====================================================
        // 2. INICIALIZAR MAPA
        // =====================================================
        var map = L.map('map', { zoomControl: false }).setView([19.25, -99.15], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var mapaBase = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' });
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        
        map.addLayer(mapaSatelite); // Sat√©lite por defecto

        // Grupos de Capas
        var layerSueloConservacion = L.layerGroup().addTo(map);
        var layerZonificacion = L.layerGroup(); // Desactivada por defecto para no saturar
        var layerANP = L.layerGroup().addTo(map);

        var baseMaps = { "Sat√©lite (Bosque)": mapaSatelite, "Mapa Claro": mapaBase };
        var overlayMaps = {
            "üî¥ Suelo de Conservaci√≥n": layerSueloConservacion,
            "üîµ Zonificaci√≥n (PGOEDF)": layerZonificacion,
            "üü¢ √Åreas Protegidas": layerANP
        };
        L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);

        // =====================================================
        // 3. CARGAR ARCHIVOS GEOJSON
        // =====================================================

        // A) SUELO DE CONSERVACI√ìN (TU CAPA PRINCIPAL)
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#9d2148', fillColor: '#9d2148', fillOpacity: 0.25, weight: 1 },
                    onEachFeature: (f, l) => l.bindPopup(`<h3 style="color:#9d2148">üö´ ZONA PROHIBIDA</h3>Suelo de Conservaci√≥n`)
                }).addTo(layerSueloConservacion);
            });

        // B) ZONIFICACI√ìN (TU CAPA CON EL NOMBRE ESPEC√çFICO)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => {
                if(!r.ok) throw new Error("Archivo no encontrado");
                return r.json();
            })
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#3498db', weight: 1, fillOpacity: 0.1 }, 
                    onEachFeature: function(feature, layer) {
                        var p = feature.properties;
                        // Ajusta esto seg√∫n tus columnas reales (UGA, ZONA, TIPO, DESCRIPCION)
                        var nombreZona = p.DESCRIPCIO || p.ZONA || p.TIPO || "Zona Regulada";
                        var info = obtenerReglas(nombreZona);
                        
                        var listaSi = info.permitido.map(i => `<li>‚úÖ ${i}</li>`).join("");
                        var listaNo = info.prohibido.map(i => `<li>üö´ ${i}</li>`).join("");

                        var html = `
                            <div style="font-family:'Roboto', sans-serif; min-width:260px;">
                                <div style="background:#3498db; color:white; padding:8px; text-align:center;">
                                    <b>ZONIFICACI√ìN: ${info.codigo}</b>
                                </div>
                                <div style="padding:10px;">
                                    <strong>${nombreZona}</strong>
                                    <p style="font-size:11px;">${info.descripcion}</p>
                                    <div style="background:#fceceb; padding:5px; margin:5px 0;">
                                        <b style="color:#c0392b; font-size:11px;">PROHIBIDO:</b>
                                        <ul style="font-size:10px; padding-left:15px; margin:0; color:#c0392b;">${listaNo}</ul>
                                    </div>
                                    <div style="background:#e8f5e9; padding:5px;">
                                        <b style="color:#2e7d32; font-size:11px;">PERMITIDO:</b>
                                        <ul style="font-size:10px; padding-left:15px; margin:0; color:#2e7d32;">${listaSi}</ul>
                                    </div>
                                </div>
                            </div>
                        `;
                        layer.bindPopup(html);
                    }
                }).addTo(layerZonificacion);
            })
            .catch(e => console.log("Error cargando zonificaci√≥n:", e));

        // C) ANP (OPCIONAL)
        fetch('anp.geojson').then(r => r.json()).then(d => {
            L.geoJSON(d, { style: {color:'green', fillOpacity:0.4, weight:1} }).addTo(layerANP);
        }).catch(e => console.log("Sin capa ANP"));

        // =====================================================
        // 4. FUNCIONALIDAD (GPS, BUSCADOR, IMPRIMIR)
        // =====================================================

        // IMPRIMIR FICHA
        window.imprimirFicha = function() {
            var fecha = new Date().toLocaleString();
            document.getElementById('fecha-impresion').innerText = fecha;
            
            // Intentar obtener info del centro del mapa
            var centro = map.getCenter();
            var contenidoExtra = "<p>Ubicaci√≥n consultada en mapa.</p>";
            
            if(layerZonificacion.getLayers().length > 0 && leafletPip) {
                var capaGeo = layerZonificacion.getLayers()[0];
                var res = leafletPip.pointInLayer(centro, capaGeo);
                if(res.length > 0) {
                    var p = res[0].feature.properties;
                    var nom = p.DESCRIPCIO || p.ZONA || "Zona Regulada";
                    var reglas = obtenerReglas(nom);
                    contenidoExtra = `
                        <div style="border:1px solid #ccc; padding:15px; margin:10px 0;">
                            <h3>Diagn√≥stico: ${nom}</h3>
                            <p><strong>Uso Permitido:</strong> ${reglas.permitido.join(", ")}</p>
                            <p><strong>PROHIBIDO:</strong> ${reglas.prohibido.join(", ")}</p>
                        </div>
                    `;
                }
            }
            document.getElementById('print-dynamic-content').innerHTML = contenidoExtra;
            
            document.querySelector('.print-warning').style.display = 'block';
            window.print();
            setTimeout(() => document.querySelector('.print-warning').style.display = 'none', 1000);
        };

        // GPS
        const btnGps = document.getElementById('btn-gps');
        const statusText = document.getElementById('gps-status');
        btnGps.addEventListener('click', () => {
            statusText.innerText = "Localizando...";
            map.locate({setView: true, maxZoom: 16});
        });
        map.on('locationfound', e => {
            statusText.innerText = "Ubicaci√≥n encontrada";
            L.circleMarker(e.latlng, {radius:8, fillColor:"blue", color:"white", fillOpacity:1}).addTo(map).bindPopup("Tu ubicaci√≥n").openPopup();
            detectarRiesgo(e.latlng);
        });

        // BUSCADOR
        document.getElementById('btn-search').addEventListener('click', () => {
            var q = document.getElementById('search-input').value;
            if(!q) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}+CDMX&limit=1`)
                .then(r => r.json())
                .then(d => {
                    if(d.length) {
                        var latlng = [d[0].lat, d[0].lon];
                        map.setView(latlng, 16);
                        L.marker(latlng).addTo(map).bindPopup(d[0].display_name).openPopup();
                        detectarRiesgo({lat: d[0].lat, lng: d[0].lon});
                    } else { alert("No encontrado"); }
                });
        });

        // DETECCI√ìN AUTOM√ÅTICA
        function detectarRiesgo(latlng) {
            setTimeout(() => {
                var capas = layerSueloConservacion.getLayers();
                if(capas.length > 0) {
                    var inside = false;
                    capas.forEach(l => { if(leafletPip.pointInLayer(latlng, l).length) inside = true; });
                    if(inside) alert("‚ö†Ô∏è ALERTA: Esta ubicaci√≥n est√° en SUELO DE CONSERVACI√ìN. Verifica la zonificaci√≥n.");
                }
            }, 500);
        }

        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.info-card').classList.toggle('collapsed');
        });

        // SERVICE WORKER
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

    </script>
</body>
</html>
