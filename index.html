<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- LEAFLET Y LIBRER√çAS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- VINCULACI√ìN AL CSS EXTERNO -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- ENCABEZADO -->
    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX" class="logo-img">
        </div>
        <div class="header-text">
            <h1>SECRETAR√çA DEL MEDIO AMBIENTE</h1>
            <h2>Sistema de Ordenamiento Ecol√≥gico</h2>
        </div>
    </header>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-wrapper">
        
        <!-- PANEL LATERAL (IZQUIERDA) -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>üîç Consulta de Predios</h3>
                <p>Verifica reglas de uso de suelo (PGOEDF).</p>
            </div>

            <div class="sidebar-body">
                <!-- 1. GPS -->
                <div class="control-group">
                    <label>Opci√≥n A: Ub√≠came aqu√≠</label>
                    <button id="btn-gps" class="btn-full btn-guinda">
                        üìç USAR MI UBICACI√ìN ACTUAL
                    </button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O</span></div>

                <!-- 2. BUSCADOR -->
                <div class="control-group">
                    <label>Opci√≥n B: Direcci√≥n o Coordenadas</label>
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Ej: 19.243, -99.123 o Calle...">
                        <button id="btn-buscar">üîé</button>
                    </div>
                    <small style="color:#666; font-size:10px;">Tip: Puedes pegar coordenadas de Google Maps.</small>
                </div>

                <!-- 3. RESULTADOS (Din√°mico) -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <h4 id="res-titulo">RESULTADO</h4>
                    <p id="res-zona" style="font-weight:bold; margin-bottom:5px;"></p>
                    <div id="res-reglas"></div>
                </div>

                <!-- 4. SIMBOLOG√çA -->
                <div class="leyenda-box">
                    <h4>Simbolog√≠a</h4>
                    <div class="item"><span class="dot rojo"></span> Suelo de Conservaci√≥n (Restringido)</div>
                    <div class="item"><span class="dot azul"></span> Zonificaci√≥n (PGOEDF)</div>
                    <div class="item"><span class="dot verde"></span> √Åreas Naturales Protegidas</div>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>

    <script>
        // ==========================================
        // 1. BASE DE DATOS DEL PGOEDF (PDF)
        // ==========================================
        const reglasPGOEDF = {
            "Forestal de Conservaci√≥n": {
                codigo: "FC",
                desc: "Zona de alto valor biol√≥gico. Prioridad: Recarga de acu√≠feros.",
                permitido: ["Reforestaci√≥n", "Investigaci√≥n", "Vigilancia Ambiental", "Ecoturismo"],
                prohibido: ["VIVIENDA", "Agricultura", "Ganader√≠a", "Apertura de calles", "Tala"]
            },
            "Forestal de Conservaci√≥n Especial": {
                codigo: "FCE",
                desc: "Bosque con manejo sustentable.",
                permitido: ["Turismo sustentable", "Viveros", "Apicultura", "Cultivo de hongos"],
                prohibido: ["NUEVOS ASENTAMIENTOS", "Industria", "Miner√≠a", "Cambio de uso a urbano"]
            },
            "Forestal de Protecci√≥n": {
                codigo: "FP",
                desc: "Zona de transici√≥n. Requiere restauraci√≥n.",
                permitido: ["Obras conservaci√≥n suelo", "Reforestaci√≥n"],
                prohibido: ["Urbanizaci√≥n", "Tiraderos de basura", "Pastoreo extensivo"]
            },
            "Agroforestal": {
                codigo: "AF",
                desc: "Zona mixta bosque-cultivo.",
                permitido: ["Cultivos tradicionales", "Frutales", "Le√±a dom√©stica"],
                prohibido: ["Fraccionamientos", "Industria", "Tala rasa"]
            },
            "Agroforestal Especial": {
                codigo: "AFE",
                desc: "Zona agr√≠cola con manchones de bosque.",
                permitido: ["Cultivos anuales", "Hortalizas", "Invernaderos", "Ganader√≠a controlada"],
                prohibido: ["Nuevas construcciones urbanas", "Miner√≠a"]
            },
            "Agroecol√≥gica": {
                codigo: "AE",
                desc: "Zona agr√≠cola de alta productividad.",
                permitido: ["Agricultura intensiva", "Venta productos agr√≠colas"],
                prohibido: ["Cambio a uso habitacional", "Centros comerciales", "Industria"]
            },
            "Agroecol√≥gica Especial": {
                codigo: "AEE",
                desc: "Zona de Humedales y Chinampas.",
                permitido: ["Agricultura chinampera", "Turismo canales", "Pesca tradicional"],
                prohibido: ["Relleno de canales", "Construcci√≥n de casas", "Drenaje en canales"]
            }
        };

        function getReglas(nombre) {
            if(!nombre) return null;
            for(let key in reglasPGOEDF) {
                if(nombre.toUpperCase().includes(key.toUpperCase())) return reglasPGOEDF[key];
            }
            // Default preventivo
            return { 
                codigo: "SC", 
                desc: "Suelo de Conservaci√≥n Regulado.",
                permitido: ["Consulta a la autoridad"], 
                prohibido: ["Urbanizaci√≥n no autorizada"] 
            };
        }

        // ==========================================
        // 2. INICIALIZAR MAPA
        // ==========================================
        var map = L.map('map', { zoomControl: false }).setView([19.28, -99.13], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.8, attribution: 'CARTO' }).addTo(map);

        // Capas
        var layerSuelo = L.layerGroup().addTo(map);
        var layerZoni = L.geoJSON(null, {
            style: { color: '#3498db', weight: 1, fillOpacity: 0.05 },
            onEachFeature: function(feature, layer) {
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    analizarPunto(e.latlng);
                });
            }
        }).addTo(map);

        // --- CARGAR DATOS ---
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#C0392B', fillColor: '#C0392B', fillOpacity: 0.25, weight: 0 },
                    interactive: false
                }).addTo(layerSuelo);
            });

        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => r.json())
            .then(data => layerZoni.addData(data))
            .catch(e => console.error("Error cargando zonificaci√≥n:", e));

        fetch('anp.geojson').then(r => r.json()).then(d => {
            L.geoJSON(d, {style:{color:'#27ae60', fillOpacity:0.3, weight:1}}).addTo(map);
        }).catch(e=>{}); // Ignorar si no existe

        // ==========================================
        // 3. L√ìGICA DE AN√ÅLISIS
        // ==========================================
        var pinActual;

        function analizarPunto(latlng, origenTexto) {
            map.setView(latlng, 17); // Zoom profundo
            if(pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);

            // Verificar Pol√≠gono (PIP)
            var results = leafletPip.pointInLayer(latlng, layerZoni);
            
            // Elementos DOM
            var panel = document.getElementById('panel-resultados');
            var titulo = document.getElementById('res-titulo');
            var zona = document.getElementById('res-zona');
            var divReglas = document.getElementById('res-reglas');
            
            panel.style.display = "block";

            var htmlPopup = "";

            if (results.length > 0) {
                // --- DENTRO DE ZONA RESTRINGIDA ---
                var p = results[0].feature.properties;
                var nombre = p.DESCRIPCIO || p.ZONA || p.TIPO || "Zona Regulada";
                var uga = p.UGA || p.CLAVE || "S/D";
                var info = getReglas(nombre);

                // Listas
                var liNo = info.prohibido.map(x=>`<li>${x}</li>`).join("");
                var liSi = info.permitido.map(x=>`<li>${x}</li>`).join("");

                // Actualizar Panel Lateral
                panel.className = "result-container alerta-roja";
                titulo.innerText = "üö´ SUELO DE CONSERVACI√ìN";
                zona.innerHTML = `${info.desc}<br><small>Clave: ${info.codigo} (UGA ${uga})</small>`;
                
                divReglas.innerHTML = `
                    <div class="box prohibido">
                        <strong>PROHIBIDO:</strong>
                        <ul>${liNo}</ul>
                    </div>
                    <div class="box permitido">
                        <strong>PERMITIDO:</strong>
                        <ul>${liSi}</ul>
                    </div>
                `;

                // HTML Popup
                htmlPopup = `
                    <div style="font-family:Montserrat; text-align:center;">
                        <h4 style="color:#C0392B; margin:0;">‚ö†Ô∏è ZONA RESTRINGIDA</h4>
                        <p style="font-size:11px; margin:5px 0;">${nombre}</p>
                        <div style="background:#ffebee; border:1px solid #C0392B; padding:5px; text-align:left;">
                            <strong style="color:#C0392B; font-size:10px;">PROHIBIDO:</strong>
                            <ul style="font-size:10px; margin:0; padding-left:15px;">${liNo}</ul>
                        </div>
                    </div>
                `;

            } else {
                // --- SUELO URBANO ---
                panel.className = "result-container alerta-verde";
                titulo.innerText = "‚úÖ SUELO URBANO";
                zona.innerText = "Fuera de la zonificaci√≥n de conservaci√≥n.";
                divReglas.innerHTML = `
                    <p style="font-size:12px;">Esta ubicaci√≥n no presenta restricciones del Programa de Ordenamiento Ecol√≥gico (PGOEDF).</p>
                    <small>Se recomienda verificar el uso de suelo habitacional en SEDUVI y Registro P√∫blico.</small>
                `;

                htmlPopup = `
                    <div style="font-family:Montserrat; text-align:center;">
                        <h4 style="color:#27ae60; margin:0;">‚úÖ SUELO URBANO</h4>
                        <p style="font-size:11px;">Zona sin restricci√≥n ambiental aparente.</p>
                    </div>
                `;
            }

            // Abrir Popup
            pinActual.bindPopup(htmlPopup, {minWidth:220}).openPopup();
        }

        // Clic en mapa
        map.on('click', function(e) { analizarPunto(e.latlng); });

        // ==========================================
        // 4. FUNCIONALIDAD DE B√öSQUEDA
        // ==========================================
        
        function ejecutarBusqueda() {
            var input = document.getElementById('input-busqueda').value.trim();
            if(!input) return;

            // 1. DETECCI√ìN DE COORDENADAS (Regex)
            // Acepta formatos: "19.23, -99.12" o "19.23 -99.12"
            var coordMatch = input.match(/^(-?\d+(\.\d+)?)[,\s]+(-?\d+(\.\d+)?)$/);

            if (coordMatch) {
                var lat = parseFloat(coordMatch[1]);
                var lng = parseFloat(coordMatch[3]);
                
                if (lat >= 18 && lat <= 20 && lng >= -100 && lng <= -98) { // Validar rango CDMX aprox
                    analizarPunto([lat, lng]);
                } else {
                    alert("Coordenadas fuera del rango de la CDMX.");
                }
            } else {
                // 2. B√öSQUEDA DE TEXTO (NOMINATIM)
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}+CDMX&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data.length > 0) {
                        analizarPunto([data[0].lat, data[0].lon]);
                    } else {
                        alert("Direcci√≥n no encontrada. Intenta buscar por Colonia.");
                    }
                })
                .catch(() => alert("Error de conexi√≥n."));
            }
        }

        // Eventos
        document.getElementById('btn-buscar').addEventListener('click', ejecutarBusqueda);
        
        // EVENTO ENTER EN EL INPUT
        document.getElementById('input-busqueda').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                ejecutarBusqueda();
            }
        });

        // GPS
        document.getElementById('btn-gps').addEventListener('click', function() {
            var status = document.getElementById('status-gps');
            status.innerText = "üõ∞Ô∏è Buscando se√±al...";
            map.locate({setView: true, maxZoom: 17, enableHighAccuracy: true});
        });

        map.on('locationfound', e => {
            document.getElementById('status-gps').innerText = "";
            analizarPunto(e.latlng);
        });
        map.on('locationerror', () => {
            alert("Activa el GPS de tu dispositivo.");
            document.getElementById('status-gps').innerText = "";
        });

    </script>
</body>
</html>
