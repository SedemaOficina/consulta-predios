<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor de Consulta Ciudadana | SEDEMA</title>
    
    <!-- Tailwind CSS (Estilos utilitarios) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuentes -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS (Mapa) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- Estilos Personalizados -->
    <link rel="stylesheet" href="styles.css">

    <!-- Librerías JS -->
    <!-- Leaflet (Mapa) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Geocoder (Búsqueda) -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <!-- PapaParse (Leer CSV) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <!-- Lucide Icons (Iconos ligeros) -->
    <script src="https://unpkg.com/lucide@latest"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.1",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.1/",
    "react/": "https://aistudiocdn.com/react@^19.2.1/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.556.0"
  }
}
</script>
</head>
<body class="bg-gray-100 h-screen flex flex-col md:flex-row overflow-hidden">

    <!-- SIDEBAR (Panel Izquierdo) -->
    <div id="sidebar" class="w-full md:w-[450px] bg-white shadow-xl z-20 flex flex-col h-[50vh] md:h-full overflow-hidden border-r border-gray-200 relative">
        
        <!-- Header -->
        <header class="p-6 bg-[#9d2449] text-white shrink-0 shadow-md z-10 relative">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-white rounded-lg flex items-center justify-center p-1 shadow-sm shrink-0">
                    <img src="./logo-sedema.png" alt="CDMX" class="w-full h-full object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-[#9d2449] font-bold text-xl\'>CDMX</span>'">
                </div>
                <div>
                    <h1 class="text-xl font-bold leading-tight font-serif tracking-tight">VISOR DE CONSULTA CIUDADANA</h1>
                    <p class="text-[10px] text-[#e0e0e0] uppercase tracking-wider font-medium mt-1">Secretaría del Medio Ambiente CDMX</p>
                </div>
            </div>
        </header>

        <!-- Contenido Scrollable -->
        <div id="sidebar-content" class="flex-1 overflow-y-auto p-6 space-y-6 relative">
            
            <!-- Pantalla de Carga -->
            <div id="loading-screen" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-[#9d2449] mb-4"></div>
                <h2 class="text-lg font-bold text-[#9d2449]">Cargando datos geográficos...</h2>
                <p class="text-sm text-gray-500 mt-2">Descargando capas de zonificación y límites.</p>
            </div>

            <!-- Sección de Búsqueda (No imprimir) -->
            <div class="space-y-4 no-print border-b border-gray-100 pb-6">
                
                <!-- Buscador Coordenadas -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Coordenadas</label>
                    <form id="coord-form" class="flex relative">
                        <input type="text" id="coord-input" placeholder="Ej. 19.4326, -99.1332" class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#9d2449] focus:border-transparent text-sm">
                        <div class="absolute left-3 top-2.5 text-gray-400 font-mono text-xs font-bold">XY</div>
                    </form>
                </div>

                <!-- Buscador Dirección -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Por Dirección</label>
                    <form id="address-form" class="flex relative">
                        <input type="text" id="address-input" placeholder="Calle, Colonia, Alcaldía..." class="w-full pl-9 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#9d2449] focus:border-transparent text-sm">
                        <i data-lucide="map-pin" class="absolute left-3 top-2.5 h-4 w-4 text-gray-400"></i>
                        <button type="submit" class="absolute right-2 top-1.5 p-1 bg-gray-100 rounded hover:bg-gray-200 text-gray-600">
                            <i data-lucide="search" class="h-4 w-4"></i>
                        </button>
                    </form>
                </div>

                <!-- Botones GPS y Reset -->
                <div class="flex gap-2 pt-1">
                    <button id="btn-gps" class="flex-1 py-2 px-3 bg-gray-800 text-white rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2 text-sm shadow-sm">
                        <i data-lucide="navigation" class="h-4 w-4"></i> Detectar mi ubicación
                    </button>
                    <button id="btn-reset" title="Reiniciar consulta" class="px-3 bg-gray-100 text-gray-600 border border-gray-300 rounded-lg hover:bg-white hover:text-[#9d2449] hover:border-[#9d2449] transition-all">
                        <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>

            <!-- Resultados (Oculto inicialmente) -->
            <div id="results-container" class="hidden space-y-6 animate-fade-in">
                
                <!-- Tarjeta de Estatus -->
                <div id="status-card" class="p-5 rounded-lg border-l-8 shadow-sm bg-gray-100 border-gray-400">
                    <div class="flex items-start gap-3">
                        <div id="status-icon" class="mt-1"></div>
                        <div>
                            <h2 id="status-title" class="text-lg font-bold uppercase text-gray-800">Estado</h2>
                            <p id="status-desc" class="text-sm mt-2 text-gray-800 leading-relaxed">Descripción del estado.</p>
                        </div>
                    </div>
                </div>

                <!-- Detalles Técnicos -->
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded border border-gray-200">
                        <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Alcaldía</span>
                        <span id="res-alcaldia" class="font-semibold text-gray-800">-</span>
                    </div>
                    <div class="bg-gray-50 p-3 rounded border border-gray-200">
                        <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Coordenadas</span>
                        <span id="res-coords" class="font-mono text-gray-800 text-xs">-</span>
                    </div>
                    <div id="zoning-container" class="col-span-2 bg-gray-50 p-3 rounded border border-gray-200 hidden">
                        <span class="block text-gray-500 text-[10px] uppercase font-bold tracking-wider mb-1">Zonificación (PGOEDF)</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="res-zoning-key" class="bg-[#b38e5d] text-white px-2 py-0.5 rounded text-xs font-bold shadow-sm"></span>
                            <span id="res-zoning-name" class="font-semibold text-gray-800"></span>
                        </div>
                    </div>
                </div>

                <!-- Lista de Actividades (Solo SC) -->
                <div id="activities-container" class="hidden space-y-1 pt-2">
                    <h3 class="text-sm font-bold text-gray-800 mb-3 border-b pb-1">Regulación de Uso de Suelo</h3>
                    
                    <!-- Permitidas -->
                    <details id="details-allowed" class="group rounded-lg border border-gray-200 overflow-hidden mb-3 bg-green-50/50" open>
                        <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none text-green-900 bg-green-200/60 hover:bg-green-200 transition-colors">
                            <div class="flex items-center gap-2 font-bold text-sm">
                                <i data-lucide="check-circle" class="h-4 w-4"></i>
                                <span>PERMITIDAS <span id="count-allowed" class="text-xs font-normal opacity-90">(0)</span></span>
                            </div>
                            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="px-4 py-3 bg-white border-t border-gray-100">
                            <ul id="list-allowed" class="list-disc pl-5 text-xs text-gray-600 space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></ul>
                        </div>
                    </details>

                    <!-- Condicionadas -->
                    <details id="details-conditioned" class="group rounded-lg border border-gray-200 overflow-hidden mb-3 bg-amber-50/50">
                        <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none text-amber-900 bg-amber-200/60 hover:bg-amber-200 transition-colors">
                            <div class="flex items-center gap-2 font-bold text-sm">
                                <i data-lucide="alert-circle" class="h-4 w-4"></i>
                                <span>CONDICIONADAS <span id="count-conditioned" class="text-xs font-normal opacity-90">(0)</span></span>
                            </div>
                            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="px-4 py-3 bg-white border-t border-gray-100">
                            <ul id="list-conditioned" class="list-disc pl-5 text-xs text-gray-600 space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></ul>
                        </div>
                    </details>

                    <!-- Prohibidas -->
                    <details id="details-prohibited" class="group rounded-lg border border-gray-200 overflow-hidden mb-3 bg-red-50/50">
                        <summary class="flex items-center justify-between px-4 py-3 cursor-pointer select-none text-red-900 bg-red-200/60 hover:bg-red-200 transition-colors">
                            <div class="flex items-center gap-2 font-bold text-sm">
                                <i data-lucide="x-circle" class="h-4 w-4"></i>
                                <span>PROHIBIDAS <span id="count-prohibited" class="text-xs font-normal opacity-90">(0)</span></span>
                            </div>
                            <i data-lucide="chevron-down" class="h-4 w-4 transition-transform group-open:rotate-180"></i>
                        </summary>
                        <div class="px-4 py-3 bg-white border-t border-gray-100">
                            <ul id="list-prohibited" class="list-disc pl-5 text-xs text-gray-600 space-y-2 max-h-60 overflow-y-auto custom-scrollbar"></ul>
                        </div>
                    </details>
                </div>

                <!-- Notas Legales -->
                <div class="mt-6 border-t border-gray-200 pt-4">
                    <h4 class="text-xs font-bold text-[#9d2449] uppercase mb-2">Notas Importantes</h4>
                    <ul id="legal-notes-list" class="list-disc pl-4 space-y-2">
                        <!-- Se llenará dinámicamente -->
                    </ul>
                </div>

                <!-- Timestamp -->
                <div class="text-right text-[10px] text-gray-400 border-t border-gray-100 pt-3">
                    Folio: <span id="folio-val"></span> <br/>
                    Fecha: <span id="date-val"></span>
                </div>
            </div>

            <!-- Estado Vacío -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-center text-gray-400">
                <div class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="map-pin" class="h-8 w-8 text-gray-300"></i>
                </div>
                <p class="text-sm font-medium text-gray-500">Sin ubicación seleccionada</p>
                <p class="text-xs mt-1 max-w-[200px]">Seleccione un punto en el mapa, busque una coordenada o dirección para iniciar.</p>
            </div>
        </div>

        <!-- Footer Acciones -->
        <div id="footer-actions" class="p-4 border-t border-gray-200 bg-gray-50 no-print hidden">
            <div class="flex gap-3 mb-4">
                <button onclick="window.print()" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:text-[#9d2449] hover:border-[#9d2449] font-medium text-sm transition-all shadow-sm">
                    <i data-lucide="printer" class="h-4 w-4"></i> Imprimir
                </button>
                <button id="btn-share" class="flex-1 flex items-center justify-center gap-2 py-2.5 px-4 bg-[#25D366] text-white rounded-lg hover:bg-[#20bd5a] font-medium text-sm transition-all shadow-sm">
                    <i data-lucide="share-2" class="h-4 w-4"></i> Compartir
                </button>
            </div>
            <p class="text-[9px] text-gray-400 text-justify leading-tight disclaimer-text"></p>
        </div>

        <!-- Footer Solo Impresión -->
        <div class="print-only p-8 border-t border-gray-300 mt-auto hidden">
            <p class="text-xs text-gray-500 text-justify font-serif disclaimer-text"></p>
            <div class="flex justify-between items-end mt-4">
                <p class="text-[10px] text-gray-400">Generado por Visor de Consulta Ciudadana SEDEMA.</p>
                <div class="w-20 h-10 border border-gray-300"></div> 
            </div>
        </div>
    </div>

    <!-- MAPA (Panel Derecho) -->
    <div class="flex-1 relative bg-gray-200 h-[50vh] md:h-full relative">
        <div id="map" class="h-full w-full z-10"></div>
        
        <!-- Leyenda -->
        <div class="absolute bottom-6 left-6 bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-gray-200 z-[400] text-xs space-y-2 pointer-events-none select-none no-print">
            <h4 class="font-bold text-[#9d2449] mb-1 font-serif border-b border-gray-100 pb-1">Simbología</h4>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-[#16a34a] border border-white shadow-sm"></span>
                <span>Suelo Urbano (Permitido)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-[#dc2626] border border-white shadow-sm"></span>
                <span>Suelo de Conservación (Restringido)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-gray-500 border border-white shadow-sm"></span>
                <span>Fuera de CDMX</span>
            </div>
            <div class="mt-2 pt-2 border-t border-gray-100 text-[10px] text-gray-500 italic">
                * Capas activables en el control superior
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL -->
    <script>
        // --- CONSTANTES ---
        const DATA_FILES = {
            LIMITES_CDMX: './limites_cdmx.geojson',
            LIMITES_ALCALDIAS: './limites_alcaldias.geojson',
            LIMITES_EDOMEX: './limites_edomex.geojson',
            LIMITES_MORELOS: './limites_morelos.geojson',
            SUELO_CONSERVACION: './suelo-de-conservacion-2020.geojson',
            ZONIFICACION: './zoonificación_pgoedf_2000.geojson',
            USOS_SUELO_CSV: './usos_suelo.csv'
        };

        const LEGAL_DISCLAIMER = "Esta plataforma es una versión de divulgación e información. Los resultados emitidos no producen efectos jurídicos vinculantes. Para trámites oficiales, consulte a la autoridad competente.";
        
        const LEGAL_NOTES = [
            "Adicionalmente a lo dispuesto en la tabla de usos del suelo, para cualquier obra o actividad que se pretenda desarrollar se deberán contemplar los criterios y lineamientos señalados en el programa de Ordenamiento Ecológico, así como cumplir con los permisos y autorizaciones en materia ambiental del Distrito Federal.",
            "Los usos del suelo no identificados en esta tabla deberán cumplir con los permisos y autorizaciones en materia urbana y ambiental aplicables en Suelo de Conservación.",
            "En las Areas Naturales Protegidas ANP regirá la zonificación especificada en su respectivo Programa de Manejo.",
            "La zonificación denominada PDU corresponde a las áreas normadas por los Programas Delegacionales o Parciales de Desarrollo Urbano vigentes.",
            "Las disposiciones de la presente regulación no prejuzgan sobre la propiedad de la tierra.",
            "El Suelo de Conservación definido por las barrancas estará regulado por la zonificación Forestal de Conservación FC, conforme a los límites establecidos por la Norma de Ordenación N° 21, señalada en los Programas de Desarrollo Urbano.",
            "Se instrumentará un programa de reconversión de esta actividad por la producción de composta. Para ello, se elaborará un padrón de los productores y diseñar y ejecutar un programa de capacitación y proponer paquetes tecnológicos para transferencia y el desarrollo de estudios de mercado para la sustitución progresiva del producto y la reducción de la extracción directa."
        ];

        // Cache de datos
        const dataCache = {
            cdmx: null, alcaldias: null, edomex: null, morelos: null, sc: null, zoning: null, rules: []
        };

        let map, marker, selectedResult = null;

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar Iconos
            lucide.createIcons();
            
            // Llenar textos legales
            document.querySelectorAll('.disclaimer-text').forEach(el => el.textContent = LEGAL_DISCLAIMER);
            const notesList = document.getElementById('legal-notes-list');
            LEGAL_NOTES.forEach(note => {
                const li = document.createElement('li');
                li.className = "text-[10px] text-gray-600 text-justify leading-relaxed";
                li.textContent = note;
                notesList.appendChild(li);
            });

            // Cargar Datos
            await loadAllData();
            
            // Inicializar Mapa
            initMap();
            
            // Configurar Eventos
            setupEventListeners();
        });

        // --- CARGA DE DATOS ---
        async function loadAllData() {
            try {
                const fetchJson = async (url) => {
                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error();
                        return await res.json();
                    } catch {
                        console.warn(`No se pudo cargar: ${url}`);
                        return { type: "FeatureCollection", features: [] };
                    }
                };

                const fetchCsv = (url) => new Promise(resolve => {
                    Papa.parse(url, {
                        download: true,
                        header: true,
                        skipEmptyLines: true,
                        complete: (res) => resolve(res.data),
                        error: () => resolve([])
                    });
                });

                const [cdmx, alcaldias, edomex, morelos, sc, zoning, rules] = await Promise.all([
                    fetchJson(DATA_FILES.LIMITES_CDMX),
                    fetchJson(DATA_FILES.LIMITES_ALCALDIAS),
                    fetchJson(DATA_FILES.LIMITES_EDOMEX),
                    fetchJson(DATA_FILES.LIMITES_MORELOS),
                    fetchJson(DATA_FILES.SUELO_CONSERVACION),
                    fetchJson(DATA_FILES.ZONIFICACION),
                    fetchCsv(DATA_FILES.USOS_SUELO_CSV)
                ]);

                dataCache.cdmx = cdmx;
                dataCache.alcaldias = alcaldias;
                dataCache.edomex = edomex;
                dataCache.morelos = morelos;
                dataCache.sc = sc;
                dataCache.zoning = zoning;
                dataCache.rules = rules;

                document.getElementById('loading-screen').classList.add('hidden');
            } catch (error) {
                console.error("Error crítico cargando datos", error);
                document.getElementById('loading-screen').innerHTML = `<h2 class='text-red-600 font-bold'>Error al cargar datos</h2><p>Verifique los archivos en el repositorio.</p>`;
            }
        }

        // --- LÓGICA GIS (Point in Polygon) ---
        function isPointInPolygon(point, feature) {
            const { lat, lng } = point;
            const { type, coordinates } = feature.geometry;

            const checkRing = (ring) => {
                let inside = false;
                for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                    const xi = ring[i][0], yi = ring[i][1];
                    const xj = ring[j][0], yj = ring[j][1];
                    const intersect = ((yi > lat) !== (yj > lat)) && (lng < (xj - xi) * (lat - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                return inside;
            };

            if (type === 'Polygon') return checkRing(coordinates[0]);
            if (type === 'MultiPolygon') {
                for (const poly of coordinates) if (checkRing(poly[0])) return true;
            }
            return false;
        }

        function findFeature(point, collection) {
            if (!collection || !collection.features) return null;
            return collection.features.find(f => isPointInPolygon(point, f));
        }

        // --- ANÁLISIS PRINCIPAL ---
        function analyzeLocation(coord) {
            const result = {
                status: 'LOADING',
                alcaldia: '',
                isRestricted: false,
                coordinate: coord,
                allowed: [], prohibited: [], conditioned: [],
                zoningKey: '', zoningName: '',
                timestamp: new Date().toLocaleString(),
                folio: Date.now().toString().slice(-6)
            };

            // 1. Validar CDMX
            const inCDMX = findFeature(coord, dataCache.cdmx);
            if (!inCDMX) {
                result.status = 'OUTSIDE_CDMX';
                const inEdo = findFeature(coord, dataCache.edomex);
                const inMor = findFeature(coord, dataCache.morelos);
                result.outsideContext = inEdo ? "Estado de México" : inMor ? "Morelos" : "";
                return result;
            }

            // 2. Alcaldía
            const alc = findFeature(coord, dataCache.alcaldias);
            result.alcaldia = alc ? (alc.properties.NOMBRE || alc.properties.NOMGEO) : "No identificada";

            // 3. Suelo de Conservación
            const sc = findFeature(coord, dataCache.sc);
            if (!sc) {
                result.status = 'URBAN_SOIL';
                return result;
            }

            // 4. Es Restringido
            result.status = 'CONSERVATION_SOIL';
            result.isRestricted = true;

            // 5. Zonificación
            const zone = findFeature(coord, dataCache.zoning);
            if (zone) {
                result.zoningKey = zone.properties.CLAVE;
                result.zoningName = zone.properties.PGOEDF || zone.properties.UGA;

                // 6. Cruce CSV
                if (result.zoningKey && dataCache.rules.length) {
                    dataCache.rules.forEach(row => {
                        const val = (row[result.zoningKey] || '').trim().toUpperCase();
                        const act = `${row.SECTOR} - ${row.ACTIVIDAD_GENERAL}: ${row.ACTIVIDAD_ESPECIFICA}`;
                        if (val === 'A') result.allowed.push(act);
                        else if (val === 'C') result.conditioned.push(act);
                        else if (val === 'P') result.prohibited.push(act);
                    });
                }
            } else {
                result.zoningKey = sc.properties.CLAVE || 'SC';
                result.zoningName = sc.properties.PGOEDF || 'Suelo de Conservación (Genérico)';
            }
            return result;
        }

        // --- RENDERIZADO UI ---
        function renderResult(res) {
            selectedResult = res;

            // Mostrar/Ocultar contenedores
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('results-container').classList.remove('hidden');
            document.getElementById('footer-actions').classList.remove('hidden');

            // Iconos y Colores
            const statusCard = document.getElementById('status-card');
            const statusIcon = document.getElementById('status-icon');
            const statusTitle = document.getElementById('status-title');
            const statusDesc = document.getElementById('status-desc');
            const iconLucide = (name, color) => `<i data-lucide="${name}" class="h-6 w-6 ${color}"></i>`;

            if (res.status === 'CONSERVATION_SOIL') {
                statusCard.className = "p-5 rounded-lg border-l-8 shadow-sm bg-red-50 border-red-700";
                statusIcon.innerHTML = iconLucide('alert-triangle', 'text-red-700');
                statusTitle.className = "text-lg font-bold uppercase text-red-800";
                statusTitle.textContent = "Zona Restringida";
                statusDesc.textContent = "Este predio se ubica dentro del Suelo de Conservación. Aplican restricciones ambientales estrictas.";
                document.getElementById('activities-container').classList.remove('hidden');
            } else if (res.status === 'URBAN_SOIL') {
                statusCard.className = "p-5 rounded-lg border-l-8 shadow-sm bg-green-50 border-green-600";
                statusIcon.innerHTML = iconLucide('check-circle', 'text-green-700');
                statusTitle.className = "text-lg font-bold uppercase text-green-800";
                statusTitle.textContent = "Suelo Urbano";
                statusDesc.textContent = "Predio fuera de la capa de conservación ecológica. Consulte Zonificación Urbana en SEDUVI.";
                document.getElementById('activities-container').classList.add('hidden');
            } else {
                statusCard.className = "p-5 rounded-lg border-l-8 shadow-sm bg-gray-100 border-gray-400";
                statusIcon.innerHTML = iconLucide('x-circle', 'text-gray-600');
                statusTitle.className = "text-lg font-bold uppercase text-gray-800";
                statusTitle.textContent = "Fuera de Jurisdicción";
                statusDesc.textContent = `El punto seleccionado no pertenece a la Ciudad de México. ${res.outsideContext ? 'Ubicación probable: ' + res.outsideContext : ''}`;
                document.getElementById('activities-container').classList.add('hidden');
            }
            lucide.createIcons();

            // Datos
            document.getElementById('res-alcaldia').textContent = res.alcaldia;
            document.getElementById('res-coords').textContent = `${res.coordinate.lat.toFixed(5)}, ${res.coordinate.lng.toFixed(5)}`;
            document.getElementById('folio-val').textContent = res.folio;
            document.getElementById('date-val').textContent = res.timestamp;

            // Zonificación
            const zoningContainer = document.getElementById('zoning-container');
            if (res.zoningKey) {
                zoningContainer.classList.remove('hidden');
                document.getElementById('res-zoning-key').textContent = res.zoningKey;
                document.getElementById('res-zoning-name').textContent = res.zoningName;
            } else {
                zoningContainer.classList.add('hidden');
            }

            // Listas
            if (res.status === 'CONSERVATION_SOIL') {
                fillList('list-allowed', 'count-allowed', res.allowed);
                fillList('list-conditioned', 'count-conditioned', res.conditioned);
                fillList('list-prohibited', 'count-prohibited', res.prohibited);
            }

            // Mapa Update
            updateMapMarker(res.coordinate, res.status);
            
            // Auto scroll en móvil
            if (window.innerWidth < 768) {
                 document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function fillList(listId, countId, items) {
            const list = document.getElementById(listId);
            const count = document.getElementById(countId);
            list.innerHTML = '';
            count.textContent = `(${items.length})`;
            items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item;
                list.appendChild(li);
            });
            // Auto ocultar si vacío
            const details = list.closest('details');
            if (items.length === 0) details.style.display = 'none';
            else details.style.display = 'block';
        }

        // --- MAPA ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([19.4326, -99.1332], 11);
            L.control.zoom({ position: 'topright' }).addTo(map);

            // Capa Base
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                maxZoom: 20
            }).addTo(map);

            // Capas GeoJSON
            const overlayLayers = {};

            // Contexto
            if (dataCache.edomex) overlayLayers["EdoMex"] = L.geoJSON(dataCache.edomex, { style: { color: '#9ca3af', weight: 1, dashArray: '2, 4', fill: false } });
            if (dataCache.morelos) overlayLayers["Morelos"] = L.geoJSON(dataCache.morelos, { style: { color: '#9ca3af', weight: 1, dashArray: '2, 4', fill: false } });

            // CDMX Límites
            if (dataCache.cdmx) L.geoJSON(dataCache.cdmx, { style: { color: '#54565a', weight: 2, fill: false }, interactive: false }).addTo(map);

            // Alcaldías (Por defecto)
            if (dataCache.alcaldias) {
                overlayLayers["Alcaldías"] = L.geoJSON(dataCache.alcaldias, {
                    style: { color: '#6b7280', weight: 1, dashArray: '5, 5', fillOpacity: 0 },
                    onEachFeature: (f, l) => l.bindTooltip(f.properties.NOMBRE, { direction: "center", className: "bg-white/80 px-1 border rounded text-xs" })
                }).addTo(map);
            }

            // Suelo Conservación
            if (dataCache.sc) {
                overlayLayers["Suelo Conservación"] = L.geoJSON(dataCache.sc, {
                    style: { color: '#9d2449', weight: 1, fillColor: '#9d2449', fillOpacity: 0.15 }
                });
            }

            // Zonificación (Activa)
            if (dataCache.zoning) {
                overlayLayers["Zonificación"] = L.geoJSON(dataCache.zoning, {
                    style: { color: '#3b82f6', weight: 1, dashArray: '3, 3', fillOpacity: 0 },
                    onEachFeature: (f, l) => {
                        const label = f.properties.PGOEDF || f.properties.CLAVE;
                        if(label) l.bindTooltip(label, { sticky: true });
                    }
                }).addTo(map);
            }

            L.control.layers(null, overlayLayers, { collapsed: true }).addTo(map);

            // Evento Click
            map.on('click', (e) => {
                const coord = { lat: e.latlng.lat, lng: e.latlng.lng };
                const res = analyzeLocation(coord);
                renderResult(res);
            });

            // Botón Reset Mapa
            const resetBtn = L.control({ position: 'topleft' });
            resetBtn.onAdd = () => {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = `<button style="background:white;width:30px;height:30px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;" title="Reset"><i data-lucide="rotate-ccw" style="width:16px;color:#9d2449"></i></button>`;
                div.onclick = (e) => { e.stopPropagation(); resetUI(); };
                return div;
            };
            resetBtn.addTo(map);
        }

        function updateMapMarker(coord, status) {
            if (marker) map.removeLayer(marker);
            
            let color = '#6b7280';
            if (status === 'CONSERVATION_SOIL') color = '#dc2626';
            else if (status === 'URBAN_SOIL') color = '#16a34a';

            marker = L.circleMarker([coord.lat, coord.lng], {
                radius: 12, fillColor: color, color: '#fff', weight: 3, opacity: 1, fillOpacity: 0.8
            }).addTo(map);
            
            map.setView([coord.lat, coord.lng], 16);
            lucide.createIcons(); // Refrescar iconos en mapa si es necesario
        }

        // --- EVENTOS UI ---
        function setupEventListeners() {
            // Coord Search
            document.getElementById('coord-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const val = document.getElementById('coord-input').value;
                const coord = parseCoordinates(val);
                if (coord) {
                    const res = analyzeLocation(coord);
                    renderResult(res);
                } else {
                    alert("Formato no válido. Use decimales (19.43, -99.13) o DMS.");
                }
            });

            // Address Search
            document.getElementById('address-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const val = document.getElementById('address-input').value;
                if (!val) return;
                try {
                    const req = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(val + ', Ciudad de México')}&limit=1`);
                    const json = await req.json();
                    if (json.length) {
                        const coord = { lat: parseFloat(json[0].lat), lng: parseFloat(json[0].lon) };
                        const res = analyzeLocation(coord);
                        renderResult(res);
                    } else alert("Dirección no encontrada.");
                } catch { alert("Error de conexión con servicio de búsqueda."); }
            });

            // GPS
            document.getElementById('btn-gps').addEventListener('click', () => {
                if (!navigator.geolocation) return alert("Navegador no soporta GPS");
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        const coord = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        const res = analyzeLocation(coord);
                        renderResult(res);
                    },
                    err => alert("Error obteniendo ubicación.")
                );
            });

            // Reset
            document.getElementById('btn-reset').addEventListener('click', resetUI);

            // Share
            document.getElementById('btn-share').addEventListener('click', () => {
                if (!selectedResult) return;
                const text = `Consulta SEDEMA: ${selectedResult.alcaldia}. Estatus: ${selectedResult.isRestricted ? 'RESTRINGIDO' : 'URBANO'}. ${selectedResult.coordinate.lat}, ${selectedResult.coordinate.lng}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            });
        }

        function resetUI() {
            selectedResult = null;
            document.getElementById('results-container').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('footer-actions').classList.add('hidden');
            document.getElementById('coord-input').value = '';
            document.getElementById('address-input').value = '';
            if (marker) map.removeLayer(marker);
            map.setView([19.4326, -99.1332], 11);
        }

        function parseCoordinates(input) {
            const text = input.trim();
            // Decimal
            const decimal = text.match(/([-+]?\d{1,3}\.\d+)[,;\s]+([-+]?\d{1,3}\.\d+)/);
            if (decimal) {
                const v1 = parseFloat(decimal[1]);
                const v2 = parseFloat(decimal[2]);
                if (v1 > 14 && v1 < 33 && v2 > -118 && v2 < -86) return { lat: v1, lng: v2 }; // Lat, Lng
                if (v2 > 14 && v2 < 33 && v1 > -118 && v1 < -86) return { lat: v2, lng: v1 }; // Lng, Lat
            }
            return null;
        }
    </script>
</body>
</html>
