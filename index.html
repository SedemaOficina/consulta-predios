<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES Y ESTILOS -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <style>
        /* --- ESTILOS (CSS INTEGRADO PARA EVITAR ERRORES) --- */
        :root { --guinda: #9d2148; --dorado: #b28e5c; --gris: #f4f4f4; --texto: #333; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        header { height: 70px; background: white; border-bottom: 4px solid var(--guinda); display: flex; align-items: center; justify-content: center; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        header img { height: 50px; }

        /* CONTENEDOR */
        .main-wrapper { display: flex; flex: 1; height: 100%; position: relative; }

        /* SIDEBAR (IZQUIERDA) */
        .sidebar { width: 380px; background: white; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 20px; background: var(--gris); border-bottom: 1px solid #ddd; }
        .sidebar-header h2 { color: var(--guinda); font-size: 16px; margin: 0; font-weight: 700; }
        .sidebar-body { padding: 20px; overflow-y: auto; flex: 1; }

        /* CONTROLES */
        .control-group { margin-bottom: 20px; }
        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-guinda { background: var(--guinda); color: white; }
        .btn-guinda:hover { background: #7c1c36; }
        
        .search-box { display: flex; gap: 5px; }
        .search-box input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-search { background: var(--dorado); color: white; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; }

        /* RESULTADOS */
        .result-panel { display: none; margin-top: 15px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
        .res-header { padding: 10px; color: white; font-weight: bold; text-align: center; font-size: 14px; }
        .res-body { padding: 15px; font-size: 12px; }
        
        .bg-rojo { background: #C0392B; }
        .bg-azul { background: #2980b9; }
        .bg-verde { background: #27ae60; }

        .regla-box { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .permitido { background: #e8f5e9; border-left: 4px solid #27ae60; }
        .prohibido { background: #ffebee; border-left: 4px solid #C0392B; }
        .regla-titulo { font-weight: bold; display: block; margin-bottom: 4px; }
        .prohibido .regla-titulo { color: #C0392B; }
        .permitido .regla-titulo { color: #27ae60; }
        ul { margin: 0; padding-left: 15px; }

        /* MAPA */
        #map { flex: 1; height: 100%; z-index: 1; }

        /* RESPONSIVO */
        @media (max-width: 768px) {
            .main-wrapper { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 45%; }
            #map { height: 55%; }
        }
    </style>
</head>
<body>

    <header>
        <img src="logo-sedema.png" alt="SEDEMA CDMX">
    </header>

    <div class="main-wrapper">
        <!-- PANEL LATERAL -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Consulta PGOEDF</h2>
                <p style="font-size:12px; color:#666;">Ordenamiento Ecol√≥gico del D.F.</p>
            </div>
            
            <div class="sidebar-body">
                <!-- GPS -->
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">üìç UBICARME EN EL MAPA</button>
                    <div id="status-gps" style="text-align:center; font-size:11px; margin-top:5px; color:#666;"></div>
                </div>

                <!-- BUSCADOR -->
                <div class="control-group">
                    <div class="search-box">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar" class="btn-search">üîç</button>
                    </div>
                </div>

                <!-- RESULTADOS -->
                <div id="resultado" class="result-panel">
                    <div id="res-header" class="res-header">RESULTADO</div>
                    <div class="res-body">
                        <h3 id="res-zona" style="margin:0 0 5px 0; color:#333;"></h3>
                        <p id="res-desc" style="margin-bottom:10px; color:#555; font-style:italic;"></p>
                        
                        <div class="regla-box prohibido">
                            <span class="regla-titulo">üö´ PROHIBIDO (Tabla PGOEDF):</span>
                            <ul id="lista-prohibido"></ul>
                        </div>
                        
                        <div class="regla-box permitido">
                            <span class="regla-titulo">‚úÖ AUTORIZADO:</span>
                            <ul id="lista-permitido"></ul>
                        </div>
                        
                        <div style="font-size:10px; color:#999; margin-top:10px; text-align:center;">
                            Fuente: PGOEDF (P√°gs. 116-117)
                        </div>
                    </div>
                </div>
                
                <!-- LEYENDA -->
                <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px; font-size:11px;">
                    <div style="display:flex; align-items:center; margin-bottom:5px;"><span style="width:12px; height:12px; background:#C0392B; margin-right:8px; opacity:0.6;"></span> Suelo Conservaci√≥n (Restringido)</div>
                    <div style="display:flex; align-items:center;"><span style="width:12px; height:12px; border:2px solid #2980b9; margin-right:8px;"></span> Zonificaci√≥n (L√≠mites)</div>
                </div>
            </div>
        </aside>

        <!-- MAPA -->
        <div id="map"></div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    
    <script>
        // ==================================================================
        // 1. EL "CEREBRO": BASE DE DATOS DIGITALIZADA DEL PDF (P√°gs 116-117)
        // ==================================================================
        const baseDatosPGOEDF = {
            "Forestal de Conservaci√≥n": {
                desc: "Zonas con mayores extensiones de vegetaci√≥n natural. Prioridad: Recarga acu√≠fero y biodiversidad.",
                permitido: ["Reforestaci√≥n", "Investigaci√≥n", "Ecoturismo (Senderos)", "Apicultura", "Vigilancia Ambiental"],
                prohibido: ["VIVIENDA (Casas/Fraccionamientos)", "Agricultura", "Ganader√≠a", "Apertura de calles/brechas", "Tala de √°rboles", "Miner√≠a", "Industria"]
            },
            "Forestal de Conservaci√≥n Especial": {
                desc: "Zonas boscosas con presi√≥n productiva. Se permite manejo sustentable.",
                permitido: ["Turismo sustentable", "Viveros", "Apicultura", "Cultivo de hongos", "Reforestaci√≥n"],
                prohibido: ["NUEVOS ASENTAMIENTOS HUMANOS", "Industria", "Miner√≠a", "Cambio de uso de suelo a urbano"]
            },
            "Forestal de Protecci√≥n": {
                desc: "Zonas de transici√≥n o amortiguamiento. Requieren restauraci√≥n.",
                permitido: ["Obras de conservaci√≥n de suelo", "Reforestaci√≥n", "Ecoturismo"],
                prohibido: ["Urbanizaci√≥n", "Tiraderos de basura", "Pastoreo extensivo", "Agricultura intensiva"]
            },
            "Forestal de Protecci√≥n Especial": {
                desc: "√Åreas con vegetaci√≥n natural que requieren frenar el deterioro.",
                permitido: ["Agroforester√≠a", "Pastoreo controlado (Estabulado)", "Manejo de vida silvestre"],
                prohibido: ["Crecimiento urbano", "Quemas agr√≠colas", "Uso de agroqu√≠micos agresivos"]
            },
            "Agroforestal": {
                desc: "Zona de transici√≥n bosque-cultivo.",
                permitido: ["Cultivos tradicionales", "Frutales", "Le√±a (uso dom√©stico)", "Turismo rural"],
                prohibido: ["Fraccionamientos habitacionales", "Industria contaminante", "Tala rasa"]
            },
            "Agroforestal Especial": {
                desc: "Zona agr√≠cola con manchones de bosque (Tlalpan/Milpa Alta).",
                permitido: ["Cultivos anuales", "Hortalizas", "Invernaderos", "Ganader√≠a controlada"],
                prohibido: ["Nuevas construcciones urbanas", "Miner√≠a a cielo abierto", "Industria"]
            },
            "Agroecol√≥gica": {
                desc: "Zona agr√≠cola de alta productividad (Nopal, Hortalizas).",
                permitido: ["Agricultura intensiva", "Invernaderos", "Venta de productos agr√≠colas", "Infraestructura de apoyo agr√≠cola"],
                prohibido: ["Cambio de uso a habitacional", "Centros comerciales", "Industria"]
            },
            "Agroecol√≥gica Especial": {
                desc: "Zona de Humedales y Chinampas (Xochimilco/Tl√°huac).",
                permitido: ["Agricultura chinampera", "Turismo en canales", "Pesca tradicional", "Flores y plantas"],
                prohibido: ["Relleno de canales", "Construcci√≥n de casas", "Drenaje en canales", "Uso de pesticidas"]
            }
        };

        // Funci√≥n inteligente para buscar la regla aunque el nombre var√≠e un poco en el SHP
        function buscarReglas(nombreZona) {
            if (!nombreZona) return null;
            let nombreLimpio = nombreZona.toUpperCase().trim();
            
            for (let key in baseDatosPGOEDF) {
                if (nombreLimpio.includes(key.toUpperCase())) {
                    return { nombre: key, datos: baseDatosPGOEDF[key] };
                }
            }
            return null; // Si no encuentra coincidencia
        }

        // ==================================================================
        // 2. CONFIGURACI√ìN DEL MAPA
        // ==================================================================
        var map = L.map('map', { zoomControl: false }).setView([19.28, -99.13], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Capas Base
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }).addTo(map);
        var calles = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', { opacity: 0.8, attribution: 'CARTO' }).addTo(map);

        // Variables para las capas
        var layerZoni = L.geoJSON(null, {
            style: { color: '#3498db', weight: 2, fillOpacity: 0.05 }, // Azul transparente
            onEachFeature: function(feature, layer) {
                // Al dar clic en un pol√≠gono
                layer.on('click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    analizarUbicacion(e.latlng);
                });
            }
        }).addTo(map);

        var layerSuelo = L.geoJSON(null, {
            style: { color: '#C0392B', weight: 0, fillOpacity: 0.25 }, // Rojo fondo
            interactive: false
        }).addTo(map);

        // ==================================================================
        // 3. CARGA DE ARCHIVOS
        // ==================================================================
        
        // Cargar ZONIFICACI√ìN (Vital: debe coincidir el nombre)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson')
            .then(r => r.json())
            .then(data => layerZoni.addData(data))
            .catch(e => alert("Error: No encuentro 'zoonificaci√≥n_pgoedf_2000.geojson'. Revisa tu GitHub."));

        // Cargar SUELO CONSERVACI√ìN
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => layerSuelo.addData(data));


        // ==================================================================
        // 4. L√ìGICA DE AN√ÅLISIS (EL CORAZ√ìN DEL SISTEMA)
        // ==================================================================
        
        var marcadorActual;

        function analizarUbicacion(latlng) {
            // 1. Mover mapa
            map.setView(latlng, 16);
            if (marcadorActual) map.removeLayer(marcadorActual);
            marcadorActual = L.marker(latlng).addTo(map);

            // 2. ¬øEn qu√© pol√≠gono cay√≥? (Usando Leaflet PIP)
            var resultados = leafletPip.pointInLayer(latlng, layerZoni);
            
            // Elementos del panel
            var panel = document.getElementById('resultado');
            var header = document.getElementById('res-header');
            var zona = document.getElementById('res-zona');
            var desc = document.getElementById('res-desc');
            var ulProh = document.getElementById('lista-prohibido');
            var ulPerm = document.getElementById('lista-permitido');

            ulProh.innerHTML = "";
            ulPerm.innerHTML = "";
            panel.style.display = "block";

            if (resultados.length > 0) {
                // --- CAY√ì EN SUELO DE CONSERVACI√ìN ---
                var p = resultados[0].feature.properties;
                // Buscamos el nombre en tus columnas posibles
                var nombreRaw = p.DESCRIPCIO || p.ZONA || p.TIPO || "Sin Nombre";
                var info = buscarReglas(nombreRaw);

                header.innerText = "‚ö†Ô∏è SUELO DE CONSERVACI√ìN";
                header.className = "res-header bg-rojo";
                
                if (info) {
                    zona.innerText = info.nombre;
                    desc.innerText = info.datos.desc;
                    // Llenar listas
                    info.datos.prohibido.forEach(item => {
                        let li = document.createElement('li'); li.innerText = item; ulProh.appendChild(li);
                    });
                    info.datos.permitido.forEach(item => {
                        let li = document.createElement('li'); li.innerText = item; ulPerm.appendChild(li);
                    });
                } else {
                    zona.innerText = nombreRaw;
                    desc.innerText = "Zona regulada. Consulta a SEDEMA.";
                    ulProh.innerHTML = "<li>Verificar Plan de Manejo</li>";
                }

                // Popup en el mapa tambi√©n
                marcadorActual.bindPopup(`<b style="color:#C0392B">üö´ ZONA RESTRINGIDA</b><br>${nombreRaw}`).openPopup();

            } else {
                // --- CAY√ì FUERA (SUELO URBANO) ---
                header.innerText = "‚úÖ SUELO URBANO / OTRA ZONA";
                header.className = "res-header bg-verde";
                zona.innerText = "Fuera del Suelo de Conservaci√≥n";
                desc.innerText = "Esta ubicaci√≥n no presenta restricciones del PGOEDF.";
                ulProh.innerHTML = "<li>N/A</li>";
                ulPerm.innerHTML = "<li>Uso Habitacional (Verificar SEDUVI)</li>";
                
                marcadorActual.bindPopup(`<b style="color:#27ae60">‚úÖ SUELO URBANO</b>`).openPopup();
            }
        }

        // Clic en el mapa vac√≠o
        map.on('click', function(e) { analizarUbicacion(e.latlng); });

        // ==================================================================
        // 5. FUNCIONES DE BOTONES
        // ==================================================================
        
        // GPS
        document.getElementById('btn-gps').addEventListener('click', function() {
            document.getElementById('status-gps').innerText = "üõ∞Ô∏è Buscando se√±al...";
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });
        map.on('locationfound', function(e) {
            document.getElementById('status-gps').innerText = "";
            analizarUbicacion(e.latlng);
        });
        map.on('locationerror', function() {
            alert("Activa tu GPS para usar esta funci√≥n.");
            document.getElementById('status-gps').innerText = "";
        });

        // BUSCADOR
        document.getElementById('btn-buscar').addEventListener('click', function() {
            var q = document.getElementById('input-busqueda').value;
            if(!q) return;
            // Nominatim
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}+CDMX&limit=1`)
            .then(r=>r.json())
            .then(d=>{
                if(d.length > 0) analizarUbicacion([d[0].lat, d[0].lon]);
                else alert("Direcci√≥n no encontrada.");
            });
        });

    </script>
</body>
</html>
