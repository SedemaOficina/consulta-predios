<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#9d2148">
    
    <title>Validador de Predios | SEDEMA</title>
    
    <!-- FUENTES Y LIBRERIAS -->
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css">
    
    <!-- Librer√≠a para detectar puntos dentro de pol√≠gonos -->
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
</head>
<body>

    <!-- ENCABEZADO SOLO PARA IMPRESI√ìN -->
    <div id="print-header">
        <img src="logo-sedema.png" style="height: 60px;">
        <div class="print-title">FICHA INFORMATIVA DE PREDIO</div>
        <div class="print-date" id="fecha-impresion"></div>
    </div>

    <!-- HEADER WEB -->
    <header class="gob-header">
        <div class="header-inner">
            <img src="logo-sedema.png" alt="Logo SEDEMA" class="logo-cdmx">
            <div class="vertical-line"></div>
            <div class="dependency-name">
                <h1>SECRETAR√çA DEL<br>MEDIO AMBIENTE</h1>
            </div>
        </div>
    </header>

    <!-- SECCI√ìN MAPA -->
    <section class="map-section">
        <div id="map"></div>

        <!-- TARJETA FLOTANTE -->
        <div class="info-card">
            <div class="card-header">
                <h2>Consulta Ciudadana</h2>
                <p>Verifica uso de suelo y zonificaci√≥n.</p>
            </div>
            
            <div class="card-body">
                <div class="action-section">
                    <button id="btn-gps" class="btn-block btn-guinda">üìç UBICARME (GPS)</button>
                    <p id="gps-status" class="status-text"></p>
                </div>

                <div class="search-wrapper">
                    <input type="text" id="search-input" placeholder="Buscar direcci√≥n...">
                    <button id="btn-search" class="btn-search">üîç</button>
                </div>

                <div class="results-area">
                    <h3>Capas Activas</h3>
                    <div class="legend-item"><span class="color-box guinda-fill"></span> Suelo Conservaci√≥n (Restringido)</div>
                    <div class="legend-item"><span class="color-box azul-fill"></span> Zonificaci√≥n (POE)</div>
                    <div class="legend-item"><span class="color-box verde-fill"></span> ANP (Protegida)</div>
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

                <button onclick="imprimirFicha()" class="btn-block btn-print">üñ®Ô∏è DESCARGAR FICHA</button>
            </div>
            <div class="mobile-toggle" id="mobile-toggle">Ver Mapa / Ocultar</div>
        </div>
    </section>

    <!-- √ÅREA DE INFORMACI√ìN LEGAL (Se ve al imprimir) -->
    <div class="print-warning" style="display:none;">
        <strong>NOTA LEGAL:</strong> Esta ficha es de car√°cter informativo y no constituye un documento legal con validez jur√≠dica. 
        Para tr√°mites oficiales, acuda a la Ventanilla √önica de la SEDEMA. La venta de terrenos en Suelo de Conservaci√≥n constituye un delito ambiental.
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // 1. FECHA DE IMPRESI√ìN
        document.getElementById('fecha-impresion').innerText = "Fecha de consulta: " + new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString();

        // 2. INICIALIZAR MAPA
        var map = L.map('map', { zoomControl: false }).setView([19.25, -99.15], 11);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // 3. CAPAS BASE
        var mapaClaro = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CARTO' });
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' });
        
        map.addLayer(mapaSatelite); // Por defecto Sat√©lite

        // 4. GRUPOS DE CAPAS (Para poder activar/desactivar)
        var layerSueloConservacion = L.layerGroup().addTo(map); // Activa por defecto
        var layerZonificacion = L.layerGroup();                 // Desactivada por defecto (el usuario la prende)
        var layerANP = L.layerGroup().addTo(map);               // Activa por defecto

        // 5. CONTROL DE CAPAS
        var baseMaps = { "Sat√©lite": mapaSatelite, "Mapa Claro": mapaClaro };
        var overlayMaps = {
            "üî¥ Suelo de Conservaci√≥n": layerSueloConservacion,
            "üîµ Zonificaci√≥n (UGA)": layerZonificacion,
            "üü¢ √Åreas Protegidas (ANP)": layerANP
        };
        
        L.control.layers(baseMaps, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);

        // 6. CARGAR DATOS

        // A) Suelo de Conservaci√≥n
        fetch('suelo-de-conservacion-2020.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#9d2148', fillColor: '#9d2148', fillOpacity: 0.3, weight: 1 },
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup(`<h3 style="color:#9d2148">üö´ ZONA PROHIBIDA</h3>Suelo de Conservaci√≥n`);
                    }
                }).addTo(layerSueloConservacion);
            });

        // B) Zonificaci√≥n (POE)
        fetch('zonificacion.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#3498db', fillOpacity: 0, weight: 2 }, // Solo borde azul
                    onEachFeature: function(feature, layer) {
                        var p = feature.properties;
                        // Ajusta estos nombres a tus columnas
                        var texto = `<b>UGA:</b> ${p.UGA || p.CLAVE}<br><b>Pol√≠tica:</b> ${p.POLITICA}<br><b>Uso:</b> ${p.USO_PREDOM}`;
                        layer.bindPopup(texto);
                    }
                }).addTo(layerZonificacion);
            });

        // C) ANP
        fetch('anp.geojson')
            .then(r => r.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: '#027a35', fillColor: '#027a35', fillOpacity: 0.4, weight: 1 },
                    onEachFeature: (f, l) => l.bindPopup(`<h3 style="color:green">√Årea Natural Protegida</h3>`)
                }).addTo(layerANP);
            }).catch(e => console.log("Capa ANP opcional"));


        // 7. FUNCIONES UX
        
        // Imprimir
        window.imprimirFicha = function() {
            // Mostrar la advertencia legal temporalmente
            document.querySelector('.print-warning').style.display = 'block';
            window.print();
            setTimeout(() => { document.querySelector('.print-warning').style.display = 'none'; }, 1000);
        };

        // GPS
        const btnGps = document.getElementById('btn-gps');
        const statusText = document.getElementById('gps-status');

        btnGps.addEventListener('click', () => {
            statusText.innerText = "Localizando...";
            map.locate({setView: true, maxZoom: 16});
        });

        map.on('locationfound', e => {
            statusText.innerText = "Ubicaci√≥n encontrada";
            L.circleMarker(e.latlng, {radius:8, fillColor:"blue", color:"white", fillOpacity:1}).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
            // Analizar si est√° en zona de riesgo con leaflet-pip
            verificarRiesgo(e.latlng);
        });

        // B√∫squeda Manual
        document.getElementById('btn-search').addEventListener('click', () => {
            var q = document.getElementById('search-input').value;
            if(!q) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}+CDMX&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if(data.length){
                        var latlng = [data[0].lat, data[0].lon];
                        map.setView(latlng, 16);
                        L.marker(latlng).addTo(map).bindPopup(data[0].display_name).openPopup();
                        verificarRiesgo({lat: data[0].lat, lng: data[0].lon});
                    } else { alert("No encontrado"); }
                });
        });

        // Verificar Riesgo (Punto en Pol√≠gono)
        function verificarRiesgo(latlng) {
            // Esperar un poco a que carguen las capas
            setTimeout(() => {
                var capasRoja = layerSueloConservacion.getLayers();
                if(capasRoja.length > 0 && leafletPip) {
                    // Nota: leafletPip requiere GeoJSON layer, no LayerGroup directo a veces.
                    // Iteramos para buscar en el GeoJSON interno.
                    var found = false;
                    capasRoja.forEach(layer => {
                        var res = leafletPip.pointInLayer(latlng, layer);
                        if(res.length) found = true;
                    });
                    
                    if(found) alert("‚ö†Ô∏è ALERTA: Esta ubicaci√≥n est√° dentro del Suelo de Conservaci√≥n.");
                }
            }, 1000);
        }

        // Toggle M√≥vil
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.info-card').classList.toggle('collapsed');
        });

        // REGISTRAR SERVICE WORKER (Para PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
            });
        }
    </script>
</body>
</html>
