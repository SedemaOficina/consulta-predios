<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta PGOEDF | SEDEMA</title>
    
    <!-- FUENTES -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- LEAFLET -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="styles.css">
    
    <!-- LIBRER√çAS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@mapbox/leaflet-pip@latest/leaflet-pip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
</head>
<body>

    <header class="gob-header">
        <div class="logo-box">
            <img src="logo-sedema.png" alt="SEDEMA CDMX">
        </div>
        <div class="header-text">
            <h1>SISTEMA DE INFORMACI√ìN GEOGR√ÅFICA</h1>
            <h2>Vigilancia y Ordenamiento Ecol√≥gico</h2>
        </div>
    </header>

    <div class="main-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Consulta Ciudadana</h3>
                <p>Valida la zonificaci√≥n y reglas de uso del suelo.</p>
            </div>

            <div class="sidebar-body">
                <!-- CONTROLES -->
                <div class="control-group">
                    <button id="btn-gps" class="btn-full btn-guinda">üìç UBICARME EN EL MAPA</button>
                    <div id="status-gps" class="status-msg"></div>
                </div>

                <div class="divider"><span>O B√öSQUEDA MANUAL</span></div>

                <div class="control-group">
                    <div class="search-row">
                        <input type="text" id="input-busqueda" placeholder="Calle, Colonia o Coordenadas...">
                        <button id="btn-buscar">BUSCAR</button>
                    </div>
                </div>

                <!-- RESULTADOS -->
                <div id="panel-resultados" class="result-container" style="display:none;">
                    <!-- Barra de estado din√°mica (cambia de color) -->
                    <div class="res-status-bar" id="res-status-bar">...</div>
                    
                    <div class="res-content">
                        <div id="bloque-ubicacion" style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                            <label>Ubicaci√≥n:</label>
                            <span id="res-alcaldia" class="res-value-small">CDMX</span>
                        </div>

                        <label>Zonificaci√≥n (PGOEDF):</label>
                        <!-- Badge de color din√°mico -->
                        <div id="res-badge-zona" class="badge-zona">...</div>
                        <p id="res-desc" class="res-desc">...</p>
                        
                        <div id="res-acciones-container" style="display:none;">
                            <button onclick="generarReporte()" class="btn-full btn-print">üìÑ GENERAR REPORTE PDF</button>
                            <button onclick="compartirWhatsapp()" class="btn-full btn-whats">üì± COMPARTIR</button>
                        </div>
                    </div>
                </div>

                <!-- LEYENDA DIN√ÅMICA -->
                <div class="leyenda-box">
                    <h4>Zonificaci√≥n PGOEDF</h4>
                    <div class="item"><span class="rect" style="background:#006400"></span> Forestal Conservaci√≥n (FC)</div>
                    <div class="item"><span class="rect" style="background:#8B4513"></span> Forestal Protecci√≥n (FP)</div>
                    <div class="item"><span class="rect" style="background:#FFA500"></span> Agroecol√≥gica (AE)</div>
                    <div class="item"><span class="rect" style="background:#32CD32"></span> Agroforestal (AF)</div>
                    <div class="item"><span class="rect" style="background:#808080"></span> Asentamiento (PDU)</div>
                </div>
            </div>
        </aside>

        <div id="map"></div>
    </div>

    <!-- REPORTE OCULTO -->
    <div id="reporte-impresion" class="print-only">
        <!-- (Mismo c√≥digo de reporte que te di antes, se mantiene igual) -->
        <div class="report-header">
            <img src="logo-sedema.png" alt="Logo">
            <div><h2>FICHA T√âCNICA INFORMATIVA</h2><p>Ordenamiento Ecol√≥gico del D.F.</p></div>
        </div>
        <div class="report-meta">
            <p><strong>Fecha:</strong> <span id="print-fecha"></span></p>
            <p><strong>Ubicaci√≥n:</strong> <span id="print-alcaldia"></span></p>
            <p><strong>Coordenadas:</strong> <span id="print-coords"></span></p>
        </div>
        <div class="report-map-container" id="mapa-impresion-placeholder"></div>
        <div class="report-diagnosis">
            <h3 id="print-titulo-zona"></h3>
            <p id="print-desc-zona"></p>
            <div class="tables-container">
                <div class="tbl-box prohibido"><h4>üö´ PROHIBIDO</h4><ul id="print-lista-proh"></ul></div>
                <div class="tbl-box permitido"><h4>‚úÖ PERMITIDO</h4><ul id="print-lista-perm"></ul></div>
            </div>
        </div>
        <div class="report-footer">
            <p>AVISO: Documento informativo. Fuente: PGOEDF.</p>
        </div>
    </div>

    <script>
        // ======================== 1. CONFIGURACI√ìN ========================
        
        // COLORES POR ZONIFICACI√ìN (PGOEDF)
        const coloresZona = {
            "FC": "#006400",  // Verde Oscuro
            "FCE": "#228B22", // Verde Bosque
            "FP": "#8B4513",  // Marr√≥n (Protecci√≥n)
            "FPE": "#A0522D", // Siena
            "AF": "#32CD32",  // Verde Lima
            "AFE": "#9ACD32", // Amarillo Verdoso
            "AE": "#FFA500",  // Naranja (Agr√≠cola)
            "AEE": "#00CED1", // Turquesa (Humedales/Chinampas)
            "ANP": "#00FF7F", // Spring Green
            "PDU": "#808080", // Gris (Asentamientos)
            "SC": "#C0392B"   // Rojo Default (Si no hay dato)
        };

        // Mapeo de Nombres SHP a Claves Cortas
        const mapeoSHP = {
            "FORESTAL DE CONSERVACION": "FC", "FORESTAL DE CONSERVACI√ìN": "FC",
            "FORESTAL DE CONSERVACION ESPECIAL": "FCE",
            "FORESTAL DE PROTECCION": "FP", "FORESTAL DE PROTECCI√ìN": "FP",
            "FORESTAL DE PROTECCION ESPECIAL": "FPE",
            "AGROFORESTAL": "AF", "AGROFORESTAL ESPECIAL": "AFE",
            "AGROECOLOGICO": "AE", "AGROECOL√ìGICO": "AE",
            "AGROECOLOGICO ESPECIAL": "AEE",
            "PROGRAMAS": "PDU", "POBLADOS": "PDU"
        };

        // Carga CSV
        let tablaUsos = [];
        let infoActual = null;
        let coordsActuales = null;

        Papa.parse("usos_suelo.csv", {
            download: true, header: true, encoding: "UTF-8", skipEmptyLines: true,
            complete: function(results) { tablaUsos = results.data; }
        });

        // ======================== 2. MAPA ========================
        var map = L.map('map', { zoomControl: false }).setView([19.30, -99.13], 10);
        L.control.zoom({ position: 'topright' }).addTo(map);

        // Capas Base (Esri Street Map es muy claro para calles)
        var esriStreets = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri', maxZoom: 19 });
        
        map.addLayer(esriStreets); 
        L.control.layers({ "Mapa Urbano": esriStreets, "Sat√©lite": satelite }, {}, { position: 'topright' }).addTo(map);

        // Variables Globales
        var geojsonCDMX, geojsonEdoMex, geojsonMorelos, geojsonAlcaldias, geojsonSuelo, geojsonZoni;

        // ======================== 3. CARGA DE ARCHIVOS ========================

        // A) L√çMITES ADMINISTRATIVOS
        fetch('limites_cdmx.geojson').then(r=>r.json()).then(data => {
            geojsonCDMX = L.geoJSON(data, { style: { color: '#000', weight: 4, fill: false } }).addTo(map);
            map.fitBounds(geojsonCDMX.getBounds());
        });

        fetch('limites_alcaldias.geojson').then(r=>r.json()).then(data => {
            geojsonAlcaldias = L.geoJSON(data, { style: { color: '#666', weight: 1, fillOpacity: 0, dashArray: '5, 5' } }).addTo(map);
        });

        // B) VECINOS (Para detectar si sali√≥ de CDMX)
        var estiloGris = { color: '#999', weight: 0, fillColor: '#eeeeee', fillOpacity: 0.5 };
        fetch('limites_edomex.geojson').then(r=>r.json()).then(data => { geojsonEdoMex = L.geoJSON(data, {style: estiloGris}).addTo(map); });
        fetch('limites_morelos.geojson').then(r=>r.json()).then(data => { geojsonMorelos = L.geoJSON(data, {style: estiloGris}).addTo(map); });

        // C) SUELO DE CONSERVACI√ìN (Capa General - Rojo Suave)
        fetch('suelo-de-conservacion-2020.geojson').then(r=>r.json()).then(data => {
            geojsonSuelo = L.geoJSON(data, { style: { color: '#C0392B', weight: 2, fillOpacity: 0 } }).addTo(map);
        });

        // D) ZONIFICACI√ìN (Esta da el color seg√∫n la categor√≠a)
        fetch('zoonificaci√≥n_pgoedf_2000.geojson').then(r=>r.json()).then(data => {
            geojsonZoni = L.geoJSON(data, {
                style: function(feature) {
                    var clave = obtenerClave(feature.properties);
                    return {
                        color: coloresZona[clave] || '#3388ff',
                        weight: 1,
                        fillColor: coloresZona[clave] || '#3388ff',
                        fillOpacity: 0.4
                    };
                },
                onEachFeature: function(f, l) {
                    l.on('click', e => { L.DomEvent.stopPropagation(e); analizarPunto(e.latlng); });
                }
            }).addTo(map);
        });

        // Helper para sacar la clave (FC, AE) del GeoJSON
        function obtenerClave(props) {
            var raw = (props.CLAVE || "").toUpperCase().trim();
            if (coloresZona[raw]) return raw; // Si ya viene la clave correcta
            
            var nombre = (props.PGOEDF || props.DESCRIPCIO || "").toUpperCase();
            for (let key in mapeoSHP) {
                if (nombre.includes(key)) return mapeoSHP[key];
            }
            return "SC"; // Default
        }

        // ======================== 4. L√ìGICA DE AN√ÅLISIS ========================
        var pinActual;

        function analizarPunto(latlng) {
            map.setView(latlng, 17);
            if (pinActual) map.removeLayer(pinActual);
            pinActual = L.marker(latlng).addTo(map);
            coordsActuales = latlng;

            if (!geojsonCDMX || !geojsonSuelo || !geojsonZoni) return;

            // DOM Elements
            var panel = document.getElementById('panel-resultados');
            var statusBar = document.getElementById('res-status-bar');
            var badgeZona = document.getElementById('res-badge-zona');
            var txtDesc = document.getElementById('res-desc');
            var txtAlcaldia = document.getElementById('res-alcaldia');
            var btnContainer = document.getElementById('res-acciones-container');
            panel.style.display = "block";

            // 1. CHECAR L√çMITE ESTATAL
            var inCDMX = leafletPip.pointInLayer(latlng, geojsonCDMX).length > 0;
            var inEdoMex = geojsonEdoMex ? leafletPip.pointInLayer(latlng, geojsonEdoMex).length > 0 : false;
            var inMorelos = geojsonMorelos ? leafletPip.pointInLayer(latlng, geojsonMorelos).length > 0 : false;

            if (!inCDMX) {
                let lugar = inEdoMex ? "Estado de M√©xico" : (inMorelos ? "Estado de Morelos" : "Fuera de Jurisdicci√≥n");
                statusBar.innerText = "FUERA DE CDMX";
                statusBar.className = "res-status-bar neutral";
                txtAlcaldia.innerText = lugar;
                badgeZona.innerText = "N/A";
                badgeZona.style.background = "#999";
                txtDesc.innerText = "La normativa de la SEDEMA solo aplica dentro de la Ciudad de M√©xico.";
                btnContainer.style.display = "none";
                return;
            }

            // 2. CHECAR ALCALD√çA
            var nombreAlc = "CDMX";
            if (geojsonAlcaldias) {
                var hitsAlc = leafletPip.pointInLayer(latlng, geojsonAlcaldias);
                if (hitsAlc.length > 0) nombreAlc = hitsAlc[0].feature.properties.NOMBRE || "Alcald√≠a";
            }
            txtAlcaldia.innerText = nombreAlc;

            // 3. CHECAR SUELO DE CONSERVACI√ìN
            var hitsSuelo = leafletPip.pointInLayer(latlng, geojsonSuelo);
            
            if (hitsSuelo.length > 0) {
                // EST√Å EN SUELO DE CONSERVACI√ìN
                var hitsZoni = leafletPip.pointInLayer(latlng, geojsonZoni);
                var clave = "SC";
                var nombreZona = "Suelo de Conservaci√≥n";
                var desc = "Zona regulada.";

                if (hitsZoni.length > 0) {
                    var p = hitsZoni[0].feature.properties;
                    clave = obtenerClave(p);
                    // Buscar nombre completo y descripci√≥n en el CSV (si carg√≥)
                    var datosCSV = obtenerReglasCSV(clave); 
                    // Como el CSV devuelve listas, aqu√≠ solo inferimos nombre b√°sico
                    nombreZona = p.PGOEDF || p.DESCRIPCIO || clave; 
                }

                infoActual = { nombre: nombreZona, codigo: clave, alcaldia: nombreAlcaldia, tipo: "SC" };
                
                // Configurar UI
                if (clave === "PDU") {
                    statusBar.innerText = "‚ö†Ô∏è POBLADO RURAL (PDU)";
                    statusBar.className = "res-status-bar warning";
                } else {
                    statusBar.innerText = "üö´ ZONA RESTRINGIDA";
                    statusBar.className = "res-status-bar danger";
                }

                badgeZona.innerText = `${nombreZona} (${clave})`;
                badgeZona.style.background = coloresZona[clave] || "#C0392B";
                txtDesc.innerText = "Consulta la tabla de derechos para ver actividades permitidas.";
                btnContainer.style.display = "block";

            } else {
                // SUELO URBANO
                infoActual = { nombre: "Suelo Urbano", codigo: "URB", alcaldia: nombreAlcaldia, tipo: "URB" };
                
                statusBar.innerText = "‚úÖ SUELO URBANO";
                statusBar.className = "res-status-bar success";
                badgeZona.innerText = "Urbano / Sin Zonificaci√≥n PGOEDF";
                badgeZona.style.background = "#27ae60";
                txtDesc.innerText = "Esta zona no presenta restricciones de conservaci√≥n ecol√≥gica.";
                btnContainer.style.display = "block";
            }
        }
        
        // Funci√≥n auxiliar CSV
        function obtenerReglasCSV(codigo) {
             let perm = [], proh = [];
             tablaUsos.forEach(fila => {
                 if (fila[codigo]) {
                     let txt = `${fila.SECTOR}: ${fila.ACTIVIDAD_ESPECIFICA}`;
                     if(fila[codigo].trim()=='A') perm.push(txt);
                     else if(fila[codigo].trim()=='P') proh.push(txt);
                 }
             });
             return {perm, proh};
        }

        // ... (El resto de funciones de generarReporte, buscar y GPS se mantienen igual al anterior) ...
        // Aseg√∫rate de copiar las funciones generarReporte(), compartirWhatsapp(), buscar() del c√≥digo previo 
        // e incluirlas aqu√≠ abajo.

        // GPS
        document.getElementById('btn-gps').addEventListener('click', () => { map.locate({setView:true, maxZoom:18}); });
        map.on('locationfound', e => analizarPunto(e.latlng));
        
        // Buscador
        document.getElementById('btn-buscar').addEventListener('click', () => {
            let val = document.getElementById('input-busqueda').value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}+CDMX&limit=1`)
            .then(r=>r.json()).then(d=>{ if(d.length) analizarPunto([d[0].lat, d[0].lon]); });
        });
        
        map.on('click', e => analizarPunto(e.latlng));
        
        // Reporte y Share (Simplificados para este bloque)
        function generarReporte() { window.print(); } // Recuerda integrar la l√≥gica completa de llenado
        function compartirWhatsapp() { 
            let t = `Ubicaci√≥n: ${infoActual.alcaldia}. Zona: ${infoActual.nombre}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(t)}`, '_blank');
        }

    </script>
</body>
</html>
