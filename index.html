<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Validador de Predios | SEDEMA</title>
    
    <!-- FUENTES OFICIALES -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cabin:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <!-- ESTILOS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- HEADER -->
    <header class="gob-header">
        <div class="header-inner">
            <img src="logo-sedema.png" alt="Logo SEDEMA" class="logo-cdmx">
            <div class="vertical-line"></div>
            <div class="dependency-name">
                <h1>SECRETAR√çA DEL<br>MEDIO AMBIENTE</h1>
            </div>
        </div>
        <!-- Men√∫ simplificado -->
        <div class="header-right">
            <span class="emergency-text">¬øDudas? Llama al 911</span>
        </div>
    </header>

    <!-- CONTENEDOR -->
    <main class="layout-container">
        
        <div id="map"></div>

        <!-- TARJETA PRINCIPAL (INTERFAZ DE USUARIO) -->
        <div class="info-card">
            <div class="card-header">
                <h2>Protege tu Patrimonio</h2>
                <p>Verifica el terreno antes de pagar un solo peso.</p>
            </div>
            
            <div class="card-body">
                
                <!-- SECCI√ìN 1: GPS (Lo m√°s f√°cil) -->
                <div class="action-section">
                    <label>Opci√≥n A: Estoy en el terreno ahora</label>
                    <button id="btn-gps-large" class="btn-block btn-guinda">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle><line x1="12" y1="2" x2="12" y2="4"></line><line x1="12" y1="20" x2="12" y2="22"></line><line x1="2" y1="12" x2="4" y2="12"></line><line x1="20" y1="12" x2="22" y2="12"></line></svg>
                        USAR MI UBICACI√ìN ACTUAL
                    </button>
                    <p id="gps-status" class="status-text"></p>
                </div>

                <div class="divider-text">O BUSCA LA DIRECCI√ìN</div>

                <!-- SECCI√ìN 2: BUSCADOR MANUAL -->
                <div class="action-section">
                    <label>Opci√≥n B: Buscar por calle o colonia</label>
                    <div class="search-wrapper">
                        <input type="text" id="manual-search-input" placeholder="Ej: Calle 3, San Miguel Topilejo...">
                        <button id="btn-manual-search" class="btn-search">üîç</button>
                    </div>
                    <p class="hint-text">Si tienes coordenadas (ej: 19.25, -99.10), p√©galas arriba.</p>
                </div>

                <!-- SECCI√ìN 3: RESULTADOS Y SIMBOLOG√çA -->
                <div class="results-area">
                    <h3>¬øQu√© significan los colores?</h3>
                    
                    <div class="legend-item alert-item">
                        <span class="color-box guinda-fill"></span>
                        <div>
                            <strong>ZONA ROJA (Suelo de Conservaci√≥n)</strong>
                            <span>¬°CUIDADO! Es delito vender o construir aqu√≠. <b>Es un fraude.</b></span>
                        </div>
                    </div>

                    <div class="legend-item">
                        <span class="color-box verde-fill"></span>
                        <div>
                            <strong>ZONA VERDE (√Årea Protegida)</strong>
                            <span>Bosques y barrancas federales. Propiedad de la Naci√≥n.</span>
                        </div>
                    </div>
                </div>

            </div>
            <!-- Bot√≥n para cerrar panel en m√≥vil -->
            <div class="mobile-toggle" id="mobile-toggle">Ver Mapa Completo ‚¨á</div>
        </div>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>
        // 1. INICIAR MAPA
        // Centrado en zona de conservaci√≥n (Sur CDMX)
        var map = L.map('map', { zoomControl: false }).setView([19.25, -99.15], 11);
        
        // Controles de zoom abajo a la derecha para no estorbar
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        // 2. CAPAS BASE
        var mapaGris = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap, ¬© CARTO' });
        var mapaSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
        var mapaCalles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' });

        // Por defecto Sat√©lite (para que vean si hay bosque)
        map.addLayer(mapaGris);

        var baseMaps = { "Mapa Claro": mapaGris, "Ver Bosque (Sat√©lite)": mapaSatelite, "Ver Calles": mapaCalles };
        L.control.layers(baseMaps, null, { position: 'topright', collapsed: false }).addTo(map);

        // 3. CAPAS DE RIESGO (SIMULACI√ìN)
        var zonaProhibida = L.polygon([
            [19.29, -99.18], [19.30, -99.05], [19.20, -99.08], [19.20, -99.20]
        ], { color: '#9d2148', fillColor: '#9d2148', fillOpacity: 0.5, weight: 2 }).addTo(map);

        zonaProhibida.bindPopup('<div style="text-align:center"><h3 style="color:#9d2148">üö´ ZONA PROHIBIDA</h3><p>Suelo de Conservaci√≥n.<br>No compres aqu√≠.</p></div>');

        // --- L√ìGICA DE UX ---

        // A. BOT√ìN GPS GRANDE
        const btnGps = document.getElementById('btn-gps-large');
        const statusText = document.getElementById('gps-status');

        btnGps.addEventListener('click', function() {
            statusText.innerHTML = "üì° Localizando tu celular... espera un momento.";
            statusText.style.color = "#b28e5c"; // Dorado
            
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
        });

        map.on('locationfound', function(e) {
            statusText.innerHTML = "‚úÖ Ubicaci√≥n encontrada. Mira el mapa.";
            statusText.style.color = "green";
            
            // Marcador pulsante
            L.circleMarker(e.latlng, {
                radius: 8, fillColor: "#007bff", color: "#fff", weight: 2, fillOpacity: 1
            }).addTo(map).bindPopup("Est√°s aqu√≠").openPopup();
            
            L.circle(e.latlng, e.accuracy).addTo(map);

            // En m√≥vil, colapsar el panel para que vean el mapa
            if(window.innerWidth < 600) {
                document.querySelector('.info-card').classList.add('collapsed');
                document.getElementById('mobile-toggle').innerHTML = "Abrir Men√∫ ‚¨Ü";
            }
        });

        map.on('locationerror', function(e) {
            statusText.innerHTML = "‚ùå Error: Activa el GPS de tu celular y vuelve a intentar.";
            statusText.style.color = "red";
        });

        // B. BUSCADOR MANUAL (INTEGRADO EN LA TARJETA)
        const inputSearch = document.getElementById('manual-search-input');
        const btnSearch = document.getElementById('btn-manual-search');

        // Funci√≥n de b√∫squeda personalizada
        function realizarBusqueda() {
            var query = inputSearch.value;
            if (!query) return;

            // 1. ¬øEs coordenada? (Detectar formato "numero, numero")
            if (query.includes(',')) {
                var coords = query.split(',');
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.setView([lat, lng], 16);
                    L.marker([lat, lng]).addTo(map).bindPopup("Coordenada Buscada").openPopup();
                    return;
                }
            }

            // 2. Si es texto, usar Geocoder
            // Usamos la API de Nominatim manualmente
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}+CDMX`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        var resultado = data[0];
                        var lat = resultado.lat;
                        var lon = resultado.lon;
                        
                        map.setView([lat, lon], 16);
                        L.marker([lat, lon]).addTo(map)
                            .bindPopup(`<b>${resultado.display_name}</b>`).openPopup();
                        
                        // Ocultar teclado en m√≥vil
                        inputSearch.blur();
                        // Colapsar panel en m√≥vil
                        if(window.innerWidth < 600) {
                            document.querySelector('.info-card').classList.add('collapsed');
                            document.getElementById('mobile-toggle').innerHTML = "Abrir Men√∫ ‚¨Ü";
                        }
                    } else {
                        alert("No encontramos esa direcci√≥n. Intenta poner solo la Colonia y Alcald√≠a.");
                    }
                })
                .catch(err => {
                    alert("Error de conexi√≥n.");
                });
        }

        btnSearch.addEventListener('click', realizarBusqueda);
        inputSearch.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') realizarBusqueda();
        });

        // C. COLAPSAR PANEL EN M√ìVIL
        document.getElementById('mobile-toggle').addEventListener('click', function() {
            document.querySelector('.info-card').classList.toggle('collapsed');
            if (document.querySelector('.info-card').classList.contains('collapsed')) {
                this.innerHTML = "Abrir Buscador ‚¨Ü";
            } else {
                this.innerHTML = "Ver Mapa Completo ‚¨á";
            }
        });

    </script>
</body>
</html>
